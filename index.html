<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello di Controllo Spese Legali e Mediazione</title>
    <!-- Caricamento di Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Definizione del Font Inter e stili unificati -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Century+Schoolbook&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* NUOVI STILI PER SFONDO GRADIENTE E TEXTURE SVG */
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); /* bg-gray-100 to bg-gray-200 */
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239ca3af' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 0h3v3H0V0zm3 3h3v3H3V3z'/%3E%3C/g%3E%3C/svg%3E");
        }
        .header-font {
            font-family: 'Century+Schoolbook', 'Georgia', serif;
        }
        /* Stile per nascondere le frecce sugli input di tipo number (App Blu) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Stili per il toggle (Oneri Fiscali - App Blu) */
        .toggle-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            cursor: pointer;
            user-select: none;
            gap: 0.25rem;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
        }

        .toggle-track {
            width: 2.5rem; 
            height: 1.1rem; 
            background-color: #ccc;
            border-radius: 9999px;
            position: relative;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .toggle-thumb {
            width: 0.9rem; 
            height: 0.9rem; 
            background-color: white;
            border-radius: 9999px;
            position: absolute;
            top: 0.1rem; 
            left: 0.1rem;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* Stato Checked per Toggle (Oneri Fiscali) - TEMA BLU */
        #cost-forfeit:checked + .toggle-track, 
        #cost-cassa:checked + .toggle-track, 
        #cost-iva:checked + .toggle-track,
        #cost-increase:checked + .toggle-track { /* AGGIUNTO IL NUOVO ID */
            background-color: #3b82f6; /* blue-500 */
        }

        #cost-forfeit:checked + .toggle-track .toggle-thumb, 
        #cost-cassa:checked + .toggle-track .toggle-thumb, 
        #cost-iva:checked + .toggle-track .toggle-thumb,
        #cost-increase:checked + .toggle-track .toggle-thumb { /* AGGIUNTO IL NUOVO ID */
            transform: translateX(1.4rem); 
        }

        /* Stile per la colonna di calcolo per l'input - TEMA BLU */
        #forensic-calculator .input-group-style {
            background-color: #eff6ff; /* blue-50 */
            border-color: #93c5fd; /* blue-300 */
        }

        /* Stili per il riquadro selezionabile (App Blu) */
        .fee-display-item {
            cursor: pointer; 
            padding: 0.4rem 0.2rem; 
            border-radius: 0.5rem; 
            transition: all 0.2s ease-in-out;
            border: 1px solid #e5e7eb; 
            background-color: #f9fafb; 
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }
        
        .fee-display-item:hover {
            border-color: #bfdbfe; 
            background-color: #eff6ff; 
        }

        .highlighted-fee {
            background-color: #93c5fd; 
            border-color: #1e40af; 
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); 
        }
        .highlighted-fee .fee-value {
            color: #1e40af; 
            font-weight: 800; 
            font-size: 1.25rem; 
        }
        .highlighted-fee span:first-child {
             color: #1e40af; 
        }
        
        .fee-display-item span:first-child {
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #4b5563; 
        }
        .fee-display-item .fee-value {
            font-size: 1.125rem; 
            font-weight: 700;
            color: #1f2937; 
        }

        .single-phase-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .phase-content-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr)); 
            gap: 0.5rem;
            align-items: center;
        }

        /* Stili per layout generale */
        #main-container {
            /* Flex layout per desktop, column per mobile */
            display: flex;
            flex-direction: column; 
            gap: 2rem;
            min-height: 100vh;
            padding: 1rem;
            max-width: 100%; /* Ensure it doesn't overflow */
        }

        .app-panel {
            /* Base styling for each panel */
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: white;
            flex-shrink: 0; /* Important for flex layout */
        }

        /* NEW: Header Container full width */
        #full-width-header {
            width: 100%;
            padding: 1rem;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            /* Modifiche per aggiungere il bordo superiore e usare il colore blu dell'app forense */
            border-top: 4px solid #1d4ed8; /* blue-custom-700 */
            border-bottom: 4px solid #1d4ed8; /* blue-custom-700 */
        }
        
        /* NEW: Container for the two side-by-side apps */
        #apps-container {
            display: flex;
            flex-direction: column; 
            gap: 2rem;
            width: 100%;
        }

        /* MODIFICA: Stile per il Footer (full width) */
        #full-width-footer {
            width: 100%;
            padding-left: 1rem; 
            padding-right: 1rem; 
        }

        /* Stile aggiuntivo per giustificare il testo nel footer */
        .text-justify {
            text-align: justify;
            text-justify: inter-word;
        }

        /* === NUOVE REGOLE BLINK PER VALORI MEDI === */
        @keyframes blink-red {
            0%, 100% { color: #dc2626; opacity: 1; } /* red-600 */
            50% { color: #b91c1c; opacity: 0.6; } /* red-700, leggermente pi√π scuro e trasparente */
        }

        .blink-animation {
            animation: blink-red 1s step-end infinite;
        }
        /* ======================================= */

        /* Nuove regole per la stampa */
        @media print {
            /* CSS per la stampa del contenuto dell'iframe dinamico */
            .print-container {
                font-family: 'Inter', sans-serif;
                color: #000;
                padding: 1rem;
                /* Nascondi gli elementi interattivi all'interno della sezione stampata */
                .print-hide {
                    display: none !important;
                }
                /* Assicura che i riquadri colorati siano ben visibili */
                .bg-indigo-600 { background-color: #4f46e5 !important; -webkit-print-color-adjust: exact; }
                .bg-blue-custom-700 { background-color: #1d4ed8 !important; -webkit-print-color-adjust: exact; }
                .text-white { color: #fff !important; }
                .text-yellow-300 { color: #fcd34d !important; }

                /* Fornisce contesto: Valore Lite */
                .print-litigation-value {
                    font-size: 1rem;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                }
            }
        }


        @media (min-width: 1024px) { 
            #main-container {
                /* Changed to column to stack header above apps-container */
                flex-direction: column; 
                padding: 2rem;
            }
            #apps-container {
                /* This is the new flex container for the side-by-side layout */
                flex-direction: row; 
            }
            .app-panel {
                width: 50%; /* Equal width on desktop */
                max-width: none; 
            }
        }
        
        /* Stile per il Modal di personalizzazione (AGGIUNTO) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        /* Stili di Modulazione Indeterminato (simulano i toggle) */
        /* Inseriti qui in style globale */
        #ind-alto:checked + .toggle-track, 
        #ind-medio:checked + .toggle-track, 
        #ind-basso:checked + .toggle-track {
            background-color: #4f46e5; /* indigo-600 */
        }

        #ind-alto:checked + .toggle-track .toggle-thumb,
        #ind-medio:checked + .toggle-track .toggle-thumb,
        #ind-basso:checked + .toggle-track .toggle-thumb {
            transform: translateX(1.4rem); 
        }
    </style>
    <script>
        // Configurazione Tailwind estesa per i colori dell'App Blu
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blue-custom': {
                            50: '#eff6ff',
                            300: '#93c5fd',
                            500: '#3b82f6',
                            700: '#1d4ed8',
                            800: '#1e40af',
                        },
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">

    <div id="main-container">
        
        <!-- NUOVA SEZIONE: Intestazione a Tutta Larghezza -->
        <div id="full-width-header" class="text-center">
            <div class="flex flex-col items-center justify-center mb-4 border-b border-gray-200 pb-4">
                <div class="flex flex-wrap items-center justify-center gap-6 mb-3">
                    <!-- Logo -->
                    <img
                        src="https://logoccf.carrd.co/assets/images/image01.jpg?v=33becf42"
                        alt="Logo Camera di Media-Conciliazione Forense"
                        class="h-16 sm:h-20 w-auto object-contain rounded-lg shadow-md"
                        onerror="this.onerror=null; this.src='https://placehold.co/150x80/284992/ffffff?text=Logo+Non+Trovato';"
                    />
                </div>
                <div class="header-font">
                    <!-- DIMENSIONE AUMENTATA: da text-xl sm:text-2xl a text-2xl sm:text-3xl -->
                    <!-- MODIFICA QUI: Avvolgiamo il titolo in un tag <a> -->
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 leading-tight">
                        <a href="https://www.conciliazioneforense.it/" target="_blank" class="text-gray-900 hover:text-blue-custom-700 hover:underline transition duration-150 ease-in-out">
                            COORDINAMENTO DELLA CONCILIAZIONE FORENSE
                        </a>
                    </h1>
                    <p class="text-xs sm:text-sm text-gray-600 mt-1 max-w-full mx-auto">
                        Sede legale presso la Fondazione Forense di Milano, in Via Freguglia n. 1, 20122 Milano. Tel.025492921. Email: <a href="mailto:info@conciliazioneforense.it" class="text-indigo-600 hover:underline">info@conciliazioneforense.it</a> | PEC: <a href="mailto:conciliazioneforense@legalmail.it" class="text-indigo-600 hover:underline">conciliazioneforense@legalmail.it</a>
                    </p>
                    <!-- NUOVA RIGA AGGIUNTA QUI -->
                    <p class="text-xs sm:text-sm text-gray-600 max-w-full mx-auto mt-1">
                        <a href="https://www.conciliazioneforense.it/ordini-e-organismi-associati" target="_blank" class="text-indigo-600 hover:underline font-semibold">
                            ORDINI E ORGANISMI ASSOCIATI
                        </a>
                    </p>
                </div>
            </div>
        </div>
        <!-- FINE NUOVA SEZIONE INTESTAZIONE -->

        <!-- NUOVA CASELLA CALCOLATORE INTEGRATO (STRISCIE BLU) -->
        <div id="integrated-calculator-header" class="w-full text-center p-1 bg-white border-t-4 border-blue-custom-700 border-b-4 shadow-md">
            <!-- MODIFICA QUI: Sostituito text-blue-custom-700 con text-gray-900 per il testo nero -->
            <h2 class="text-base sm:text-xl font-extrabold text-gray-900 leading-snug">
                CALCOLATORE INTEGRATO SPESE - INDENNITA' DI MEDIAZIONE E COMPENSI AVVOCATO
            </h2>
        </div>
        <!-- FINE NUOVA CASELLA -->


        <!-- CONTENITORE PRINCIPALE DELLE APP AFFIANCATE -->
        <div id="apps-container" class="lg:flex">
            
            <!-- PARTE SINISTRA: Spese di Mediazione (spese test2.html) - TEMA VIOLA -->
            <div id="mediation-app" class="app-panel border-t-8 border-indigo-600">
                
                <h2 class="text-2xl font-extrabold text-gray-800 text-center mb-6 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 h-6 w-6 text-gray-400"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg> Calcolatore Spese di Mediazione
                </h2>

                <!-- Contenitore Calcolatore Mediazione -->
                <div class="flex flex-col gap-6">
                    
                    <div id="mediation-calculator" class="space-y-4">
                        <h2 id="tariff-title" class="text-xl sm:text-2xl font-extrabold text-indigo-700 text-center flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 text-indigo-600"><path d="M12 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h7"/><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg> Spese di Mediazione - Valori Minimi
                        </h2>
                        <!-- MODIFICA: Inserito D.LGS. 28/2010 e DM 150/2023 in un unico blocco centrato -->
                        <p class="text-sm text-gray-500 text-center -mt-2 space-x-4">
                            <!-- D.LGS. 28/2010 -->
                            <a 
                                href="https://www.ordineavvocati.ss.it/docs/mediazione_Dlgs28-2010_consolidato_col_Dlgs_216-2024_579486312.pdf" 
                                target="_blank" 
                                class="text-indigo-600 hover:underline font-semibold"
                            >
                                D.LGS. 28/2010
                            </a>
                            <!-- DM 150/2023 -->
                            <a 
                                href="https://www.ordineavvocati.ss.it/docs/mediazione_DM_150_2023_Gazzetta-Ufficiale-69854763215.pdf" 
                                target="_blank" 
                                class="text-indigo-600 hover:underline font-semibold"
                            >
                                DM 150/2023
                            </a>
                        </p>

                        <!-- Gruppo Input Mediazione -->
                        <div class="space-y-3 p-3 bg-indigo-50 rounded-lg shadow-inner print-hide">
                            <div>
                                <label for="mediation-tariff-level" class="block text-gray-700 font-bold mb-1 text-sm">Livello Tariffario:</label>
                                <select
                                    id="mediation-tariff-level"
                                    onchange="calculateMediationFees()"
                                    class="w-full p-2 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out font-medium bg-white"
                                >
                                    <option value="minimi">Valori Minimi</option>
                                    <option value="medi">Valori Medi</option>
                                </select>
                            </div>
                            <div>
                                <label for="mediation-type" class="block text-gray-700 font-bold mb-1 text-sm">Tipo di Mediazione:</label>
                                <select
                                    id="mediation-type"
                                    onchange="calculateMediationFees()"
                                    class="w-full p-2 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out font-medium bg-white"
                                >
                                    <option value="obbligatorie">Mediazioni obbligatorie o demandate (80% tariffa)</option>
                                    <option value="volontarie">Mediazioni volontarie (100% tariffa)</option>
                                </select>
                            </div>
                            <!-- NUOVO SELECT PER TIPO VALORE LITE -->
                            <div>
                                <label for="litigation-value-type" class="block text-gray-700 font-bold mb-1 text-sm">Tipo Valore Lite:</label>
                                <select
                                    id="litigation-value-type"
                                    onchange="updateValueInputType(); calculateMediationFees();"
                                    class="w-full p-2 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out font-medium bg-white"
                                >
                                    <option value="determinabile">Determinabile (‚Ç¨)</option>
                                    <option value="indeterminabile">Indeterminabile</option>
                                </select>
                            </div>
                            <div>
                                <label for="mediation-litigation-value" class="block text-sm font-bold text-gray-700 mb-1">Valore della Lite (‚Ç¨):</label>
                                <input
                                    id="mediation-litigation-value"
                                    type="text"
                                    oninput="calculateMediationFees()"
                                    class="w-full p-2 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-base font-semibold"
                                    placeholder="es. 15000"
                                />
                            </div>
                        </div>
                        
                        <!-- NUOVA CASELLA PER VALORE INDETERMINATO (TEMA VIOLA) -->
                        <!-- Aggiunto "hidden" di default e rimosso "mt-4" per unire gli spazi -->
                        <div id="indeterminate-value-options" class="p-3 bg-indigo-50 rounded-lg shadow-inner border border-indigo-200 print-hide hidden">
                            <h3 class="text-sm font-bold text-indigo-700 mb-3 border-b border-indigo-300 pb-1 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-indigo-600"><path d="M10.45 6.03a6.68 6.68 0 0 1 3.1 0"/><path d="M12 20V4"/><path d="M3 18c0-5 2-8 7-8"/><path d="M14 10c5 0 7 3 7 8"/></svg> Modulazione Valore Indeterminato
                            </h3>
                            
                            <div class="flex flex-wrap justify-between items-center gap-x-3 gap-y-1 text-xs sm:text-sm">
                                
                                <!-- Alto -->
                                <div class="toggle-container">
                                    <span class="text-gray-800 font-medium"> Alto</span>
                                    <input type="radio" id="ind-alto" name="indeterminato-level" value="alto" onchange="calculateMediationFees()" class="hidden">
                                    <label for="ind-alto" class="toggle-track toggle-switch">
                                        <div class="toggle-thumb" style="transition: transform 0.2s, background-color 0.2s;"></div>
                                    </label>
                                </div>
                                <!-- Medio (Default/Baseline) -->
                                <div class="toggle-container">
                                    <span class="text-gray-800 font-medium">Medio</span>
                                    <input type="radio" id="ind-medio" name="indeterminato-level" value="medio" checked onchange="calculateMediationFees()" class="hidden">
                                    <label for="ind-medio" class="toggle-track toggle-switch">
                                        <div class="toggle-thumb" style="transition: transform 0.2s, background-color 0.2s;"></div>
                                    </label>
                                </div>

                                <!-- Basso -->
                                <div class="toggle-container">
                                    <span class="text-gray-800 font-medium">Basso</span>
                                    <input type="radio" id="ind-basso" name="indeterminato-level" value="basso" onchange="calculateMediationFees()" class="hidden">
                                    <label for="ind-basso" class="toggle-track toggle-switch">
                                        <div class="toggle-thumb" style="transition: transform 0.2s, background-color 0.2s;"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alert Mediazione -->
                        <div id="mediation-alert" class="hidden bg-yellow-100 p-3 rounded-lg border-l-4 border-yellow-500 text-yellow-800 text-sm font-medium"></div>

                        <!-- VALORE LITE PER LA STAMPA (AGGIUNTO) -->
                        <div class="print-only text-base mb-4" id="mediation-print-value"></div>
                        
                        <!-- Griglia Risultati Mediazione -->
                        <div class="grid grid-cols-2 gap-3">
                            <!-- 1. Spese di Avvio -->
                            <div class="bg-white p-3 rounded-lg shadow-md border border-green-300">
                                <h3 class="text-sm font-semibold text-green-700 mb-1">Spese Fisse:</h3>
                                <p id="fees-startup" class="text-xl font-extrabold text-green-800">0,00 ‚Ç¨</p>
                                
                                <!-- NUOVA CASELLA BREAKDOWN con Dettaglio IVA -->
                                <div class="mt-2 pt-2 border-t border-gray-200 bg-gray-50 p-2 rounded-md text-xs space-y-2">
                                    <!-- Dettaglio Spese Avvio -->
                                    <div>
                                        <div class="flex justify-between items-center font-bold">
                                            <span class="text-gray-700">Spese Avvio:</span>
                                            <span id="fees-startup-breakdown-avvio" class="text-gray-900">0,00 ‚Ç¨</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>Imponibile:</span>
                                            <span id="fees-startup-breakdown-avvio-imponibile">0,00 ‚Ç¨</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>IVA 22%:</span>
                                            <span id="fees-startup-breakdown-avvio-iva">0,00 ‚Ç¨</span>
                                        </div>
                                    </div>
                                    <!-- Dettaglio Indennit√† 1¬∞ Incontro -->
                                    <div class="pt-2 border-t border-gray-200">
                                        <div class="flex justify-between items-center font-bold">
                                            <span class="text-gray-700">Indennit√† 1¬∞ Incontro:</span>
                                            <span id="fees-startup-breakdown-indennita" class="text-gray-900">0,00 ‚Ç¨</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>Imponibile:</span>
                                            <span id="fees-startup-breakdown-indennita-imponibile">0,00 ‚Ç¨</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>IVA 22%:</span>
                                            <span id="fees-startup-breakdown-indennita-iva">0,00 ‚Ç¨</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-sm text-gray-600 mt-2 space-y-0.5">
                                    <p>Imponibile: <span id="fees-startup-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <p>IVA 22%: <span id="fees-startup-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Dovute al deposito della domanda e dell'adesione)</p>
                                </div>
                            </div>

                            <!-- 2. Esito Negativo dopo 1¬∞ incontro -->
                            <div class="bg-white p-3 rounded-lg shadow-md border border-purple-300">
                                <h3 class="text-sm font-semibold text-purple-700 mb-1">Spese per esito negativo dopo 1¬∞ incontro:</h3>
                                <p id="fees-negative" class="text-xl font-extrabold text-purple-800">0,00 ‚Ç¨</p>
                                <div class="text-sm text-gray-600 mt-1 space-y-0.5">
                                    <p>Imponibile: <span id="fees-negative-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <p>IVA 22%: <span id="fees-negative-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <!-- Nuova riga aggiunta qui sotto l'IVA 22% -->
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Dovute dopo il 1¬∞ incontro non conclusivo)</p> 
                                </div>
                            </div>
                            
                            <!-- 3. Esito Positivo al 1¬∞ -->
                            <div class="bg-white p-3 rounded-lg shadow-md border border-amber-300">
                                <h3 class="text-sm font-semibold text-amber-700 mb-1">Spese per esito positivo 1¬∞ incontro:</h3>
                                <p id="fees-positive-1" class="text-xl font-extrabold text-amber-800">0,00 ‚Ç¨</p>
                                <div class="text-sm text-gray-600 mt-1 space-y-0.5">
                                    <p>Imponibile: <span id="fees-positive-1-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <p>IVA 22%: <span id="fees-positive-1-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <!-- AGGIUNTA NUOVA RIGA QUI -->
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Conciliazione al primo incontro)</p>
                                </div>
                            </div>

                            <!-- 4. Esito Positivo dopo il 1¬∞ -->
                            <div class="bg-white p-3 rounded-lg shadow-md border border-red-300">
                                <h3 class="text-sm font-semibold text-red-700 mb-1">Spese per esito positivo dopo 1¬∞ incontro:</h3>
                                <p id="fees-positive-after-1" class="text-xl font-extrabold text-red-800">0,00 ‚Ç¨</p>
                                <div class="text-sm text-gray-600 mt-1 space-y-0.5">
                                    <p>Imponibile: <span id="fees-positive-after-1-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <p>IVA 22%: <span id="fees-positive-after-1-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    <!-- AGGIUNTA NUOVA RIGA QUI -->
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Conciliazione dopo il primo incontro)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Riepilogo Totale Mediazione -->
                        <div class="bg-indigo-600 text-white p-4 rounded-xl shadow-xl mt-4">
                            <h3 class="text-sm font-bold text-center mb-3 border-b border-indigo-400 pb-2">
                                Costo Totale Mediazione (Avvio + Spese)
                            </h3>
                            <!-- Modifica qui: da grid-cols-3 a grid-cols-4 -->
                            <div class="grid grid-cols-4 gap-2 text-center text-sm"> 
                                <!-- NUOVA CASELLA: Negativo 1¬∞ incontro (Solo Spese di Avvio) -->
                                <div>
                                    <p class="text-xs font-light opacity-90">Negativo 1¬∞ incontro</p>
                                    <p id="total-startup" class="text-xl font-extrabold">0,00 ‚Ç¨</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-startup-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                        <p>IVA 22%: <span id="total-startup-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    </div>
                                </div>

                                <!-- Vecchia Negativo dopo 1¬∞ incontro (ora √® la 2a colonna) -->
                                <div class="border-x border-indigo-400 pr-2">
                                    <p class="text-xs font-light opacity-90">Negativo dopo 1¬∞ incontro</p>
                                    <p id="total-negative" class="text-xl font-extrabold">0,00 ‚Ç¨</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-negative-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                        <p>IVA 22%: <span id="total-negative-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    </div>
                                </div>
                                
                                <!-- Vecchia Positivo al 1¬∞ incontro (ora √® la 3a colonna) -->
                                <div>
                                    <p class="text-xs font-light opacity-90">Positivo al 1¬∞ incontro</p>
                                    <p id="total-positive-1" class="text-xl font-extrabold">0,00 ‚Ç¨</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-positive-1-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                        <p>IVA 22%: <span id="total-positive-1-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    </div>
                                </div>
                                
                                <!-- Vecchia Positivo dopo 1¬∞ incontro (ora √® la 4a colonna) -->
                                <div class="border-l border-indigo-400 pl-2">
                                    <p class="text-xs font-light opacity-90">Positivo dopo 1¬∞ incontro</p>
                                    <p id="total-positive-after-1" class="text-xl font-extrabold">0,00 ‚Ç¨</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-positive-after-1-imponibile" class="font-medium">0,00 ‚Ç¨</span></p>
                                        <p>IVA 22%: <span id="total-positive-after-1-iva" class="font-medium">0,00 ‚Ç¨</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NUOVO CONTENITORE PULSANTI DI STAMPA MEDIAZIONE (Modificato) -->
                    <div class="print-button-container flex flex-col sm:flex-row justify-center items-center gap-3 mt-4">
                         <!-- Tasto Stampa Standard -->
                         <button 
                            onclick="printSection('mediation-app')" 
                            class="flex items-center justify-center bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 text-sm"
                         >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> 
                            Stampa Sezione Mediazione
                        </button>
                        <!-- Tasto Stampa Personalizzata Organismo (NUOVO) -->
                         <button 
                            onclick="openMediationCustomPrintModal()" 
                            class="flex items-center justify-center bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 text-sm"
                         >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5"/><path d="M18 10a6 6 0 0 0-9.37 0"/></svg>
                            Stampa Personalizzata Organismo
                        </button>
                    </div>

                    <!-- FOOTER RIMOSSO DA QUI e spostato alla fine del #main-container -->
                </div>
            </div>
            
            <!-- PARTE DESTRA: Spese Legali (spese legali blu.html) - TEMA BLU -->
            <div id="forensic-app" class="app-panel border-t-8 border-blue-custom-700">
                <!-- Contenuto dell'app "Spese Legali Blu" -->
                
                <h2 class="text-2xl font-extrabold text-blue-custom-700 text-center mb-6 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-custom-600"><path d="m16 16-3-3m0 0 3-3m-3 3h3"/></svg> Calcolatore Compensi Avvocato
                </h2>
                <p class="text-sm text-gray-500 text-center -mt-2 mb-4">DM 55/2014 - Valori tabellari (Mediazione).</p>

                <!-- Gruppo Input Valore Lite -->
                <div id="forensic-calculator" class="space-y-2 p-3 input-group-style rounded-xl shadow-inner print-hide">
                    <div>
                        <label for="forensic-litigation-value" class="block text-gray-700 font-bold text-base mb-1">Valore della Lite (‚Ç¨):</label>
                        <input
                            id="forensic-litigation-value"
                            type="text"
                            oninput="calculateForensicFees()"
                            class="w-full p-2 border border-blue-custom-300 rounded-lg shadow-sm focus:ring-blue-custom-500 focus:border-blue-custom-500 transition duration-150 ease-in-out text-base font-semibold bg-white"
                            placeholder="es. 15000 o Indeterminabile"
                            value="" 
                        />
                    </div>
                </div>

                <!-- Alert/Risultati Compensi Avvocato -->
                <div id="forensic-alert" class="hidden bg-blue-100 p-3 rounded-lg shadow-md border-l-4 border-blue-custom-500 text-blue-custom-800 font-medium text-sm mt-4">
                    <p class="font-bold">Attenzione:</p>
                    <p id="alert-message">Valore lite non rientrante Nelle fasce calcolabili.</p>
                </div>

                <!-- VALORE LITE PER LA STAMPA (AGGIUNTO) -->
                <div class="print-only text-base mb-4" id="forensic-print-value"></div>

                <!-- Risultati per Fase (Select by clicking value) -->
                <div id="forensic-results" class="grid grid-cols-1 gap-3 mt-4">
                    
                    <h3 class="text-base font-extrabold text-blue-custom-700 border-b border-blue-custom-300 pb-1 mt-2">Compensi per Fase (Seleziona il Valore)</h3>

                    <!-- FASE 1: Fase di attivazione (MODIFICATA) -->
                    <div id="phase-activation-box" class="phase-box bg-white p-3 rounded-xl shadow-md border border-blue-custom-300 single-phase-row">
                        <h3 class="text-sm font-bold text-blue-custom-700">Fase di attivazione</h3>
                        <div class="phase-content-grid">
                            <div id="act-display-min" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('activation', 'min')">
                                <span class="font-medium">Minimo</span>
                                <span class="fee-value font-black" data-value-type="min">0,00 ‚Ç¨</span>
                            </div>
                            <div id="act-display-medium" class="fee-display-item flex flex-col justify-center items-center highlighted-fee" onclick="selectForensicFee('activation', 'medium')">
                                <span class="font-medium">Medio</span>
                                <span class="fee-value font-black" data-value-type="medium">0,00 ‚Ç¨</span>
                            </div>
                            <div id="act-display-max" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('activation', 'max')">
                                <span class="font-medium">Massimo</span>
                                <span class="fee-value font-black" data-value-type="max">0,00 ‚Ç¨</span>
                            </div>
                            <div class="hidden phase-radio-group print-hide">
                                <input type="radio" id="act-min" name="activation-level" value="min" class="hidden" />
                                <input type="radio" id="act-med" name="activation-level" value="medium" checked class="hidden" />
                                <input type="radio" id="act-max" name="activation-level" value="max" class="hidden" />
                            </div>
                        </div>
                    </div>

                    <!-- FASE 2: Fase negoziazione (MODIFICATA) -->
                    <div id="phase-negotiation-box" class="phase-box bg-white p-3 rounded-xl shadow-md border border-blue-custom-300 single-phase-row">
                        <h3 class="text-sm font-bold text-blue-custom-700">Fase negoziazione</h3>
                        <div class="phase-content-grid">
                            <div id="neg-display-min" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('negotiation', 'min')">
                                <span class="font-medium">Minimo</span>
                                <span class="fee-value font-black" data-value-type="min">0,00 ‚Ç¨</span>
                            </div>
                            <div id="neg-display-medium" class="fee-display-item flex flex-col justify-center items-center highlighted-fee" onclick="selectForensicFee('negotiation', 'medium')">
                                <span class="font-medium">Medio</span>
                                <span class="fee-value font-black" data-value-type="medium">0,00 ‚Ç¨</span>
                            </div>
                            <div id="neg-display-max" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('negotiation', 'max')">
                                <span class="font-medium">Massimo</span>
                                <span class="fee-value font-black" data-value-type="max">0,00 ‚Ç¨</span>
                            </div>
                            <div class="hidden phase-radio-group print-hide">
                                <input type="radio" id="neg-min" name="negotiation-level" value="min" class="hidden" />
                                <input type="radio" id="neg-med" name="negotiation-level" value="medium" checked class="hidden" />
                                <input type="radio" id="neg-max" name="negotiation-level" value="max" class="hidden" />
                            </div>
                        </div>
                    </div>

                    <!-- FASE 3: Conciliazione (Non modificata) -->
                    <div id="phase-conciliation-box" class="phase-box bg-white p-3 rounded-xl shadow-md border border-blue-custom-300 single-phase-row">
                        <h3 class="text-sm font-bold text-blue-custom-700">Fase Conciliazione</h3>
                        <div class="phase-content-grid">
                            <div id="con-display-min" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('conciliation', 'min')">
                                <span class="font-medium">Minimo</span>
                                <span class="fee-value font-black" data-value-type="min">0,00 ‚Ç¨</span>
                            </div>
                            <div id="con-display-medium" class="fee-display-item flex flex-col justify-center items-center highlighted-fee" onclick="selectForensicFee('conciliation', 'medium')">
                                <span class="font-medium">Medio</span>
                                <span class="fee-value font-black" data-value-type="medium">0,00 ‚Ç¨</span>
                            </div>
                            <div id="con-display-max" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('conciliation', 'max')">
                                <span class="font-medium">Massimo</span>
                                <span class="fee-value font-black" data-value-type="max">0,00 ‚Ç¨</span>
                            </div>
                            <div class="hidden phase-radio-group print-hide">
                                <input type="radio" id="con-min" name="conciliation-level" value="min" class="hidden" />
                                <input type="radio" id="con-med" name="conciliation-level" value="medium" checked class="hidden" />
                                <input type="radio" id="con-max" name="conciliation-level" value="max" class="hidden" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opzioni Calcolo (Maggiorazioni/Oneri Fiscali/Previdenziali) (MODIFICATA) -->
                    <div class="p-3 bg-white rounded-xl shadow-md border border-gray-200 mt-2 print-hide">
                        <h3 class="text-sm font-bold text-blue-custom-700 mb-3 border-b border-blue-custom-300 pb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-custom-600"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Maggiorazioni/Oneri Fiscali/Previdenziali
                        </h3>
                        
                        <div class="flex flex-wrap justify-between items-center gap-x-3 gap-y-1 text-xs sm:text-sm">
                            
                            <!-- NUOVO MAGGIORAZIONE 30% (SPOSTATO PRIMA) -->
                            <div class="toggle-container w-full sm:w-auto justify-between sm:justify-start">
                                <span class="text-gray-800 font-bold">Aumento 30% esito positivo</span>
                                <input type="checkbox" id="cost-increase" onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-increase" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>
                            
                            <!-- Spese Forfettarie (Testo ridotto: Spese forf. 15%) -->
                            <div class="toggle-container">
                                <span class="text-gray-800 font-medium"> Spese forf. 15%</span>
                                <input type="checkbox" id="cost-forfeit" checked onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-forfeit" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>

                            <!-- Contributo Cassa (Testo ridotto: Cassa 4%) -->
                            <div class="toggle-container">
                                <span class="text-gray-800 font-medium">Cassa 4%</span>
                                <input type="checkbox" id="cost-cassa" checked onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-cassa" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>

                            <!-- IVA (Testo ridotto: IVA 22%) -->
                            <div class="toggle-container">
                                <span class="text-gray-800 font-medium">IVA 22%</span>
                                <input type="checkbox" id="cost-iva" checked onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-iva" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Riepilogo Totale Avvocato -->
                    <div class="bg-blue-custom-700 text-white p-4 rounded-xl shadow-xl mt-4">
                        <h3 class="text-sm font-bold text-center mb-3">Totale Complessivo Cliente (Basato sulle tue Selezioni)</h3>
                        
                        <div class="space-y-2 text-sm"> 
                            <!-- Compenso Base Totale -->
                            <div class="flex justify-between items-center border-b border-blue-custom-600 pb-1">
                                <span class="font-light opacity-90">A. Comp. Base (Totale Fasi):</span>
                                <span id="forensic-total-base-fee" class="font-extrabold text-white text-base">0,00 ‚Ç¨</span>
                            </div>

                            <!-- Nuova riga per Maggiorazione 30% -->
                            <div id="forensic-total-increase-row" class="flex justify-between items-center text-red-300 font-semibold hidden">
                                <span class="font-light opacity-90">B. Maggiorazione esito positivo (30%):</span>
                                <span id="forensic-total-increase" class="font-semibold text-base">0,00 ‚Ç¨</span>
                            </div>
                            
                            <!-- Spese Forfettarie -->
                            <div class="flex justify-between items-center">
                                <!-- Etichetta aggiornata per indicare la base di calcolo corretta: (A + B) -->
                                <span class="font-light opacity-90">C. Spese Forfettarie (15% su A+B):</span>
                                <span id="forensic-total-forfeit" class="font-semibold text-white text-base">0,00 ‚Ç¨</span>
                            </div>
                            
                            <!-- Contributo Cassa -->
                            <div class="flex justify-between items-center">
                                <!-- Etichetta aggiornata per indicare la base di calcolo corretta: (A + B + C) -->
                                <span class="font-light opacity-90">D. Contributo Cassa (4% su A+B+C):</span>
                                <span id="forensic-total-cassa" class="font-semibold text-white text-base">0,00 ‚Ç¨</span>
                            </div>
                            
                            <!-- Imponibile IVA -->
                            <!-- Etichetta aggiornata: da E a E per seguire A, B, C, D e D. Imponibile IVA (A + B + C + D) -->
                            <div class="flex justify-between items-center pt-2 border-t border-blue-custom-600">
                                <span class="font-light opacity-90 text-sm" id="forensic-taxable-label">E. Imponibile IVA (A + B + C + D):</span>
                                <span id="forensic-total-taxable-base" class="font-extrabold text-lg text-yellow-300">0,00 ‚Ç¨</span>
                            </div>

                            <!-- IVA -->
                            <div class="flex justify-between items-center">
                                <span class="font-light opacity-90 text-sm">F. IVA (22% su E):</span>
                                <span id="forensic-total-iva" class="font-semibold text-white text-base">0,00 ‚Ç¨</span>
                            </div>

                            <!-- TOTALE FINALE -->
                            <div class="flex justify-between items-center pt-3 border-t-2 border-blue-custom-500">
                                <p class="text-lg font-black">TOTALE CLIENTE:</p>
                                <p id="forensic-total-final-cost" class="text-2xl font-black text-yellow-300">
                                    0,00 ‚Ç¨
                                </p>
                            </div>

                        </div>
                    </div>
                </div>
                
                <!-- NUOVO CONTENITORE PULSANTI DI STAMPA AVVOCATO (Modificato) -->
                <div class="print-button-container flex flex-col justify-center items-center gap-3 mt-4">
                    
                    <!-- Contenitore Flex per i due pulsanti originali (affiancati su desktop) -->
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-3 w-full">
                        <!-- Tasto Stampa Standard -->
                        <button 
                            onclick="printSection('forensic-app')" 
                            class="flex items-center justify-center w-full sm:w-1/2 bg-blue-custom-500 hover:bg-blue-custom-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-custom-300 text-sm"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> 
                            Stampa Sezione Avvocato
                        </button>
                        <!-- Tasto Stampa Personalizzata (NUOVO) -->
                        <button 
                            onclick="openCustomPrintModal()" 
                            class="flex items-center justify-center w-full sm:w-1/2 bg-blue-custom-800 hover:bg-blue-custom-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-custom-300 text-sm"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5"/><path d="M18 10a6 6 0 0 0-9.37 0"/></svg>
                            Stampa Personalizzata Studio
                        </button>
                    </div>

                    <!-- NUOVO PULSANTE CALCOLATORE GRATUITO PATROCINIO -->
                    <a 
                        href="https://pinnaspada.github.io/gratuitopatrocinio/" 
                        target="_blank"
                        class="flex items-center justify-center w-full bg-red-600 hover:bg-red-700 text-white font-extrabold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300 text-base mt-2"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2c3.47 2 7 5 7 10"/><path d="M12 20H4c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2h.7L12 18V2z"/><path d="M22 17c0 3-3 6-7 6"/><path d="M18 10c0-1.3-.8-2.5-2-3"/></svg>
                        CALCOLATORE COMPENSI AVVOCATO GRATUITO PATROCINIO
                    </a>
                </div>
            </div>

        </div> <!-- FINE #apps-container -->

        <!-- NUOVA POSIZIONE: Blocco Note Legali Centrato a Tutta Larghezza -->
        <div id="full-width-footer" class="mt-4">
            
            <!-- Contatore Centrato Aggiornato Qui -->
            <div class="mt-4 flex justify-center w-full"> 
                <!-- hitwebcounter Code START -->
                <a href="https://www.hitwebcounter.com/" target="_blank">
                <img src="https://hitwebcounter.com/counter/counter.php?page=21452317&style=0006&nbdigits=9&type=page&initCount=0" title="Counters" Alt="Counters" border="0" /></a>
                <!-- hitwebcounter Code END -->
            </div>
            
            <!-- Note Legali Originali -->
            <footer id="legal-notes-footer" class="mt-4 p-4 bg-gray-100 text-xs text-gray-600 text-justify rounded-xl border border-gray-300">
                <p class="mb-2 font-bold text-gray-800 text-left">Note Legali Importanti:</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                    <li>
                        Calcolatore realizzato dall'<a href="https://www.ordineavvocati.ss.it/docs/mediazione_curriculum_responsabile24092025.pdf" target="_blank" class="font-bold text-indigo-600 hover:underline">Avv. Antonio Pinna Spada</a>, Responsabile dell'
                        <!-- LINK AGGIUNTO QUI per Oristano. RIMOSSO CLASSE GRASSETTO "font-bold" -->
                        <a href="https://www.ordineavvocatioristano.it/mediazione/" target="_blank" class="text-indigo-600 hover:underline">
                            Organismo di Media Conciliazione Forense dell'Ordine degli Avvocati di Oristano
                        </a> 
                        e Responsabile dell'
                        <!-- LINK AGGIUNTO QUI per Sassari. RIMOSSO CLASSE GRASSETTO "font-bold" -->
                        <a href="https://www.ordineavvocati.ss.it/pag.php?id=34" target="_blank" class="text-indigo-600 hover:underline">
                            Organismo di Mediazione del Consiglio dell'Ordine degli Avvocati di Sassari
                        </a>. 
                    </li>
                    <ul class="list-disc list-inside space-y-1 ml-4 mt-1">
                        <li>
                            In caso di conciliazione in incontro successivo al primo, gli importi complessivamente dovuti a titolo di spese di mediazione, in aggiunta a quanto prevede l'art. 30 c.2 del DM 150/2023, possono essere maggiorati fino al 20%, in ragione dell'esistenza di almeno uno dei seguenti criteri (art. 31, c. 3): a) esperienza e competenza del mediatore designato su concorde indicazione delle parti; b) complessit√† delle questioni oggetto della procedura, quali l'impegno richiesto al mediatore, valutabile anche, ma non esclusivamente, in base al numero degli incontri svolti.
                        </li>
                    </ul>
                    <li>
                        Il calcolatore pu√≤ essere utilizzato esclusivamente per esigenze non professionali e le risultanze di calcolo devono essere intese a carattere puramente indicativo e non vincolante. 
                    </li>
                    <li>
                        L'importo delle spese di mediazione del valore superiore ad ‚Ç¨ 5.000.000,01 viene calcolato ai minimi.
                    </li>
                    <li>
                        Il calcolatore √® stato sviluppato sulla base dei parametri di cui al <span class="font-medium">DM 150/2023</span> (spese di mediazione) e successive integrazioni e modifiche.
                    </li>
                    <li>
                        Il funzionamento del calcolatore √® stato testato in tutte le variabili ma non √® possibile escludere la presenza di errori, pertanto √® consigliabile <span class="font-bold text-red-700">verificare ogni volta i risultati</span> con le normative ufficiali.
                    </li>
                </ul>
            </footer>
        </div>
        <!-- FINE NUOVA POSIZIONE -->

    </div> <!-- FINE #main-container -->
    
    <!-- Modal per la personalizzazione della stampa Avvocato (Studio Legale) -->
    <div id="custom-print-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-custom-700 mb-4 border-b pb-2">Dati Studio Legale per Stampa</h3>
            <div id="modal-form" class="space-y-3">
                <div>
                    <label for="studio-nome" class="block text-sm font-medium text-gray-700">Nome Studio/Avvocato:</label>
                    <input type="text" id="studio-nome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Es. Studio Legale Rossi">
                </div>
                <div>
                    <label for="studio-indirizzo" class="block text-sm font-medium text-gray-700">Indirizzo:</label>
                    <input type="text" id="studio-indirizzo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Via Roma, 123">
                </div>
                <div>
                    <label for="studio-contatto" class="block text-sm font-medium text-gray-700">Contatto (Tel/Email):</label>
                    <input type="text" id="studio-contatto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Tel. 06 1234567 | info@studio.it">
                </div>
                <div>
                    <label for="studio-piva" class="block text-sm font-medium text-gray-700">P.IVA/Cod.Fisc.:</label>
                    <input type="text" id="studio-piva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="P.IVA 12345678901">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeCustomPrintModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm transition">Annulla</button>
                <button onclick="saveAndPrintCustom('studio')" class="bg-blue-custom-700 hover:bg-blue-custom-800 text-white font-bold py-2 px-4 rounded-lg text-sm transition">Salva e Stampa</button>
            </div>
        </div>
    </div>
    
    <!-- Modal per la personalizzazione della stampa Mediazione (Organismo) (NUOVO) -->
    <div id="mediation-print-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Dati Organismo di Mediazione per Stampa</h3>
            <div id="mediation-modal-form" class="space-y-3">
                <div>
                    <label for="organismo-nome" class="block text-sm font-medium text-gray-700">Nome Organismo:</label>
                    <input type="text" id="organismo-nome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Es. Organismo di Mediazione Forense">
                </div>
                <div>
                    <label for="organismo-indirizzo" class="block text-sm font-medium text-gray-700">Indirizzo Sede:</label>
                    <input type="text" id="organismo-indirizzo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Via Dante, 5">
                </div>
                <div>
                    <label for="organismo-contatto" class="block text-sm font-medium text-gray-700">Contatto (Tel/Email):</label>
                    <input type="text" id="organismo-contatto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Tel. 070 876543 | info@organismo.it">
                </div>
                <div>
                    <label for="organismo-cfin" class="block text-sm font-medium text-gray-700">Codice Fiscale / Iscrizione:</label>
                    <input type="text" id="organismo-cfin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="C.F. 12345678901 / N¬∞ Reg. 123">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeMediationCustomPrintModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm transition">Annulla</button>
                <button onclick="saveAndPrintMediationCustom('organismo')" class="bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded-lg text-sm transition">Salva e Stampa</button>
            </div>
        </div>
    </div>


    <!-- Script per Logica Applicativa (SENZA FIREBASE) -->
    <script type="module">
        // Variabili globali per la gestione del modal e localStorage
        const STUDIO_PRINT_MODAL_ID = 'custom-print-modal';
        const MEDIATION_PRINT_MODAL_ID = 'mediation-print-modal';
        const STUDIO_STORAGE_KEY = 'studio_data';
        const ORGANISMO_STORAGE_KEY = 'organismo_data';
        
        // Costanti per la modulazione del valore indeterminato
        // NON pi√π usati per calcolare le indennit√† (Caselle 2,3,4) ma solo per la Spesa di Avvio (Casella 1) e i messaggi.
        const INDETERMINATE_MULTIPLIERS = { 
            alto: 1.2, 
            medio: 1.0, 
            basso: 0.8,
        };


        // --- FUNZIONI DI UTILITY ---
        /**
         * Formatta un numero in valuta Euro.
         * @param {number} value Il valore numerico.
         * @returns {string} Il valore formattato.
         */
        const formatCurrency = (value) => {
            if (typeof value !== 'number' || isNaN(value)) {
                return '0,00 ‚Ç¨';
            }
            return `${value.toFixed(2).replace('.', ',')} ‚Ç¨`;
        };
        
        /**
         * Carica i dati da localStorage.
         * @param {string} key Chiave di localStorage (STUDIO_STORAGE_KEY o ORGANISMO_STORAGE_KEY).
         * @returns {object} I dati salvati o un oggetto vuoto.
         */
        const loadData = (key) => {
            try {
                const storedData = localStorage.getItem(key);
                return storedData ? JSON.parse(storedData) : {};
            } catch (e) {
                console.error(`Errore nel caricamento dei dati per la chiave ${key}:`, e);
                return {};
            }
        };

        /**
         * Salva i dati in localStorage.
         * @param {string} key Chiave di localStorage.
         * @param {object} data I dati da salvare.
         */
        const saveData = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Errore nel salvataggio dei dati per la chiave ${key}:`, e);
            }
        };

        // --- LOGICA MODAL DI PERSONALIZZAZIONE STUDIO (AVVOCATO) ---

        /**
         * Apre il modal di personalizzazione Studio e carica i dati salvati.
         */
        window.openCustomPrintModal = () => {
            const modal = document.getElementById(STUDIO_PRINT_MODAL_ID);
            const data = loadData(STUDIO_STORAGE_KEY);
            
            document.getElementById('studio-nome').value = data.nome || '';
            document.getElementById('studio-indirizzo').value = data.indirizzo || '';
            document.getElementById('studio-contatto').value = data.contatto || '';
            document.getElementById('studio-piva').value = data.piva || '';

            modal.classList.remove('hidden');
        };

        /**
         * Chiude il modal di personalizzazione Studio.
         */
        window.closeCustomPrintModal = () => {
            const modal = document.getElementById(STUDIO_PRINT_MODAL_ID);
            modal.classList.add('hidden');
        };

        /**
         * Salva i dati del form Studio in localStorage e avvia la stampa personalizzata Avvocato.
         */
        window.saveAndPrintCustom = () => {
            const nome = document.getElementById('studio-nome').value.trim();
            const indirizzo = document.getElementById('studio-indirizzo').value.trim();
            const contatto = document.getElementById('studio-contatto').value.trim();
            const piva = document.getElementById('studio-piva').value.trim();
            
            const data = { nome, indirizzo, contatto, piva };
            saveData(STUDIO_STORAGE_KEY, data);
            
            closeCustomPrintModal();
            printCustomForensicReport(data);
        };
        
        // --- LOGICA MODAL DI PERSONALIZZAZIONE ORGANISMO (MEDIAZIONE) (NUOVO) ---

        /**
         * Apre il modal di personalizzazione Organismo e carica i dati salvati.
         */
        window.openMediationCustomPrintModal = () => {
            const modal = document.getElementById(MEDIATION_PRINT_MODAL_ID);
            const data = loadData(ORGANISMO_STORAGE_KEY);
            
            document.getElementById('organismo-nome').value = data.nome || '';
            document.getElementById('organismo-indirizzo').value = data.indirizzo || '';
            document.getElementById('organismo-contatto').value = data.contatto || '';
            document.getElementById('organismo-cfin').value = data.cfin || '';

            modal.classList.remove('hidden');
        };

        /**
         * Chiude il modal di personalizzazione Organismo.
         */
        window.closeMediationCustomPrintModal = () => {
            const modal = document.getElementById(MEDIATION_PRINT_MODAL_ID);
            modal.classList.add('hidden');
        };
        
        /**
         * Salva i dati del form Organismo in localStorage e avvia la stampa personalizzata Organismo.
         */
        window.saveAndPrintMediationCustom = () => {
            const nome = document.getElementById('organismo-nome').value.trim();
            const indirizzo = document.getElementById('organismo-indirizzo').value.trim();
            const contatto = document.getElementById('organismo-contatto').value.trim();
            const cfin = document.getElementById('organismo-cfin').value.trim();
            
            const data = { nome, indirizzo, contatto, cfin };
            saveData(ORGANISMO_STORAGE_KEY, data);
            
            closeMediationCustomPrintModal();
            printCustomMediationReport(data);
        };
        
        // --- FUNZIONI DI STAMPA PERSONALIZZATA ---

        /**
         * Genera l'intestazione personalizzata.
         * @param {object} customData I dati da stampare (Studio o Organismo).
         * @param {string} color Il colore dominante (es. #1d4ed8 per Studio, #4f46e5 per Organismo).
         * @returns {string} L'HTML dell'intestazione.
         */
        const generateCustomHeader = (customData, color) => {
            if (!customData || !customData.nome) {
                return '';
            }
            
            // Per Organismo usiamo cfin, per Studio usiamo piva
            const identifier = customData.cfin || customData.piva || ''; 
            const contactLine = [customData.contatto, identifier].filter(Boolean).join(' | ');

            return `
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ccc;">
                    <h1 style="font-size: 1.25rem; font-weight: bold; color: ${color};">${customData.nome}</h1>
                    ${customData.indirizzo ? `<p style="font-size: 0.875rem; color: #4b5563;">${customData.indirizzo}</p>` : ''}
                    ${contactLine ? `<p style="font-size: 0.875rem; color: #4b5563;">${contactLine}</p>` : ''}
                </div>
            `;
        };

        /**
         * Cattura il contenuto del calcolatore Avvocato e avvia la stampa con intestazione personalizzata.
         * @param {object} studioData I dati dello studio da inserire nell'intestazione.
         */
        const printCustomForensicReport = (studioData) => {
            const forensicContent = document.getElementById('forensic-app');
            const integratedHeader = document.getElementById('integrated-calculator-header');
            const legalNotes = document.getElementById('legal-notes-footer');

            if (!forensicContent || !legalNotes || !integratedHeader) {
                console.error(`Contenuto necessario per la stampa Avvocato non trovato.`);
                return;
            }

            // Clona i contenuti per la manipolazione
            const contentToPrint = forensicContent.cloneNode(true);
            const integratedHeaderToPrint = integratedHeader.cloneNode(true);
            const legalNotesToPrint = legalNotes.cloneNode(true);

            // Rimuove gli elementi non necessari/interattivi dal clone dell'app forense
            const elementsToRemove = contentToPrint.querySelectorAll('.print-hide, .print-button-container');
            elementsToRemove.forEach(el => el.remove());

            // Rende visibile l'informazione sul valore lite per la stampa nel clone dell'app
            const printValueEl = contentToPrint.querySelector('.print-only');
            if (printValueEl) {
                printValueEl.classList.remove('print-only');
                printValueEl.classList.add('print-litigation-value'); 
            }

            // Genera l'intestazione personalizzata dello studio (Tema Blu)
            const customHeaderHtml = generateCustomHeader(studioData, '#1d4ed8');
            
            // Costruisce il contenuto HTML completo per la stampa
            const integratedHeaderHtml = integratedHeaderToPrint.outerHTML;
            const appContentHtml = contentToPrint.outerHTML;
            const footerContentHtml = legalNotesToPrint.outerHTML;

            const printHTML = `
                ${customHeaderHtml}
                ${integratedHeaderHtml}
                <div class="print-content-wrapper" style="padding-top: 1rem;">
                    ${appContentHtml}
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
                        ${footerContentHtml}
                    </div>
                </div>
            `;
            
            // Crea la finestra di stampa
            const style = document.querySelector('style').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            if (!printWindow) {
                console.error("Impossibile aprire la finestra di stampa. Controllare le impostazioni di blocco dei popup.");
                return;
            }
            
            printWindow.document.write('<html><head><title>Stampa Personalizzata Compensi Avvocato</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write(`<style>${style}</style>`);
            
            printWindow.document.write('</head><body class="print-container">');
            printWindow.document.write(printHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close(); 
            
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        }

        /**
         * Cattura il contenuto del calcolatore Mediazione e avvia la stampa con intestazione personalizzata.
         * @param {object} organismoData I dati dell'Organismo da inserire nell'intestazione.
         */
        const printCustomMediationReport = (organismoData) => {
            const mediationContent = document.getElementById('mediation-app');
            const integratedHeader = document.getElementById('integrated-calculator-header');
            const legalNotes = document.getElementById('legal-notes-footer');

            if (!mediationContent || !legalNotes || !integratedHeader) {
                console.error(`Contenuto necessario per la stampa Mediazione non trovato.`);
                return;
            }

            // Clona i contenuti per la manipolazione
            const contentToPrint = mediationContent.cloneNode(true);
            const integratedHeaderToPrint = integratedHeader.cloneNode(true);
            const legalNotesToPrint = legalNotes.cloneNode(true);

            // Rimuove gli elementi non necessari/interattivi dal clone dell'app mediazione
            const elementsToRemove = contentToPrint.querySelectorAll('.print-hide, .print-button-container');
            elementsToRemove.forEach(el => el.remove());

            // Rende visibile l'informazione sul valore lite per la stampa nel clone dell'app
            const printValueEl = contentToPrint.querySelector('.print-only');
            if (printValueEl) {
                printValueEl.classList.remove('print-only');
                printValueEl.classList.add('print-litigation-value'); 
            }

            // Genera l'intestazione personalizzata dell'Organismo (Tema Viola)
            const customHeaderHtml = generateCustomHeader(organismoData, '#4f46e5');
            
            // Costruisce il contenuto HTML completo per la stampa
            const integratedHeaderHtml = integratedHeaderToPrint.outerHTML;
            const appContentHtml = contentToPrint.outerHTML;
            // Variabile corretta: footerContentHtml (usava H maiuscola in HTML)
            const footerContentHtml = legalNotesToPrint.outerHTML;

            const printHTML = `
                ${customHeaderHtml}
                ${integratedHeaderHtml}
                <div class="print-content-wrapper" style="padding-top: 1rem;">
                    ${appContentHtml}
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
                        ${footerContentHtml}
                    </div>
                </div>
            `;
            
            // Crea la finestra di stampa
            const style = document.querySelector('style').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            if (!printWindow) {
                console.error("Impossibile aprire la finestra di stampa. Controllare le impostazioni di blocco dei popup.");
                return;
            }
            
            printWindow.document.write('<html><head><title>Stampa Personalizzata Spese Mediazione</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write(`<style>${style}</style>`);
            
            printWindow.document.write('</head><body class="print-container">');
            printWindow.document.write(printHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close(); 
            
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        }

        /**
         * Aggiorna la label e il tipo di input del valore lite
         */
        window.updateValueInputType = () => {
            const valueTypeSelect = document.getElementById('litigation-value-type');
            const valueInput = document.getElementById('mediation-litigation-value');
            const valueLabel = document.querySelector('label[for="mediation-litigation-value"]');
            const indeterminateBox = document.getElementById('indeterminate-value-options');
            
            const isIndeterminabile = valueTypeSelect.value === 'indeterminabile';

            if (isIndeterminabile) {
                valueLabel.textContent = 'Valore della Lite (Tipo):';
                valueInput.value = 'Indeterminabile';
                valueInput.setAttribute('disabled', 'true');
                valueInput.setAttribute('placeholder', 'Indeterminabile');
                indeterminateBox.classList.remove('hidden');
            } else {
                valueLabel.textContent = 'Valore della Lite (‚Ç¨):';
                // Pulisci l'input solo se prima era Indeterminabile per evitare bug
                if (valueInput.value.toLowerCase() === 'indeterminabile' || valueInput.hasAttribute('disabled')) {
                    valueInput.value = '';
                }
                valueInput.removeAttribute('disabled');
                valueInput.setAttribute('placeholder', 'es. 15000');
                indeterminateBox.classList.add('hidden');
            }
        };


        // =========================================================================
        // --- LOGICA CALCOLO MEDIAZIONE ---
        // =========================================================================

        // Dati per le tariffe di mediazione (DM 150/2023) - UNIFICATI
        const MEDIATION_TARIFFS = {
            minimi: {
                obbligatorie: [
                    { min: 0, max: 1000, speseFisse: 97.60, speseAvvio: 39.04, indennitaPrimoIncontro: 58.56, negativo: 19.52, positivo1: 21.47, positivoDopo1: 24.40 },
                    { min: 1000.01, max: 5000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 39.04, positivo1: 42.94, positivoDopo1: 48.80 },
                    { min: 5000.01, max: 10000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 165.92, positivo1: 182.51, positivoDopo1: 207.40 },
                    { min: 10000.01, max: 25000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 312.32, positivo1: 343.55, positivoDopo1: 390.40 },
                    { min: 25000.01, max: 50000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 585.60, positivo1: 644.16, positivoDopo1: 732.00 },
                    { min: 50000.01, max: 150000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 1005.28, positivo1: 1105.81, positivoDopo1: 1256.60 },
                    { min: 150000.01, max: 250000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 1298.08, positivo1: 1427.89, positivoDopo1: 1622.60 },
                    { min: 250000.01, max: 500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 2274.08, positivo1: 2501.49, positivoDopo1: 2842.60 },
                    { min: 500000.01, max: 1500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 3640.48, positivo1: 4004.53, positivoDopo1: 4550.60 },
                    { min: 1500000.01, max: 2500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 4323.68, positivo1: 4756.05, positivoDopo1: 5404.60 },
                    { min: 2500000.01, max: 5000000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 6178.08, positivo1: 6795.89, positivoDopo1: 7722.60 },
                    { 
                    min: 5000000.01, max: Infinity, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, formula: true, 
                    formulaNegativo: (v) => (((0.002 * v) - 170) * 0.8 * 1.22), 
                    formulaPositivo1: (v) => (((0.002 * v) - 170) * 0.8 * 1.1 * 1.22), 
                    formulaPositivoDopo1: (v) => (((0.002 * v) - 170) * 0.8 * 1.25 * 1.22), 
                    },
                    { 
                        min: Infinity, max: Infinity, 
                        speseFisseAlto: 273.28, speseAvvioAlto: 107.36, indennitaPrimoIncontroAlto: 165.92,
                        speseFisseMedio: 224.48, speseAvvioMedio: 107.36, indennitaPrimoIncontroMedio: 117.12,
                        speseFisseBasso: 165.92, speseAvvioBasso: 107.36, indennitaPrimoIncontroBasso: 58.56,
                        negativoAlto: 1005.28,
                        negativoMedio: 1054.08,
                        negativoBasso: 1112.64,
                        positivo1Alto: 1105.81,
                        positivo1Medio: 1159.49,
                        positivo1Basso: 1223.90,
                        positivoDopo1Alto: 1256.60,
                        positivoDopo1Medio: 1317.60,
                        positivoDopo1Basso: 1390.80,
                        indeterminabile: true 
                    },
                ],
                volontarie: [
                    { min: 0, max: 1000, speseFisse: 122.00, speseAvvio: 48.80, indennitaPrimoIncontro: 73.20, negativo: 24.40, positivo1: 26.84, positivoDopo1: 30.50 },
                    { min: 1000.01, max: 5000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 48.80, positivo1: 53.68, positivoDopo1: 61.00 },
                    { min: 5000.01, max: 10000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 207.40, positivo1: 228.14, positivoDopo1: 259.25 },
                    { min: 10000.01, max: 25000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 390.40, positivo1: 429.44, positivoDopo1: 488.00 },
                    { min: 25000.01, max: 50000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 732.00, positivo1: 805.20, positivoDopo1: 915.00 },
                    { min: 50000.01, max: 150000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 1256.60, positivo1: 1382.26, positivoDopo1: 1570.75 },
                    { min: 150000.01, max: 250000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 1622.60, positivo1: 1784.86, positivoDopo1: 2028.25 },
                    { min: 250000.01, max: 500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 2842.60, positivo1: 3126.86, positivoDopo1: 3553.25 },
                    { min: 500000.01, max: 1500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 4550.60, positivo1: 5005.66, positivoDopo1: 5688.25 },
                    { min: 1500000.01, max: 2500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 5404.60, positivo1: 5945.06, positivoDopo1: 6755.75 },
                    { min: 2500000.01, max: 5000000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 7722.60, positivo1: 8494.86, positivoDopo1: 9653.25 },
                    { 
                    min: 5000000.01, max: Infinity, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, formula: true, 
                    formulaNegativo: (v) => ((0.002 * v) - 170) * 1.22, 
                    formulaPositivo1: (v) => ((0.002 * v) - 170) * 1.1 * 1.22, 
                    formulaPositivoDopo1: (v) => ((0.002 * v) - 170) * 1.25 * 1.22, 
                    },
                    { 
                        min: Infinity, max: Infinity, 
                        speseFisseAlto: 341.60, speseAvvioAlto: 134.20, indennitaPrimoIncontroAlto: 207.40,
                        speseFisseMedio: 280.60, speseAvvioMedio: 134.20, indennitaPrimoIncontroMedio: 146.40,
                        speseFisseBasso: 207.40, speseAvvioBasso: 134.20, indennitaPrimoIncontroBasso: 73.20,
                        negativoAlto: 1439.60, 
                        negativoMedio: 1500.60,
                        negativoBasso: 1573.80, 
                        positivo1Alto: 1583.56, 
                        positivo1Medio: 1650.66, 
                        positivo1Basso: 1731.18, 
                        positivoDopo1Alto: 1799.50, 
                        positivoDopo1Medio: 1875.75, 
                        positivoDopo1Basso: 1967.25, 
                        indeterminabile: true 
                    },
                ],
            },
        };

        window.calculateMediationFees = () => {
            const litigationTypeInput = document.getElementById('litigation-value-type');
            const mediationLitigationInput = document.getElementById('mediation-litigation-value');
            const forensicLitigationInput = document.getElementById('forensic-litigation-value');
            const mediationTypeInput = document.getElementById('mediation-type');
            const tariffLevelInput = document.getElementById('mediation-tariff-level');
            const tariffTitleEl = document.getElementById('tariff-title');
            
            const indeterminateLevel = document.querySelector('input[name="indeterminato-level"]:checked')?.value || 'medio';
            
            const isIndeterminabileSelection = litigationTypeInput.value === 'indeterminabile';
            // Il valore da usare per il calcolo sar√† 'indeterminabile' o il valore numerico
            const valueStr = isIndeterminabileSelection ? 'indeterminabile' : mediationLitigationInput.value.toLowerCase().trim();
            const value = isIndeterminabileSelection ? 0 : parseFloat(valueStr.replace(',', '.'));
            
            const mediationType = mediationTypeInput.value;
            const tariffLevel = tariffLevelInput.value;
            const isIndeterminabile = isIndeterminabileSelection; // Usa la selezione del tipo

            // --- LOGICA DI VISIBILIT√Ä MODULAZIONE INDETERMINATO ---
            const indeterminateOptionsBox = document.getElementById('indeterminate-value-options');
            if (indeterminateOptionsBox) {
                if (isIndeterminabile) {
                    indeterminateOptionsBox.classList.remove('hidden');
                } else {
                    indeterminateOptionsBox.classList.add('hidden');
                }
            }


            // --- LOGICA DI SINCRONIZZAZIONE (Avvocato) ---
            if (forensicLitigationInput) {
                if (isIndeterminabile) {
                    // L'app Avvocato non supporta il calcolo con valore indeterminabile
                    forensicLitigationInput.value = 'indeterminabile'; 
                } else if (!isNaN(value) && value >= 0) {
                    // Sincronizza il valore numerico
                    forensicLitigationInput.value = mediationLitigationInput.value; 
                } else {
                    // Campo vuoto
                    forensicLitigationInput.value = ''; 
                }
                
                if (typeof window.calculateForensicFees === 'function') {
                    window.calculateForensicFees();
                }
            }

            // === LOGICA BLINK ===
            const tariffTitleSpan = tariffTitleEl.querySelector('span'); 

            if (tariffLevel === 'medi') {
                if (!tariffTitleSpan || !tariffTitleSpan.classList.contains('blink-animation')) {
                    tariffTitleEl.innerHTML = `<span class="flex items-center text-red-600 blink-animation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6">
                          <path d="M12 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h7"/><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/>
                        </svg> 
                        Spese di Mediazione - Valori Medi
                      </span>
                    `;
                }
            } else {
                tariffTitleEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 text-indigo-600"><path d="M12 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h7"/><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg> Spese di Mediazione - Valori Minimi`;
            }
            

            const selectedLevelTariffs = MEDIATION_TARIFFS[tariffLevel];

            if (!selectedLevelTariffs) {
                 console.error("Livello tariffario non valido:", tariffLevel);
                 return;
            }

            const selectedTariffs = selectedLevelTariffs[mediationType];
            let foundTariff = null;
            const IVA_RATE_FACTOR = 1.22; 
            
            // Determina il moltiplicatore (NON PI√ô USATO per Indennit√†, ma mantenuto per compatibilit√†)
            const multiplier = isIndeterminabile ? INDETERMINATE_MULTIPLIERS[indeterminateLevel] : 1.0;


            const alertEl = document.getElementById('mediation-alert');
            const mediationPrintValueEl = document.getElementById('mediation-print-value'); 
            
            const typeText = mediationTypeInput.options[mediationTypeInput.selectedIndex].text;
            const levelText = tariffLevelInput.options[tariffLevelInput.selectedIndex].text;
            
            let printValueText = `Valore Lite: ${isIndeterminabile ? 'Indeterminabile' : (valueStr === '' ? 'Non specificato' : formatCurrency(value))}`;
            if (isIndeterminabile) {
                printValueText = `Valore Lite: Indeterminabile (Modulazione: ${indeterminateLevel.toUpperCase()})`;
            }
            
            printValueText += ` | Tipo: ${typeText} | Livello: ${levelText}`;
            mediationPrintValueEl.innerHTML = `<p class="font-bold print-litigation-value border-b border-gray-300 pb-2">${printValueText}</p>`;
            
            
            const feesStartupEl = document.getElementById('fees-startup');
            const feesStartupImponibileEl = document.getElementById('fees-startup-imponibile');
            const feesStartupIvaEl = document.getElementById('fees-startup-iva'); 
            const feesStartupBreakdownAvvioEl = document.getElementById('fees-startup-breakdown-avvio');
            const feesStartupBreakdownIndennitaEl = document.getElementById('fees-startup-breakdown-indennita');
            const feesStartupBreakdownAvvioImponibileEl = document.getElementById('fees-startup-breakdown-avvio-imponibile');
            const feesStartupBreakdownAvvioIvaEl = document.getElementById('fees-startup-breakdown-avvio-iva');
            const feesStartupBreakdownIndennitaImponibileEl = document.getElementById('fees-startup-breakdown-indennita-imponibile');
            const feesStartupBreakdownIndennitaIvaEl = document.getElementById('fees-startup-breakdown-indennita-iva');
            const feesNegativeEl = document.getElementById('fees-negative');
            const feesNegativeImponibileEl = document.getElementById('fees-negative-imponibile');
            const feesNegativeIvaEl = document.getElementById('fees-negative-iva'); 
            const feesPositive1El = document.getElementById('fees-positive-1');
            const feesPositive1ImponibileEl = document.getElementById('fees-positive-1-imponibile');
            const feesPositive1IvaEl = document.getElementById('fees-positive-1-iva'); 
            const feesPositiveAfter1El = document.getElementById('fees-positive-after-1');
            const feesPositiveAfter1ImponibileEl = document.getElementById('fees-positive-after-1-imponibile');
            const feesPositiveAfter1IvaEl = document.getElementById('fees-positive-after-1-iva'); 
            
            const totalStartupEl = document.getElementById('total-startup');
            const totalStartupImponibileEl = document.getElementById('total-startup-imponibile');
            const totalStartupIvaEl = document.getElementById('total-startup-iva');

            const totalNegativeEl = document.getElementById('total-negative');
            const totalNegativeImponibileEl = document.getElementById('total-negative-imponibile');
            const totalNegativeIvaEl = document.getElementById('total-negative-iva');

            const totalPositive1El = document.getElementById('total-positive-1');
            const totalPositive1ImponibileEl = document.getElementById('total-positive-1-imponibile');
            const totalPositive1IvaEl = document.getElementById('total-positive-1-iva');

            const totalPositiveAfter1El = document.getElementById('total-positive-after-1');
            const totalPositiveAfter1ImponibileEl = document.getElementById('total-positive-after-1-imponibile');
            const totalPositiveAfter1IvaEl = document.getElementById('total-positive-after-1-iva');


            alertEl.classList.add('hidden');
            let startUpFees = 0;
            let breakdownAvvio = 0;
            let breakdownIndennita = 0;
            let negativeOutcomeFees = 0;
            let positive1Fees = 0;
            let positiveAfter1Fees = 0;

            if (isIndeterminabile) {
                foundTariff = selectedTariffs.find(t => t.indeterminabile);
                if (foundTariff) {
                    // Logica specifica per Indeterminabile (Valori fissi forniti dall'utente)
                    if (indeterminateLevel === 'alto') {
                        startUpFees = foundTariff.speseFisseAlto;
                        breakdownAvvio = foundTariff.speseAvvioAlto;
                        breakdownIndennita = foundTariff.indennitaPrimoIncontroAlto;
                        negativeOutcomeFees = foundTariff.negativoAlto;
                        positive1Fees = foundTariff.positivo1Alto;
                        positiveAfter1Fees = foundTariff.positivoDopo1Alto;
                    } else if (indeterminateLevel === 'medio') {
                        startUpFees = foundTariff.speseFisseMedio;
                        breakdownAvvio = foundTariff.speseAvvioMedio;
                        breakdownIndennita = foundTariff.indennitaPrimoIncontroMedio;
                        negativeOutcomeFees = foundTariff.negativoMedio;
                        positive1Fees = foundTariff.positivo1Medio;
                        positiveAfter1Fees = foundTariff.positivoDopo1Medio;
                    } else if (indeterminateLevel === 'basso') {
                        startUpFees = foundTariff.speseFisseBasso;
                        breakdownAvvio = foundTariff.speseAvvioBasso;
                        breakdownIndennita = foundTariff.indennitaPrimoIncontroBasso;
                        negativeOutcomeFees = foundTariff.negativoBasso;
                        positive1Fees = foundTariff.positivo1Basso;
                        positiveAfter1Fees = foundTariff.positivoDopo1Basso;
                    } else {
                         // Fallback al Medio se per qualche motivo il livello non √® definito
                         startUpFees = foundTariff.speseFisseMedio;
                         breakdownAvvio = foundTariff.speseAvvioMedio;
                         breakdownIndennita = foundTariff.indennitaPrimoIncontroMedio;
                         negativeOutcomeFees = foundTariff.negativoMedio;
                         positive1Fees = foundTariff.positivo1Medio;
                         positiveAfter1Fees = foundTariff.positivoDopo1Medio;
                    }

                    let message = `Attenzione: Valore Indeterminabile. Applicata tariffa massima del quinto scaglione (fino a 150.000 ‚Ç¨).`;
                    if (indeterminateLevel) {
                        message += ` Modulazione: ${indeterminateLevel.toUpperCase()}.`;
                    }
                    alertEl.innerHTML = message;
                    alertEl.classList.remove('hidden');
                }
            } else if (!isNaN(value) && value >= 0) {
                for (const tariff of selectedTariffs) {
                    if (value >= tariff.min && value <= tariff.max) {
                        foundTariff = tariff;
                        break;
                    }
                }
            } else if (!isIndeterminabile && valueStr !== '') {
                 alertEl.innerHTML = `Valore della lite non valido o non rientrante negli scaglioni previsti.`;
                 alertEl.classList.remove('hidden');
                 startUpFees = negativeOutcomeFees = positive1Fees = positiveAfter1Fees = 0;
                 breakdownAvvio = 0; breakdownIndennita = 0;
            } else if (valueStr === '') {
                 startUpFees = negativeOutcomeFees = positive1Fees = positiveAfter1Fees = 0;
                 breakdownAvvio = 0; breakdownIndennita = 0;
            }

            if (foundTariff && !foundTariff.indeterminabile) { // Se √® determinabile o formula
                startUpFees = foundTariff.speseFisse; 
                breakdownAvvio = foundTariff.speseAvvio;
                breakdownIndennita = foundTariff.indennitaPrimoIncontro;
                
                if (foundTariff.formula) {
                    negativeOutcomeFees = foundTariff.formulaNegativo(value);
                    positive1Fees = foundTariff.formulaPositivo1(value);
                    positiveAfter1Fees = foundTariff.formulaPositivoDopo1(value);
                    alertEl.innerHTML = `Attenzione: Valore superiore a 5.000.000,00 ‚Ç¨ - Applicata tariffa con formula.`;
                    alertEl.classList.remove('hidden');
                } else {
                    negativeOutcomeFees = foundTariff.negativo;
                    positive1Fees = foundTariff.positivo1;
                    positiveAfter1Fees = foundTariff.positivoDopo1;
                }
            }
            
            const startupImponibile = startUpFees / IVA_RATE_FACTOR;
            const startupIVA = startUpFees - startupImponibile;
            
            const breakdownAvvioImponibile = breakdownAvvio / IVA_RATE_FACTOR;
            const breakdownAvvioIVA = breakdownAvvio - breakdownAvvioImponibile;
            const breakdownIndennitaImponibile = breakdownIndennita / IVA_RATE_FACTOR;
            const breakdownIndennitaIVA = breakdownIndennita - breakdownIndennitaImponibile;

            const negativeImponibile = negativeOutcomeFees / IVA_RATE_FACTOR;
            const negativeIVA = negativeOutcomeFees - negativeImponibile;
            
            const positive1Imponibile = positive1Fees / IVA_RATE_FACTOR;
            const positive1IVA = positive1Fees - positive1Imponibile;
            
            const positiveAfter1Imponibile = positiveAfter1Fees / IVA_RATE_FACTOR;
            const positiveAfter1IVA = positiveAfter1Fees - positiveAfter1Imponibile;


            feesStartupEl.textContent = formatCurrency(startUpFees);
            if (feesStartupBreakdownAvvioEl && feesStartupBreakdownIndennitaEl) {
                feesStartupBreakdownAvvioEl.textContent = formatCurrency(breakdownAvvio);
                feesStartupBreakdownIndennitaEl.textContent = formatCurrency(breakdownIndennita);
                if (feesStartupBreakdownAvvioImponibileEl) feesStartupBreakdownAvvioImponibileEl.textContent = formatCurrency(breakdownAvvioImponibile);
                if (feesStartupBreakdownAvvioIvaEl) feesStartupBreakdownAvvioIvaEl.textContent = formatCurrency(breakdownAvvioIVA);
                if (feesStartupBreakdownIndennitaImponibileEl) feesStartupBreakdownIndennitaImponibileEl.textContent = formatCurrency(breakdownIndennitaImponibile);
                if (feesStartupBreakdownIndennitaIvaEl) feesStartupBreakdownIndennitaIvaEl.textContent = formatCurrency(breakdownIndennitaIVA);
            }
            feesNegativeEl.textContent = formatCurrency(negativeOutcomeFees);
            feesPositive1El.textContent = formatCurrency(positive1Fees);
            feesPositiveAfter1El.textContent = formatCurrency(positiveAfter1Fees);
            
            feesStartupImponibileEl.textContent = formatCurrency(startupImponibile);
            feesStartupIvaEl.textContent = formatCurrency(startupIVA);

            feesNegativeImponibileEl.textContent = formatCurrency(negativeImponibile);
            feesNegativeIvaEl.textContent = formatCurrency(negativeIVA);

            feesPositive1ImponibileEl.textContent = formatCurrency(positive1Imponibile);
            feesPositive1IvaEl.textContent = formatCurrency(positive1IVA);

            feesPositiveAfter1ImponibileEl.textContent = formatCurrency(positiveAfter1Imponibile);
            feesPositiveAfter1IvaEl.textContent = formatCurrency(positiveAfter1IVA);


            // --- AGGIORNAMENTO RIEPILOGO TOTALE ---
            // La logica di calcolo del Totale non viene modificata
            
            const totalStartup = startUpFees; 
            const totalStartupImponibile = totalStartup / IVA_RATE_FACTOR;
            const totalStartupIVA = totalStartup - totalStartupImponibile;
            
            const totalNegative = startUpFees + negativeOutcomeFees;
            const totalNegativeImponibile = totalNegative / IVA_RATE_FACTOR;
            const totalNegativeIVA = totalNegative - totalNegativeImponibile;

            const totalPositive1 = startUpFees + positive1Fees;
            const totalPositive1Imponibile = totalPositive1 / IVA_RATE_FACTOR;
            const totalPositive1IVA = totalPositive1 - totalPositive1Imponibile;

            const totalPositiveAfter1 = startUpFees + positiveAfter1Fees;
            const totalPositiveAfter1Imponibile = totalPositiveAfter1 / IVA_RATE_FACTOR;
            const totalPositiveAfter1IVA = totalPositiveAfter1 - totalPositiveAfter1Imponibile;


            totalStartupEl.textContent = formatCurrency(totalStartup);
            totalStartupImponibileEl.textContent = formatCurrency(totalStartupImponibile);
            totalStartupIvaEl.textContent = formatCurrency(totalStartupIVA);

            totalNegativeEl.textContent = formatCurrency(totalNegative);
            totalNegativeImponibileEl.textContent = formatCurrency(totalNegativeImponibile);
            totalNegativeIvaEl.textContent = formatCurrency(totalNegativeIVA);

            totalPositive1El.textContent = formatCurrency(totalPositive1);
            totalPositive1ImponibileEl.textContent = formatCurrency(totalPositive1Imponibile);
            totalPositive1IvaEl.textContent = formatCurrency(totalPositive1IVA);

            totalPositiveAfter1El.textContent = formatCurrency(totalPositiveAfter1);
            totalPositiveAfter1ImponibileEl.textContent = formatCurrency(totalPositiveAfter1Imponibile);
            totalPositiveAfter1IvaEl.textContent = formatCurrency(totalPositiveAfter1IVA);

        };


        // =========================================================================
        // --- LOGICA APP 2: CALCOLATORE COMPENSI AVVOCATO (spese legali blu) ---
        // =========================================================================
        
        // TABELLA COMPENSI DETTAGLIATA PER MEDIAZIONE (DM 55/2014)
        const FORENSIC_FEE_TABLE = [
            // Fase di Mediazione (Tabelle 1, 2 e 3 del DM 55/2014)
            { min: 0, max: 1100, activation: { min: 32, medium: 63, max: 95 }, negotiation: { min: 63, medium: 126, max: 189 }, conciliation: { min: 123, medium: 246, max: 369 } },
            { min: 1100.01, max: 5200, activation: { min: 142, medium: 284, max: 426 }, negotiation: { min: 284, medium: 567, max: 851 }, conciliation: { min: 553, medium: 1106, max: 1659 } },
            { min: 5200.01, max: 26000, activation: { min: 221, medium: 441, max: 662 }, negotiation: { min: 441, medium: 882, max: 1323 }, conciliation: { min: 860, medium: 1720, max: 2580 } },
            { min: 26000.01, max: 52000, activation: { min: 268, medium: 536, max: 804 }, negotiation: { min: 536, medium: 1071, max: 1607 }, conciliation: { min: 1044, medium: 2088, max: 3132 } },
            { min: 52000.01, max: 260000, activation: { min: 504, medium: 1008, max: 1512 }, negotiation: { min: 1008, medium: 2016, max: 3024 }, conciliation: { min: 1966, medium: 3931, max: 5897 } },
            { min: 260000.01, max: 520000, activation: { min: 685, medium: 1370, max: 2055 }, negotiation: { min: 1371, medium: 2741, max: 4112 }, conciliation: { min: 2672, medium: 5343, max: 8015 } },
        ];
        
        const FORENSIC_STATUTORY_COSTS = {
            forfeit: 0.15, // Spese forfettarie 15%
            cassa: 0.04,    // Contributo Cassa 4%
            iva: 0.22,      // IVA 22%
            increase: 0.30, // Maggiorazione 30% per esito positivo
        };

        /**
         * Funzione per selezionare un livello di compenso cliccando sul valore.
         */
        window.selectForensicFee = (phaseName, level) => { 
            // Aggiorna il radio button nascosto
            const radioId = `${phaseName.substring(0, 3)}-${level.substring(0, 3)}`;
            const radioElement = document.getElementById(radioId);
            
            // Assicurati che l'elemento radio esista prima di modificarlo
            if (radioElement) {
                radioElement.checked = true; 
                
                // Rimuovi l'highlight da tutti i fratelli
                const parentBox = document.getElementById(`phase-${phaseName}-box`);
                parentBox.querySelectorAll('.fee-display-item').forEach(item => {
                    item.classList.remove('highlighted-fee');
                });
                
                // Aggiungi l'highlight a quello selezionato (basandoti sul display-id)
                const selectedDisplayId = `${phaseName.substring(0, 3)}-display-${level}`;
                const selectedElement = document.getElementById(selectedDisplayId);
                if (selectedElement) {
                    selectedElement.classList.add('highlighted-fee');
                }
                
                calculateForensicFees(); // Ricalcola i totali
            }
        }

        /**
         * Trova la fascia di compenso base per il valore della lite dato.
         */
        const getForensicFeeTier = (value) => {
            return FORENSIC_FEE_TABLE.find(tier => value >= tier.min && value <= tier.max) || null;
        }

        /**
         * Aggiorna tutti e tre i valori di compenso e ne evidenzia uno.
         */
        const updatePhaseDisplay = (phaseName, phaseFees, selectedLevel) => {
            const prefix = phaseName.substring(0, 3); 
            const levels = ['min', 'medium', 'max'];

            levels.forEach(level => {
                const displayId = `${prefix}-display-${level}`;
                const displayElement = document.getElementById(displayId);
                
                if (displayElement) {
                    // Rimuovi l'highlight da tutti
                    displayElement.classList.remove('highlighted-fee');

                    // Aggiorna il valore visualizzato
                    const valueSpan = displayElement.querySelector('.fee-value');
                    if (valueSpan) {
                        const feeKey = level === 'medium' ? 'medium' : level; // Assicurati di usare 'medium' come chiave
                        valueSpan.textContent = formatCurrency(phaseFees[feeKey]);
                    }
                }
            });

            // Applica l'highlight al valore selezionato
            const selectedDisplayId = `${prefix}-display-${selectedLevel}`;
            const selectedElement = document.getElementById(selectedDisplayId);
            if (selectedElement) {
                selectedElement.classList.add('highlighted-fee');
            }
        }


        /**
         * Calcola i compensi forensi e aggiorna l'interfaccia utente.
         */
        window.calculateForensicFees = () => { 
            const valueInput = document.getElementById('forensic-litigation-value');
            const alertDiv = document.getElementById('forensic-alert'); 
            const alertMsg = document.getElementById('alert-message');
            const forensicPrintValueEl = document.getElementById('forensic-print-value');
            const taxableLabelEl = document.getElementById('forensic-taxable-label');
            const increaseRowEl = document.getElementById('forensic-total-increase-row');
            const totalIncreaseEl = document.getElementById('forensic-total-increase');

            // Variabili per i risultati del calcolo, dichiarate con 'let' all'inizio
            let totalForfeit = 0;
            let totalCassa = 0;
            let totalIVA = 0;
            let totalIncrease = 0;
            let taxableBaseForTax = 0; // Base Imponibile per IVA e Cassa (Comp. Base + Forfettarie + Maggiorazione)


            // MODIFICATO: Accetta la virgola come separatore decimale
            const valueStr = valueInput.value.toLowerCase().trim();
            const rawValue = parseFloat(valueStr.replace(',', '.'));
            
            // Logica per determinare se il valore √® indeterminabile, nullo o numerico
            const isIndeterminabile = valueStr === 'indeterminabile';
            const litigationValue = isIndeterminabile || isNaN(rawValue) || rawValue < 0 ? 0 : rawValue; 
            
            const feeTier = getForensicFeeTier(litigationValue);
            
            // Variabili di livello selezionato (anche se il calcolo fallisce, manteniamo l'ultima selezione)
            const activationLevel = document.querySelector('input[name="activation-level"]:checked')?.value || 'medium';
            const negotiationLevel = document.querySelector('input[name="negotiation-level"]:checked')?.value || 'medium';
            const conciliationLevel = document.querySelector('input[name="conciliation-level"]:checked')?.value || 'medium';

            // Aggiornamento Valore Lite per la Stampa (App Avvocato)
            let printValueText = `Valore Lite: ${isIndeterminabile ? 'Indeterminabile (Non Calcolabile)' : (valueStr === '' ? 'Non specificato' : formatCurrency(litigationValue))}`;
            forensicPrintValueEl.innerHTML = `<p class="font-bold print-litigation-value border-b border-gray-300 pb-2">${printValueText}</p>`;
            
            
            // Gestione Fascia non Calcolabile o Valore Vuoto o Indeterminabile
            if (isIndeterminabile || !feeTier || valueInput.value.trim() === '' || litigationValue === 0) {
                
                document.getElementById('forensic-results').classList.remove('hidden');
                alertDiv.classList.add('hidden');
                const zeroFee = formatCurrency(0);

                if (isIndeterminabile) {
                     // Caso Indeterminabile (non calcolabile nell'app avvocato)
                     document.getElementById('forensic-results').classList.add('hidden');
                     alertDiv.classList.remove('hidden');
                     alertMsg.textContent = `Valore della lite "Indeterminabile" non calcolabile per i compensi tabellari (DM 55/2014). Inserire un valore numerico.`;
                }
                else if (litigationValue === 0 && valueStr !== '') {
                     // Caso Valore 0 (non calcolabile nell'app avvocato)
                     document.getElementById('forensic-results').classList.add('hidden');
                     alertDiv.classList.remove('hidden');
                     alertMsg.textContent = `Valore della lite pari a zero non calcolabile per i compensi tabellari (DM 55/2014). Inserire un valore numerico > 0.`;
                }
                else if (!feeTier && valueInput.value.trim() !== '') {
                    // Fuori fascia, MOSTRA l'alert
                    document.getElementById('forensic-results').classList.add('hidden');
                    alertDiv.classList.remove('hidden');
                    alertMsg.textContent = `Il valore della lite inserito (${formatCurrency(litigationValue)}) supera la fascia massima di calcolo predefinita (‚Ç¨${FORENSIC_FEE_TABLE[FORENSIC_FEE_TABLE.length - 1].max.toLocaleString('it-IT')}).`;
                }
                else if (valueInput.value.trim() === '') {
                    // Campo vuoto, nascondi l'alert e mostra i risultati a zero
                     document.getElementById('forensic-results').classList.remove('hidden');
                     alertDiv.classList.add('hidden');
                }
                
                // Resetta Maggiorazione e Imponibile
                increaseRowEl.classList.add('hidden');
                taxableLabelEl.textContent = `E. Imponibile IVA (A + B + C + D):`; // Etichetta di reset corretta

                // Resetta il riepilogo totale a 0,00 ‚Ç¨
                document.getElementById('forensic-total-final-cost').textContent = zeroFee;
                document.getElementById('forensic-total-base-fee').textContent = zeroFee;
                document.getElementById('forensic-total-taxable-base').textContent = zeroFee;
                document.getElementById('forensic-total-forfeit').textContent = zeroFee;
                document.getElementById('forensic-total-cassa').textContent = zeroFee;
                document.getElementById('forensic-total-iva').textContent = zeroFee;
                if (totalIncreaseEl) totalIncreaseEl.textContent = zeroFee;


                // Reset display delle fasi (necessario per campo vuoto/0 e fuori fascia)
                const phases = ['activation', 'negotiation', 'conciliation'];
                const levels = ['min', 'medium', 'max'];
                
                phases.forEach(phaseName => {
                    const prefix = phaseName.substring(0, 3);
                    levels.forEach(level => {
                        const displayElement = document.getElementById(`${prefix}-display-${level}`);
                        if (displayElement) {
                            // Mantieni l'highlight sul livello precedentemente selezionato
                            const isSelected = (phaseName === 'activation' && level === activationLevel) ||
                                               (phaseName === 'negotiation' && level === negotiationLevel) ||
                                               (phaseName === 'conciliation' && level === conciliationLevel);
                                               
                            displayElement.classList.toggle('highlighted-fee', isSelected);

                            // Imposta il valore a 0,00 ‚Ç¨
                            const valueSpan = displayElement.querySelector('.fee-value');
                            if (valueSpan) valueSpan.textContent = zeroFee;
                        }
                    });
                });
                
                return;
            } 
            // LOGICA DI CALCOLO NORMALE
            else {
                document.getElementById('forensic-results').classList.remove('hidden');
                alertDiv.classList.add('hidden');
            }
            
            // 2. Aggiorna l'interfaccia con tutti i valori e l'highlight
            updatePhaseDisplay('activation', feeTier.activation, activationLevel);
            updatePhaseDisplay('negotiation', feeTier.negotiation, negotiationLevel);
            updatePhaseDisplay('conciliation', feeTier.conciliation, conciliationLevel);
            
            // 3. Calcola il compenso base totale (somma dei tre valori selezionati)
            const activationFee = feeTier.activation[activationLevel];
            const negotiationFee = feeTier.negotiation[negotiationLevel];
            const conciliationFee = feeTier.conciliation[conciliationLevel];

            const totalBaseFee = activationFee + negotiationFee + conciliationFee;

            // 4. Aggiorna il display del compenso base totale
            document.getElementById('forensic-total-base-fee').textContent = formatCurrency(totalBaseFee);
            
            // =======================================================
            // 5. CALCOLI AGGIORNATI SECONDO LE TUE ISTRUZIONI
            // =======================================================

            // 5.1 Maggiorazione 30% esito positivo (B) (solo su Fase attivazione + negoziazione)
            const isIncreaseChecked = document.getElementById('cost-increase').checked;
            if (isIncreaseChecked) {
                 const increaseBase = activationFee + negotiationFee;
                 totalIncrease = increaseBase * FORENSIC_STATUTORY_COSTS.increase;
                 
                 increaseRowEl.classList.remove('hidden');
                 totalIncreaseEl.textContent = formatCurrency(totalIncrease);
            } else {
                 increaseRowEl.classList.add('hidden');
                 totalIncrease = 0;
                 totalIncreaseEl.textContent = formatCurrency(0);
            }
            
            // 5.2 Spese Forfettarie (C) (15% su A + B)
            // Base: Compenso Base (A) + Maggiorazione (B)
            const baseForForfeit = totalBaseFee + totalIncrease;
            const isForfeitChecked = document.getElementById('cost-forfeit').checked;
            if (isForfeitChecked) {
                totalForfeit = baseForForfeit * FORENSIC_STATUTORY_COSTS.forfeit;
            }
            document.getElementById('forensic-total-forfeit').textContent = formatCurrency(totalForfeit);
            
            // 5.3 Contributo Cassa (D) (4% su A + B + C)
            // Base: Compenso Base (A) + Maggiorazione (B) + Spese Forfettarie (C)
            const baseForCassa = totalBaseFee + totalIncrease + totalForfeit; 
            const isCassaChecked = document.getElementById('cost-cassa').checked;
            if (isCassaChecked) {
                totalCassa = baseForCassa * FORENSIC_STATUTORY_COSTS.cassa;
            }
            document.getElementById('forensic-total-cassa').textContent = formatCurrency(totalCassa);

            // 5.4 Base Imponibile IVA (E) = A + B + C + D
            taxableBaseForTax = totalBaseFee + totalIncrease + totalForfeit + totalCassa; 
            
            // Aggiorna il display della Base Imponibile
            document.getElementById('forensic-total-taxable-base').textContent = formatCurrency(taxableBaseForTax);

            // 5.5 IVA (F) (22% sulla Base Imponibile E)
            const isIVAChecked = document.getElementById('cost-iva').checked;
            if (isIVAChecked) {
                totalIVA = taxableBaseForTax * FORENSIC_STATUTORY_COSTS.iva;
            }
            document.getElementById('forensic-total-iva').textContent = formatCurrency(totalIVA);

            // 6. TOTALE FINALE (E + F)
            const totalFinalCost = taxableBaseForTax + totalIVA;
            document.getElementById('forensic-total-final-cost').textContent = formatCurrency(totalFinalCost);
        }

        // =========================================================================
        // --- FUNZIONE DI STAMPA GENERICA ---
        // =========================================================================

        /**
         * Cattura il contenuto di una sezione specificata e avvia la stampa 
         * utilizzando un iframe dinamico per isolare il contesto di stampa.
         * @param {string} sectionId L'ID della sezione da stampare (es. 'mediation-app').
         */
        window.printSection = (sectionId) => {
            const printContent = document.getElementById(sectionId);
            const legalNotes = document.getElementById('legal-notes-footer'); // Cattura il footer legale
            
            if (!printContent || !legalNotes) {
                console.error(`Sezione di stampa o Note Legali non trovate.`);
                return;
            }

            // Clona il contenuto per manipolarlo
            const contentToPrint = printContent.cloneNode(true);
            const legalNotesToPrint = legalNotes.cloneNode(true); // Clona il footer

            // 1. Rimuove gli elementi non necessari dalla stampa nel clone dell'app
            const elementsToRemove = contentToPrint.querySelectorAll('.print-hide, .print-button-container');
            elementsToRemove.forEach(el => el.remove());

            // 2. Rende visibile l'informazione sul valore lite per la stampa nel clone dell'app
            const printValueEl = contentToPrint.querySelector('.print-only');
            if (printValueEl) {
                printValueEl.classList.remove('print-only');
                // CORREZIONE: Rimosso il doppio .classList
                printValueEl.classList.add('print-litigation-value'); 
            }
            
            // 3. Clona anche il nuovo header integrato se presente (per contesto)
            const integratedHeader = document.getElementById('integrated-calculator-header');
            const integratedHeaderToPrint = integratedHeader ? integratedHeader.cloneNode(true).outerHTML : '';


            // 4. Costruisce il contenuto HTML completo per la stampa
            const appContentHTML = contentToPrint.outerHTML;
            const footerContentHtml = legalNotesToPrint.outerHTML; // Nome variabile corretto
            // La variabile usata nella stringa finale √® footerContentHTML (con H maiuscola) che non √® definita.
            // Uso footerContentHtml (con h minuscola) nella stringa finale.

            const printHTML = `
                ${integratedHeaderToPrint}
                <div class="print-content-wrapper" style="padding-top: 1rem;">
                    ${appContentHTML}
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
                        ${footerContentHtml}
                    </div>
                </div>
            `;
            
            // Ottiene gli stili CSS globali per la corretta formattazione
            const style = document.querySelector('style').innerHTML;
            
            const printWindow = window.open('', '', 'height=600,width=800');
            
            if (!printWindow) {
                // Necessario se il browser blocca i popup
                console.error("Impossibile aprire la finestra di stampa. Controllare le impostazioni di blocco dei popup.");
                return;
            }
            
            printWindow.document.write('<html><head><title>Stampa Calcolatore</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write(`<style>${style}</style>`);
            
            // Applica stili specifici per la visualizzazione della stampa nel nuovo body
            printWindow.document.write('</head><body class="print-container">');
            printWindow.document.write(printHTML); // Inietta il contenuto dell'app + note legali
            printWindow.document.write('</body></html>');
            printWindow.document.close(); 
            
            // Attende che l'iframe sia completamente pronto prima di stampare
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
                // NON chiudere immediatamente se si vuole permettere all'utente di salvare come PDF
                // printWindow.close();
            };
        }


        // =========================================================================
        // --- INIZIALIZZAZIONE ---
        // =========================================================================

        /**
         * Inizializza l'applicazione: Calcolo Iniziale.
         */
        const initApp = async () => {
            // Imposta lo stato iniziale dei radio button (Medio di default per l'app forense)
            const defaultLevel = 'medium';
            ['act', 'neg', 'con'].forEach(prefix => {
                const radioId = `${prefix}-${defaultLevel.substring(0, 3)}`;
                const radioElement = document.getElementById(radioId);
                if (radioElement) {
                    radioElement.checked = true;
                }
            });

            // Imposta lo stato iniziale del livello indeterminato (Medio di default)
            const indeterminateDefaultLevel = 'medio';
            const indeterminateRadio = document.getElementById(`ind-${indeterminateDefaultLevel}`);
            if (indeterminateRadio) {
                indeterminateRadio.checked = true;
            }

            // Imposta il tipo di valore lite a Determinabile di default e aggiorna l'UI
            const litigationTypeSelect = document.getElementById('litigation-value-type');
            if(litigationTypeSelect) {
                litigationTypeSelect.value = 'determinabile';
                window.updateValueInputType(); // Setta l'input per il valore numerico
            }
            
            // Esegue un calcolo iniziale per l'App Mediazione (che sincronizza l'input forense e triggera il calcolo forense)
            calculateMediationFees();
            
        };

        // Avvia l'app al caricamento completo della finestra
        window.onload = initApp;

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello di Controllo Spese Legali e Mediazione</title>
    <!-- Caricamento di Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Definizione del Font Inter e stili unificati -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Century+Schoolbook&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* NUOVI STILI PER SFONDO: Grigio chiaro con texture a rombi incrociati (discreta) */
            background-color: #f1f5f9; /* slate-100 */
            /* AGGIORNAMENTO: Pattern a rombi incrociati ANCORA PIÙ PICCOLI (modulo 4x4) */
            background-image: url("data:image/svg+xml,%3Csvg width='4' height='4' viewBox='0 0 4 4' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2394a3b8' fill-opacity='0.1'%3E%3Cpath d='M0 0h1v4H0zM3 0h1v4H3zM0 0h4v1H0zM0 3h4v1H0zM2 0v4M0 2h4'/%3E%3C/g%3E%3C/svg%3E");
        }
        .header-font {
            font-family: 'Century+Schoolbook', 'Georgia', serif;
        }
        /* Stile per nascondere le frecce sugli input di tipo number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Stili per il toggle (Oneri Fiscali - Tema Formale/Sobrio) */
        .toggle-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            cursor: pointer;
            user-select: none;
            gap: 0.25rem;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
        }

        .toggle-track {
            width: 2.5rem; 
            height: 1.1rem; 
            background-color: #94a3b8; /* slate-400 spento */
            border-radius: 9999px;
            position: relative;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .toggle-thumb {
            width: 0.9rem; 
            height: 0.9rem; 
            background-color: white;
            border-radius: 9999px;
            position: absolute;
            top: 0.1rem; 
            left: 0.1rem;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        /* Stato Checked per Toggle (Oneri Fiscali) - BLU NAVY */
        /* Mantenuto il blu navy per i toggle per un buon contrasto a schermo */
        #cost-forfeit:checked + .toggle-track, 
        #cost-cassa:checked + .toggle-track, 
        #cost-iva:checked + .toggle-track,
        #cost-increase:checked + .toggle-track,
        #ind-alto:checked + .toggle-track, 
        #ind-medio:checked + .toggle-track, 
        #ind-basso:checked + .toggle-track { 
            background-color: #1e3a8a; /* blue-900 / navy (accent-mediation) */
        }

        #cost-forfeit:checked + .toggle-track .toggle-thumb, 
        #cost-cassa:checked + .toggle-track .toggle-thumb, 
        #cost-iva:checked + .toggle-track .toggle-thumb,
        #cost-increase:checked + .toggle-track .toggle-thumb,
        #ind-alto:checked + .toggle-track .toggle-thumb,
        #ind-medio:checked + .toggle-track .toggle-thumb,
        #ind-basso:checked + .toggle-track .toggle-thumb { 
            transform: translateX(1.4rem); 
        }

        /* Stile per la colonna di calcolo per l'input - TEMA FORMALE (Grigio) */
        #forensic-calculator .input-group-style {
            background-color: #f1f5f9; /* slate-100 */
            border-color: #94a3b8; /* slate-400 */
        }
        
        /* Stili per il riquadro selezionabile (App Avvocato: TEMA NAVY/BLUE) */
        .fee-display-item {
            cursor: pointer; 
            padding: 0.4rem 0.2rem; 
            border-radius: 0.5rem; 
            transition: all 0.2s ease-in-out;
            border: 1px solid #e5e7eb; 
            background-color: #f9fafb; 
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }
        
        /* Uso accento Navy per hover e highlight su Avvocato */
        .fee-display-item:hover {
            border-color: #93c5fd; /* blue-300 */
            background-color: #f8fafc; /* slate-50 */
        }

        .highlighted-fee {
            background-color: #eff6ff; /* blue-50 */
            border-color: #1e3a8a; /* Navy */
            box-shadow: 0 0 5px rgba(30, 58, 138, 0.5); 
        }
        .highlighted-fee .fee-value {
            color: #1e3a8a; /* Navy */
            font-weight: 800; 
            font-size: 1.25rem; 
        }
        .highlighted-fee span:first-child {
             color: #1e3a8a; /* Navy */
        }
        
        .fee-display-item span:first-child {
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #4b5563; 
        }
        .fee-display-item .fee-value {
            font-size: 1.125rem; 
            font-weight: 700;
            color: #1f2937; 
        }

        /* NUOVI STILI PER LE CASSELLA RISULTATI MEDIAZIONE (mantengono i colori specifici per esito) */
        .fees-startup-box {
            border-color: #047857; /* emerald-700 */
            border-width: 2px; /* Aggiunto spessore */
        }
        .fees-startup-box .fee-value-color {
            color: #047857; /* emerald-700 */
        }
        
        .fees-negative-box {
            border-color: #334155; /* slate-700 */
            border-width: 2px; /* Aggiunto spessore */
        }
        .fees-negative-box .fee-value-color {
            color: #334155; /* slate-700 */
        }

        .fees-positive-1-box {
            border-color: #b45309; /* amber-800 */
            border-width: 2px; /* Aggiunto spessore */
        }
        .fees-positive-1-box .fee-value-color {
            color: #b45309; /* amber-800 */
        }

        .fees-positive-after-1-box {
            border-color: #b91c1c; /* red-700 (rosso mattone) */
            border-width: 2px; /* Aggiunto spessore */
        }
        .fees-positive-after-1-box .fee-value-color {
            color: #b91c1c; /* red-700 */
        }

        /* NUOVO STILE AZZURRO PALLIDO per contenitori di input */
        .input-box-highlight {
            background-color: #e0f2fe; /* sky-100 */
            border-color: #94a3b8; /* slate-400 per un bordo più scuro */
            border-width: 1px;
        }
        
        /* AGGIUNTO: Stile per le caselle di riepilogo totale (ora usano input-box-highlight + bordo nero) */
        .total-summary-box {
            background-color: #e0f2fe; /* sky-100 */
            border: 2px solid #1e293b; /* slate-800 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* AGGIUNTO: Stile per il testo nero sul riepilogo totale (titolo) */
        .total-summary-box .text-dark-title {
            color: #1e293b; /* slate-800 */
            border-color: #93c5fd; /* blue-300 */
        }
        /* AGGIUNTO: Stile per il TOTALE FINALE in Navy (per coerenza) */
        .total-summary-box .text-final-value {
             color: #1e3a8a; /* Navy */
             font-weight: 900;
        }


        .single-phase-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .phase-content-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr)); 
            gap: 0.5rem;
            align-items: center;
        }

        /* Stili per layout generale */
        #main-container {
            /* Flex layout per desktop, column per mobile */
            display: flex;
            flex-direction: column; 
            gap: 2rem;
            min-height: 100vh;
            padding: 1rem;
            max-width: 100%; /* Ensure it doesn't overflow */
        }

        .app-panel {
            /* Base styling for each panel */
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: white;
            flex-shrink: 0; /* Important for flex layout */
        }

        /* Header Container full width (Accentato in grigio scuro/antracite) */
        #full-width-header {
            width: 100%;
            padding: 1rem;
            background-color: #1e3a8a; /* NAVY */
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            /* Colore Antracite */
            border-top: 4px solid #1e3a8a; /* NAVY */
            border-bottom: 4px solid #1e3a8a; /* NAVY */
        }
        /* Testo all'interno dell'header in bianco */
        #full-width-header h1, #full-width-header p {
            color: white; 
        }
        /* Link all'interno dell'header in un colore chiaro */
        #full-width-header a {
            color: #93c5fd; /* blue-300 */
        }
        #full-width-header a:hover {
            color: #eff6ff; /* blue-50 */
        }

        /* NEW: Container for the two side-by-side apps */
        #apps-container {
            display: flex;
            flex-direction: column; 
            gap: 2rem;
            width: 100%;
        }

        /* MODIFICA: Stile per il Footer (full width) */
        #full-width-footer {
            width: 100%;
            padding-left: 1rem; 
            padding-right: 1rem; 
        }

        /* Stile aggiuntivo per giustificare il testo nel footer */
        .text-justify {
            text-align: justify;
            text-justify: inter-word;
        }

        /* === NUOVE REGOLE BLINK PER VALORI MEDI (Rimosse o Rese Neutrali per formalità) === */
        .blink-animation {
            /* Rimosso completamente lo stile dell'animazione per formalità, rimane solo la classe */
            animation: none; 
        }
        /* ======================================= */

        /* Nuove regole per la stampa */
        @media print {
            /* CSS per la stampa del contenuto dell'iframe dinamico */
            .print-container {
                font-family: 'Inter', sans-serif;
                color: #000;
                padding: 1rem;
                /* Nascondi gli elementi interattivi all'interno della sezione stampata */
                .print-hide {
                    display: none !important;
                }
                /* Assicura che i riquadri colorati siano ben visibili in stampa */
                /* Uniformati entrambi gli accenti al Navy per la stampa */
                /* Per la stampa, usiamo un'ombra più chiara o solo un bordo per risparmiare inchiostro */
                .bg-accent-mediation { background-color: #e0f2fe !important; color: #1e3a8a !important; border: 1px solid #1e3a8a !important; -webkit-print-color-adjust: exact; } /* sky-100 */
                .bg-accent-forensic { background-color: #e0f2fe !important; color: #1e3a8a !important; border: 1px solid #1e3a8a !important; -webkit-print-color-adjust: exact; } /* sky-100 */
                
                /* AGGIUNTO: Gestione colore caselle riepilogo totale in stampa */
                .total-summary-box { background-color: #e0f2fe !important; border: 1px solid #1e293b !important; -webkit-print-color-adjust: exact; }
                .total-summary-box .text-dark-title { color: #1e293b !important; border-color: #93c5fd !important; }
                .total-summary-box .text-final-value { color: #1e3a8a !important; }
                
                /* I pulsanti di stampa personalizzata usano il Navy: li rendiamo blu scuro ma senza sfondo pieno */
                .bg-slate-800 { background-color: #e0f2fe !important; color: #1e293b !important; border: 1px solid #1e293b !important; -webkit-print-color-adjust: exact; } /* slate-800 */
                .text-white { color: #1e3a8a !important; } /* Il testo bianco diventa Navy */
                .text-yellow-300 { color: #b45309 !important; } /* L'accento giallo diventa Amber scuro per contrasto */

                /* Stili per le caselle Mediazione in stampa */
                .fees-startup-box { border-color: #047857 !important; }
                .fees-startup-box .fee-value-color { color: #047857 !important; }
                .fees-negative-box { border-color: #334155 !important; }
                .fees-negative-box .fee-value-color { color: #334155 !important; }
                .fees-positive-1-box { border-color: #b45309 !important; }
                .fees-positive-1-box .fee-value-color { color: #b45309 !important; }
                .fees-positive-after-1-box { border-color: #b91c1c !important; }
                .fees-positive-after-1-box .fee-value-color { color: #b91c1c !important; }
                
                /* Fornisce contesto: Valore Lite */
                .print-litigation-value {
                    font-size: 1rem;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                }
                
                /* Stile per la riga di accettazione */
                .acceptance-line {
                    border-bottom: 1px solid #000; /* Linea orizzontale come firma */
                }
                .acceptance-text {
                    font-size: 0.8rem;
                    color: #4b5563; /* gray-600 */
                    margin-top: 1.5rem;
                    text-align: left;
                    font-style: italic;
                    line-height: 1.5;
                }
            }
        }


        @media (min-width: 1024px) { 
            #main-container {
                /* Changed to column to stack header above apps-container */
                flex-direction: column; 
                padding: 2rem;
            }
            #apps-container {
                /* This is the new flex container for the side-by-side layout */
                flex-direction: row; 
            }
            .app-panel {
                width: 50%; /* Equal width on desktop */
                max-width: none; 
            }
        }
        
        /* Stile per il Modal di personalizzazione */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        /* Stili di Modulazione Indeterminato (simulano i toggle) - NUOVO TEMA NAVY */
        #ind-alto:checked + .toggle-track, 
        #ind-medio:checked + .toggle-track, 
        #ind-basso:checked + .toggle-track {
            background-color: #1e3a8a; /* blue-900 */
        }

        #ind-alto:checked + .toggle-track .toggle-thumb,
        #ind-medio:checked + .toggle-track .toggle-thumb,
        #ind-basso:checked + .toggle-track .toggle-thumb {
            transform: translateX(1.4rem); 
        }
        
        /* AGGIUNTO: Regole di bordo per tutte le caselle bianche principali (App Avvocato) */
        .phase-box {
            border: 1px solid #94a3b8; /* slate-400 */
        }
        /* AGGIUNTO: Bordo scuro per il riquadro delle opzioni di calcolo */
        #forensic-app .p-3.bg-white.rounded-xl.shadow-md {
            border: 1px solid #94a3b8; /* slate-400 */
        }
        /* AGGIUNTO: Bordo scuro per il riquadro di Gruppo Input Valore Lite */
        #forensic-calculator.input-box-highlight {
            border-color: #94a3b8; /* slate-400 */
        }
        
        /* Stile per la nuova casella del calcolatore Art. 15 c.p.c. */
        #art15-calculator-box {
             background-color: white;
             padding: 1rem;
             border-radius: 1rem;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
             border: 2px solid #1e3a8a; /* Bordo Navy Scuro */
        }
        
        /* AGGIUNTO: Stile per le nuove Card Button (Art 15) - Default */
        .art15-card-button {
            border: 1px solid #94a3b8; /* Bordo grigio chiaro */
            background-color: white !important;
            color: #1f2937 !important; /* Testo nero/dark gray */
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }

        /* AGGIUNTO: Stile per le nuove Card Button (Art 15) - Selezionato */
        .art15-card-button.selected {
            background-color: #1e3a8a !important; /* Navy */
            color: white !important; /* Testo bianco */
            border: 2px solid #b91c1c !important; /* Bordo Rosso (red-700) per evidenziare */
            box-shadow: 0 0 8px rgba(185, 28, 28, 0.5); /* Ombra rossa leggera */
        }
        
        /* AGGIUNTO: Stile per i pulsanti Indeterminato Avvocato - Selezionato (Usa Navy) */
        .forensic-ind-button.selected {
            background-color: #1e3a8a !important; /* Navy */
            color: white !important; /* Testo bianco */
            border: 2px solid #1e3a8a !important; /* Bordo Navy */
            box-shadow: 0 0 8px rgba(30, 58, 138, 0.5); /* Ombra blu leggera */
        }
        
        /* PULSANTI DI RESET E SELECT PRECEDENTI RIMOSSI PER PULIZIA */
        /* PULSANTI DI RESET E SELECT PRECEDENTI RIMOSSI PER PULIZIA */
        /* PULSANTI DI RESET E SELECT PRECEDENTI RIMOSSI PER PULIZIA */

    </style>
    <script>
        // Configurazione Tailwind estesa per i colori del NUOVO TEMA (Navy e Gold)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent-mediation': {
                            50: '#f8fafc', /* slate-50 */
                            300: '#93c5fd', /* blue-300 */
                            // MODIFICATO PER RIDURRE IL CONSUMO DI INCHIOSTRO IN STAMPA
                            700: '#78909c', /* Blue-Gray 400 - Sostituisce il Navy nei blocchi pieni */
                            800: '#1e293b', /* slate-800 */
                            // COLORE DI ACCENTO NAVY ORIGINALE (USATO PER TESTO E BORDI SOLIDI)
                            'navy': '#1e3a8a', 
                        },
                        // Colori Fictitious per mantenere la struttura, ma saranno uniformati al mediation accent
                        'accent-forensic': { 
                            50: '#f8fafc', /* slate-50 */
                            300: '#93c5fd', /* blue-300 */
                            // MODIFICATO PER RIDURRE IL CONSUMO DI INCHIOSTRO IN STAMPA
                            700: '#78909c', /* Blue-Gray 400 - Sostituisce il Navy nei blocchi pieni */
                            800: '#1e293b', /* slate-800 */
                            // COLORE DI ACCENTO NAVY ORIGINALE (USATO PER TESTO E BORDI SOLIDI)
                            'navy': '#1e3a8a', 
                        },
                        // Colori specifici per le 4 caselle di Mediazione
                        'startup-fee-color': '#047857', /* Emerald 700 */
                        'negative-fee-color': '#334155', /* Slate 700 */
                        'positive-1-fee-color': '#b45309', /* Amber 800 */
                        'positive-after-1-fee-color': '#b91c1c', /* Red 700 */
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">

    <div id="main-container">
        
        <!-- SEZIONE: Intestazione a Tutta Larghezza -->
        <div id="full-width-header" class="text-center">
            <div class="flex flex-col items-center justify-center mb-4 border-b border-gray-200 pb-4">
                <div class="flex flex-wrap items-center justify-center gap-6 mb-3">
                    <!-- Logo -->
                    <img
                        src="https://logoccf.carrd.co/assets/images/image01.jpg?v=33becf42"
                        alt="Logo Camera di Media-Conciliazione Forense"
                        class="h-16 sm:h-20 w-auto object-contain rounded-lg shadow-md"
                        onerror="this.onerror=null; this.src='https://placehold.co/150x80/1e293b/ffffff?text=Logo+Non+Trovato';"
                    />
                </div>
                <div class="header-font">
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900 leading-tight">
                        <a href="https://www.conciliazioneforense.it/" target="_blank" class="text-gray-900 hover:text-accent-mediation-700 hover:underline transition duration-150 ease-in-out">
                            COORDINAMENTO DELLA CONCILIAZIONE FORENSE
                        </a>
                    </h1>
                    <p class="text-xs sm:text-sm text-gray-600 mt-1 max-w-full mx-auto">
                        Sede legale presso la Fondazione Forense di Milano, in Via Freguglia n. 1, 20122 Milano. Tel.025492921. Email: <a href="mailto:info@conciliazioneforense.it" class="text-accent-mediation-700 hover:underline">info@conciliazioneforense.it</a> | PEC: <a href="mailto:conciliazioneforense@legalmail.it" class="text-accent-mediation-700 hover:underline">conciliazioneforense@legalmail.it</a>
                    </p>
                    <!-- NUOVA RIGA AGGIUNTA QUI -->
                    <p class="text-xs sm:text-sm text-gray-600 max-w-full mx-auto mt-1">
                        <a href="https://www.conciliazioneforense.it/ordini-e-organismi-associati" target="_blank" class="text-accent-mediation-700 hover:underline font-semibold">
                            ORDINI E ORGANISMI ASSOCIATI
                        </a>
                    </p>
                </div>
            </div>
        </div>
        <!-- FINE SEZIONE INTESTAZIONE -->

        <!-- CASELLA CALCOLATORE INTEGRATO (STRISCIE BLU CHIARO) -->
        <!-- Bordo superiore e inferiore di colore slate-800 per uniformità -->
        <div id="integrated-calculator-header" class="w-full text-center p-1 bg-white border-t-4 border-slate-800 border-b-4 shadow-md">
            <h2 class="text-base sm:text-3xl font-extrabold text-gray-1500 leading-snug">
                CALCOLATORE INTEGRATO VALORE - SPESE - INDENNITA' DI MEDIAZIONE E COMPENSI AVVOCATO
            </h2>
        </div>
        <!-- FINE NUOVA CASELLA -->

        <!-- NUOVA CASSELLA: Calcolatore Art. 15 c.p.c. (Aggiunta) -->
        <div id="art15-calculator-box" class="print-hide">
            
             <h2 class="text-xl sm:text-2xl font-extrabold text-accent-mediation-navy text-center mb-2 flex items-center justify-center border-b border-accent-mediation-300 pb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 text-accent-mediation-navy"><path d="M12 2v20M17 5H7M17 19H7"/></svg>
                Calcolatore Valore Lite Beni Immobili (Art. 15 c.p.c.)
            </h2>
            
            <!-- NUOVA RIGA RICHIESTA -->
            <p class="text-sm text-gray-600 text-center mb-4 font-medium italic">
                Per il valore della lite relativa a tutte le altre mediazioni passare direttamente alle tabelle sottostanti.
            </p>
            <!-- FINE NUOVA RIGA RICHIESTA -->

            <!-- Testo esplicativo Art. 15 c.p.c. -->
            <div class="mt-1 mb-4 text-xs text-gray-700 space-y-1 italic p-2 bg-gray-50 rounded-lg border border-gray-200">
                <p>
                    <strong>Art. 15 c.p.c.</strong> Il valore delle cause relative a beni immobili [812 c.c.] è determinato moltiplicando il reddito dominicale del terreno e la rendita catastale del fabbricato alla data della proposizione della domanda: per duecento per le cause relative alla proprietà [832 c.c.]; per cento per le cause relative all'usufrutto [978 c.c.], all'uso [1021 c.c.], all'abitazione [1022 c.c.], alla nuda proprietà e al diritto dell'enfiteuta [959 c.p.c.]; per cinquanta con riferimento al fondo servente per le cause relative alla servitù [1027 c.p.c.].Il valore delle cause per il regolamento di confini [950 c.c.] si desume dal valore della parte di proprietà controversa, se questa è determinata; altrimenti il giudice lo determina a norma del comma seguente.Se per l'immobile all'atto della proposizione della domanda non risulta il reddito dominicale o la rendita catastale, il giudice determina il valore della causa secondo quanto emerge dagli atti; e se questi non offrono elementi per la stima, ritiene la causa di valore indeterminabile
                </p>
            </div>

            <!-- Selezione Tipo Diritto (MODIFICATO IN CARD BUTTONS) -->
            <fieldset class="mb-4">
                <legend class="block text-base font-bold text-gray-700 mb-2">1. Seleziona il tipo di diritto:</legend>
                
                <div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap gap-2 sm:items-center">
                    
                    <!-- Pulsanti Card per la selezione -->
                    <div 
                        id="art15-prop-btn" 
                        class="art15-card-button flex-grow selected" 
                        data-multiplier="200"
                        onclick="selectArt15Multiplier(this, 200)">
                        Proprietà (x200)
                    </div>
                    
                    <div 
                        id="art15-usufrutto-btn" 
                        class="art15-card-button flex-grow" 
                        data-multiplier="100"
                        onclick="selectArt15Multiplier(this, 100)">
                        Usufrutto, Uso, Abitazione, Nuda Proprietà, Enfiteusi (x100)
                    </div>

                    <div 
                        id="art15-servitu-btn" 
                        class="art15-card-button flex-grow" 
                        data-multiplier="50"
                        onclick="selectArt15Multiplier(this, 50)">
                        Servitù (x50)
                    </div>

                    <!-- Pulsante Reset (RIMOSSO DA QUI) -->
                    <!-- 
                    <div class="w-full sm:w-auto pt-2 sm:pt-0">
                        <button id="art15-resetButton" 
                                class="flex items-center justify-center w-full sm:w-auto px-4 py-2 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out font-medium text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 2v6h6M3 6h18M21 22v-6h-6M21 18H3"/><path d="M22 8a10 10 0 1 0-2.82 7.18"/></svg>
                            Reset
                        </button>
                    </div>
                     -->
                </div>
            </fieldset>

            <!-- Contenitore per le 4 sottocaselle -->
            <fieldset class="mb-4">
                <legend class="block text-base font-bold text-gray-700 mb-2">2. Inserisci i valori di Reddito Dominicale/Rendita Catastale:</legend>
                
                <!-- Utilizza una griglia: 1 colonna su mobile, 2 su sm, 4 su md -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2">

                    <!-- Sottocasella 1 -->
                    <div class="bg-white border border-gray-300 rounded-lg p-2 shadow-sm">
                        <!-- Etichetta per la sottocasella -->
                        <label for="art15-valore1" class="block text-[11px] font-medium text-gray-700 mb-1 whitespace-nowrap overflow-hidden text-ellipsis">
                            RENDITA CATASTALE / REDDITO DOMINICALE (€)
                        </label>
                        <!-- Campo di inserimento -->
                        <input type="text" id="art15-valore1" name="art15-valore1"
                               inputmode="decimal"
                               placeholder="Valore €"
                               oninput="calcolaArt15Mediazione()"
                               class="w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm text-gray-900 focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm">
                    </div>

                    <!-- Sottocasella 2 -->
                    <div class="bg-white border border-gray-300 rounded-lg p-2 shadow-sm">
                        <label for="art15-valore2" class="block text-[11px] font-medium text-gray-700 mb-1 whitespace-nowrap overflow-hidden text-ellipsis">
                            RENDITA CATASTALE / REDDITO DOMINICALE (€)
                        </label>
                        <input type="text" id="art15-valore2" name="art15-valore2"
                               inputmode="decimal"
                               placeholder="Valore €"
                               oninput="calcolaArt15Mediazione()"
                               class="w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm text-gray-900 focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm">
                    </div>

                    <!-- Sottocasella 3 -->
                    <div class="bg-white border border-gray-300 rounded-lg p-2 shadow-sm">
                        <label for="art15-valore3" class="block text-[11px] font-medium text-gray-700 mb-1 whitespace-nowrap overflow-hidden text-ellipsis">
                            RENDITA CATASTALE / REDDITO DOMINICALE (€)
                        </label>
                        <input type="text" id="art15-valore3" name="art15-valore3"
                               inputmode="decimal"
                               placeholder="Valore €"
                               oninput="calcolaArt15Mediazione()"
                               class="w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm text-gray-900 focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm">
                    </div>

                    <!-- Sottocasella 4 -->
                    <div class="bg-white border border-gray-300 rounded-lg p-2 shadow-sm">
                        <label for="art15-valore4" class="block text-[11px] font-medium text-gray-700 mb-1 whitespace-nowrap overflow-hidden text-ellipsis">
                            RENDITA CATASTALE / REDDITO DOMINICALE (€)
                        </label>
                        <input type="text" id="art15-valore4" name="art15-valore4"
                               inputmode="decimal"
                               placeholder="Valore €"
                               oninput="calcolaArt15Mediazione()"
                               class="w-full px-3 py-1 border border-gray-300 rounded-md shadow-sm text-gray-900 focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm">
                    </div>

                </div>
            </fieldset>
            <!-- Fine della griglia delle sottocaselle -->
            
            <!-- Spiegazione Valore Finale -->
            <div class="mb-4 text-xs text-gray-600 italic">
                <p>
                    Il valore risultante qui sotto (Art. 15 c.p.c.) è automaticamente copiato nel campo "Valore della Lite (€)" delle sezioni Calcolatore Spese Mediazione e Calcolatore Compensi Avvocato.
                </p>
            </div>

            <!-- Sezione Risultato Mediazione -->
            <!-- MODIFICATO: Aggiunto flex-col sm:flex-row gap-2 items-stretch -->
            <div class="mt-3 flex flex-col sm:flex-row gap-2 items-stretch">
                <!-- MODIFICATO: Aggiunto flex-grow per farla accorciare -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex flex-col sm:flex-row justify-between items-start sm:items-center total-summary-box border-slate-800 flex-grow">
                    <!-- Etichetta -->
                    <h2 class="text-lg font-black text-dark-title mb-1 sm:mb-0">
                        VALORE LITE (Art. 15 c.p.c.)
                    </h2>
                    <!-- Valore Calcolato -->
                    <div class="text-2xl sm:text-3xl font-black text-final-value">
                        <span id="art15-risultatoMediazione" class="mr-1">0,00</span>
                        <span>€</span>
                    </div>
                </div>
                
                <!-- PULSANTE RESET (SPOSTATO QUI) -->
                <button id="art15-resetButton" 
                        class="flex-shrink-0 flex items-center justify-center w-full sm:w-auto px-4 py-2 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out font-medium text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 2v6h6M3 6h18M21 22v-6h-6M21 18H3"/><path d="M22 8a10 10 0 1 0-2.82 7.18"/></svg>
                    Reset
                </button>
            </div>
            
            <!-- Rimosso il contenitore dei pulsanti d'azione (compresi Copia Valore e Reset) -->
            <!-- Placeholder per messaggi di copia (rimosso) -->
            <div id="art15-messageBox" class="hidden"></div>
        </div>
        <!-- FINE NUOVA CASSELLA CALCOLATORE ART 15 CPC -->


        <!-- CONTENITORE PRINCIPALE DELLE APP AFFIANCATE -->
        <div id="apps-container" class="lg:flex">
            
            <!-- PARTE SINISTRA: Spese di Mediazione - TEMA BLU SCURO (NAVY) -->
            <!-- MODIFICATO: border-t-8 border-accent-mediation-700 -> border-t-8 border-accent-mediation-navy -->
            <div id="mediation-app" class="app-panel border-t-8 border-accent-mediation-navy">
                
                <h2 class="text-2xl font-extrabold text-gray-800 text-center mb-6 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 h-6 w-6 text-gray-400"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg> Calcolatore Spese di Mediazione
                </h2>

                <!-- Contenitore Calcolatore Mediazione -->
                <div class="flex flex-col gap-6">
                    
                    <div id="mediation-calculator" class="space-y-4">
                        <!-- Qui usiamo il colore NAVY originale per il testo, tramite il colore accent-mediation-navy -->
                        <h2 id="tariff-title" class="text-xl sm:text-2xl font-extrabold text-accent-mediation-navy text-center flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 text-accent-mediation-navy"><path d="M12 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h7"/><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg> Spese di Mediazione - Valori Minimi
                        </h2>
                        <!-- MODIFICA: Inserito D.LGS. 28/2010 e DM 150/2023 in un unico blocco centrato -->
                        <p class="text-sm text-gray-500 text-center -mt-2 space-x-4">
                            <!-- D.LGS. 28/2010 -->
                            <a 
                                href="https://www.ordineavvocati.ss.it/docs/mediazione_Dlgs28-2010_consolidato_col_Dlgs_216-2024_579486312.pdf" 
                                target="_blank" 
                                class="text-accent-mediation-navy hover:underline font-semibold"
                            >
                                D.LGS. 28/2010
                            </a>
                            <!-- DM 150/2023 -->
                            <a 
                                href="https://www.ordineavvocati.ss.it/docs/mediazione_DM_150_2023_Gazzetta-Ufficiale-69854763215.pdf" 
                                target="_blank" 
                                class="text-accent-mediation-navy hover:underline font-semibold"
                            >
                                DM 150/2023
                            </a>
                        </p>

                        <!-- Gruppo Input Mediazione (Livello Tariffario, Tipo, Valore Lite) -->
                        <!-- AGGIUNTO: border border-slate-400 (per coerenza) -->
                        <div class="space-y-3 p-3 rounded-lg shadow-inner print-hide input-box-highlight border border-slate-400">
                            <div>
                                <label for="mediation-tariff-level" class="block text-gray-700 font-bold mb-1 text-sm">Livello Tariffario:</label>
                                <select
                                    id="mediation-tariff-level"
                                    onchange="calculateMediationFees()"
                                    class="w-full p-2 border border-accent-mediation-300 rounded-lg shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy transition duration-150 ease-in-out font-medium bg-white"
                                >
                                    <option value="minimi">Valori Minimi</option>
                                    <option value="medi">Valori Medi</option>
                                </select>
                            </div>
                            <div>
                                <label for="mediation-type" class="block text-gray-700 font-bold mb-1 text-sm">Tipo di Mediazione:</label>
                                <select
                                    id="mediation-type"
                                    onchange="calculateMediationFees()"
                                    class="w-full p-2 border border-accent-mediation-300 rounded-lg shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy transition duration-150 ease-in-out font-medium bg-white"
                                >
                                    <option value="obbligatorie">Mediazioni obbligatorie o demandate (80% tariffa)</option>
                                    <option value="volontarie">Mediazioni volontarie (100% tariffa)</option>
                                </select>
                            </div>
                            <!-- NUOVO SELECT PER TIPO VALORE LITE -->
                            <div>
                                <label for="litigation-value-type" class="block text-gray-700 font-bold mb-1 text-sm">Tipo Valore Lite:</label>
                                <select
                                    id="litigation-value-type"
                                    onchange="updateValueInputType(); calculateMediationFees();"
                                    class="w-full p-2 border border-accent-mediation-300 rounded-lg shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy transition duration-150 ease-in-out font-medium bg-white"
                                >
                                    <option value="determinabile">Determinabile (€)</option>
                                    <option value="indeterminabile">Indeterminabile</option>
                                </select>
                            </div>
                            <div>
                                <label for="mediation-litigation-value" class="block text-sm font-bold text-gray-700 mb-1">Valore della Lite (€):</label>
                                <input
                                    id="mediation-litigation-value"
                                    type="text"
                                    oninput="calculateMediationFees()"
                                    class="w-full p-2 border border-accent-mediation-300 rounded-lg shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy transition duration-150 ease-in-out text-base font-semibold"
                                    placeholder="es. 15000"
                                />
                            </div>
                        </div>
                        
                        <!-- NUOVA CASELLA PER VALORE INDETERMINATO (Colorata) -->
                        <!-- AGGIUNTO: border border-slate-400 (per coerenza) -->
                        <div id="indeterminate-value-options" class="p-3 rounded-lg shadow-inner border print-hide hidden input-box-highlight border-slate-400">
                            <h3 class="text-sm font-bold text-accent-mediation-navy mb-3 border-b border-accent-mediation-300 pb-1 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-accent-mediation-navy"><path d="M10.45 6.03a6.68 6.68 0 0 1 3.1 0"/><path d="M12 20V4"/><path d="M3 18c0-5 2-8 7-8"/><path d="M14 10c5 0 7 3 7 8"/></svg> Modulazione Valore Indeterminato
                            </h3>
                            
                            <div class="flex flex-wrap justify-between items-center gap-x-3 gap-y-1 text-xs sm:text-sm">
                                
                                <!-- Alto -->
                                <div class="toggle-container">
                                    <span class="text-gray-800 font-medium"> Alto</span>
                                    <input type="radio" id="ind-alto" name="indeterminato-level" value="alto" onchange="calculateMediationFees()" class="hidden">
                                    <label for="ind-alto" class="toggle-track toggle-switch">
                                        <div class="toggle-thumb" style="transition: transform 0.2s, background-color 0.2s;"></div>
                                    </label>
                                </div>
                                <!-- Medio (Default/Baseline) -->
                                <div class="toggle-container">
                                    <span class="text-gray-800 font-medium">Medio</span>
                                    <input type="radio" id="ind-medio" name="indeterminato-level" value="medio" checked onchange="calculateMediationFees()" class="hidden">
                                    <label for="ind-medio" class="toggle-track toggle-switch">
                                        <div class="toggle-thumb" style="transition: transform 0.2s, background-color 0.2s;"></div>
                                    </label>
                                </div>

                                <!-- Basso -->
                                <div class="toggle-container">
                                    <span class="text-gray-800 font-medium">Basso</span>
                                    <input type="radio" id="ind-basso" name="indeterminato-level" value="basso" onchange="calculateMediationFees()" class="hidden">
                                    <label for="ind-basso" class="toggle-track toggle-switch">
                                        <div class="toggle-thumb" style="transition: transform 0.2s, background-color 0.2s;"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alert Mediazione -->
                        <div id="mediation-alert" class="hidden bg-yellow-100 p-3 rounded-lg border-l-4 border-yellow-500 text-yellow-800 text-sm font-medium"></div>

                        <!-- VALORE LITE PER LA STAMPA (AGGIUNTO) -->
                        <div class="print-only text-base mb-4" id="mediation-print-value"></div>
                        
                        <!-- Griglia Risultati Mediazione -->
                        <div class="grid grid-cols-2 gap-3">
                            <!-- 1. Spese di Avvio -->
                            <!-- Applicate classi personalizzate per bordo e colore del testo valore -->
                            <div class="bg-white p-3 rounded-lg shadow-md border-2 fees-startup-box">
                                <h3 class="text-sm font-semibold text-gray-700 mb-1">Spese Fisse:</h3>
                                <!-- Aggiunta classe fee-value-color per colore dinamico -->
                                <p id="fees-startup" class="text-xl font-extrabold fee-value-color">0,00 €</p>
                                
                                <!-- NUOVA CASELLA BREAKDOWN con Dettaglio IVA -->
                                <div class="mt-2 pt-2 border-t border-gray-200 bg-gray-50 p-2 rounded-md text-xs space-y-2">
                                    <!-- Dettaglio Spese Avvio -->
                                    <div>
                                        <div class="flex justify-between items-center font-bold">
                                            <span class="text-gray-700">Spese Avvio:</span>
                                            <span id="fees-startup-breakdown-avvio" class="text-gray-900">0,00 €</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>Imponibile:</span>
                                            <span id="fees-startup-breakdown-avvio-imponibile">0,00 €</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>IVA 22%:</span>
                                            <span id="fees-startup-breakdown-avvio-iva" class="text-gray-900">0,00 €</span>
                                        </div>
                                    </div>
                                    <!-- Dettaglio Indennità 1° Incontro -->
                                    <div class="pt-2 border-t border-gray-200">
                                        <div class="flex justify-between items-center font-bold">
                                            <span class="text-gray-700">Indennità 1° Incontro:</span>
                                            <span id="fees-startup-breakdown-indennita" class="text-gray-900">0,00 €</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>Imponibile:</span>
                                            <span id="fees-startup-breakdown-indennita-imponibile" class="text-gray-900">0,00 €</span>
                                        </div>
                                        <div class="flex justify-between items-center text-gray-600 pl-2">
                                            <span>IVA 22%:</span>
                                            <span id="fees-startup-breakdown-indennita-iva" class="text-gray-900">0,00 €</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-sm text-gray-600 mt-2 space-y-0.5">
                                    <p>Imponibile: <span id="fees-startup-imponibile" class="font-medium">0,00 €</span></p>
                                    <p>IVA 22%: <span id="fees-startup-iva" class="font-medium">0,00 €</span></p>
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Dovute al deposito della domanda e dell'adesione)</p>
                                </div>
                            </div>

                            <!-- 2. Esito Negativo dopo 1° incontro -->
                            <div class="bg-white p-3 rounded-lg shadow-md border-2 fees-negative-box">
                                <h3 class="text-sm font-semibold text-gray-700 mb-1">Spese per esito negativo dopo 1° incontro:</h3>
                                <p id="fees-negative" class="text-xl font-extrabold fee-value-color">0,00 €</p>
                                <div class="text-sm text-gray-600 mt-1 space-y-0.5">
                                    <p>Imponibile: <span id="fees-negative-imponibile" class="font-medium">0,00 €</span></p>
                                    <p>IVA 22%: <span id="fees-negative-iva" class="font-medium">0,00 €</span></p>
                                    <!-- Nuova riga aggiunta qui sotto l'IVA 22% -->
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Dovute dopo il 1° incontro non conclusivo)</p> 
                                </div>
                            </div>
                            
                            <!-- 3. Esito Positivo al 1° -->
                            <div class="bg-white p-3 rounded-lg shadow-md border-2 fees-positive-1-box">
                                <h3 class="text-sm font-semibold text-gray-700 mb-1">Spese per esito positivo 1° incontro:</h3>
                                <p id="fees-positive-1" class="text-xl font-extrabold fee-value-color">0,00 €</p>
                                <div class="text-sm text-gray-600 mt-1 space-y-0.5">
                                    <p>Imponibile: <span id="fees-positive-1-imponibile" class="font-medium">0,00 €</span></p>
                                    <p>IVA 22%: <span id="fees-positive-1-iva" class="font-medium">0,00 €</span></p>
                                    <!-- AGGIUNTA NUOVA RIGA QUI -->
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Conciliazione al primo incontro)</p>
                                </div>
                            </div>

                            <!-- 4. Esito Positivo dopo il 1° -->
                            <div class="bg-white p-3 rounded-lg shadow-md border-2 fees-positive-after-1-box">
                                <h3 class="text-sm font-semibold text-gray-700 mb-1">Spese per esito positivo dopo 1° incontro:</h3>
                                <p id="fees-positive-after-1" class="text-xl font-extrabold fee-value-color">0,00 €</p>
                                <div class="text-sm text-gray-600 mt-1 space-y-0.5">
                                    <p>Imponibile: <span id="fees-positive-after-1-imponibile" class="font-medium">0,00 €</span></p>
                                    <p>IVA 22%: <span id="fees-positive-after-1-iva" class="font-medium">0,00 €</span></p>
                                    <!-- AGGIUNTA NUOVA RIGA QUI -->
                                    <p class="text-xs text-gray-500 font-medium pt-1 border-t border-gray-100 text-left">(Conciliazione dopo il primo incontro)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Riepilogo Totale Mediazione (AZZURRO PALLIDO + BORDO NERO/NAVY) -->
                        <!-- Modificato bg-accent-mediation-700, text-white in classi custom total-summary-box e text-dark-title -->
                        <div class="total-summary-box p-4 rounded-xl shadow-xl mt-4">
                            <h3 class="text-sm font-bold text-center mb-3 text-dark-title border-b border-accent-mediation-300 pb-2">
                                Costo Totale Mediazione (Avvio + Spese)
                            </h3>
                            <!-- Modifica qui: da grid-cols-3 a grid-cols-4 -->
                            <div class="grid grid-cols-4 gap-2 text-center text-sm text-gray-900"> 
                                <!-- NUOVA CASELLA: Negativo 1° incontro (Solo Spese di Avvio) -->
                                <div class="text-gray-900">
                                    <p class="text-xs font-light opacity-90">Negativo 1° incontro</p>
                                    <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                    <p id="total-startup" class="text-xl font-extrabold text-final-value">0,00 €</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-startup-imponibile" class="font-medium">0,00 €</span></p>
                                        <p>IVA 22%: <span id="total-startup-iva" class="font-medium">0,00 €</span></p>
                                    </div>
                                </div>

                                <!-- Vecchia Negativo dopo 1° incontro (ora è la 2a colonna) -->
                                <div class="border-x border-accent-mediation-300 pr-2 text-gray-900">
                                    <p class="text-xs font-light opacity-90">Negativo dopo 1° incontro</p>
                                     <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                    <p id="total-negative" class="text-xl font-extrabold text-final-value">0,00 €</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-negative-imponibile" class="font-medium">0,00 €</span></p>
                                        <p>IVA 22%: <span id="total-negative-iva" class="font-medium">0,00 €</span></p>
                                    </div>
                                </div>
                                
                                <!-- Vecchia Positivo al 1° incontro (ora è la 3a colonna) -->
                                <div class="text-gray-900">
                                    <p class="text-xs font-light opacity-90">Positivo al 1° incontro</p>
                                     <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                    <p id="total-positive-1" class="text-xl font-extrabold text-final-value">0,00 €</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-positive-1-imponibile" class="font-medium">0,00 €</span></p>
                                        <p>IVA 22%: <span id="total-positive-1-iva" class="font-medium">0,00 €</span></p>
                                    </div>
                                </div>
                                
                                <!-- Vecchia Positivo dopo 1° incontro (ora è la 4a colonna) -->
                                <div class="border-l border-accent-mediation-300 pl-2 text-gray-900">
                                    <p class="text-xs font-light opacity-90">Positivo dopo 1° incontro</p>
                                     <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                    <p id="total-positive-after-1" class="text-xl font-extrabold text-final-value">0,00 €</p>
                                    <div class="text-xs font-light mt-2 space-y-0.5">
                                        <p>Imponibile: <span id="total-positive-after-1-imponibile" class="font-medium">0,00 €</span></p>
                                        <p>IVA 22%: <span id="total-positive-after-1-iva" class="font-medium">0,00 €</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NUOVO BLOCCO: Procedimento di Mediazione n. / (Colorato) -->
                    <!-- AGGIUNTO: border border-slate-400 (per coerenza) -->
                    <div class="flex items-center justify-center gap-2 p-2 rounded-lg border print-hide input-box-highlight border-slate-400">
                        <span>Procedimento di Mediazione n.</span>
                        <input 
                            type="number" 
                            id="mediation-number-1" 
                            class="w-16 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-bold"
                            placeholder="00"
                        />
                        <span>/</span>
                        <input 
                            type="number" 
                            id="mediation-number-2" 
                            class="w-20 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-bold"
                            placeholder="2025"
                        />
                    </div>
                    <!-- FINE NUOVO BLOCCO -->
                    
                    <!-- NUOVA RIGA: Per accettazione, salvo diversa determinazione del valore da parte del Responsabile -->
                    <div class="p-2 pt-0 print-hide">
                        <div class="text-xs text-gray-600 italic text-justify">
                            Per accettazione, salvo diversa determinazione del valore da parte del Responsabile
                            <div class="w-full h-px bg-gray-400 mt-10"></div> <!-- SPAZIO AUMENTATO -->
                        </div>
                    </div>
                    <!-- FINE NUOVA RIGA -->
                    
                    <!-- NUOVA CASELLA LUOGO E DATA MEDIAZIONE (Sinistra) (Colorata) -->
                    <!-- AGGIUNTO: border border-slate-400 (per coerenza) -->
                    <div class="flex items-center justify-center gap-4 p-2 rounded-lg border print-hide input-box-highlight border-slate-400">
                        <div class="flex items-center gap-2">
                            <span>Luogo:</span>
                            <input 
                                type="text" 
                                id="mediation-location" 
                                class="w-24 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-medium"
                                placeholder="Città"
                            />
                        </div>
                        <div class="flex items-center gap-2">
                            <span>Data:</span>
                            <input 
                                type="text" 
                                id="mediation-date" 
                                class="w-24 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-medium"
                                placeholder="gg/mm/aaaa"
                            />
                        </div>
                    </div>
                    <!-- FINE NUOVA CASELLA LUOGO E DATA -->

                    <!-- NUOVO CONTENITORE PULSANTI DI STAMPA MEDIAZIONE (Modificato) -->
                    <div class="print-button-container flex flex-col sm:flex-row justify-center items-center gap-3 mt-2">
                         <!-- Tasto Stampa Standard (NAVY) -->
                         <!-- Modificato colore di sfondo a navy per mantenerlo scuro a schermo -->
                         <button 
                            onclick="printSection('mediation-app')" 
                            class="flex items-center justify-center bg-accent-mediation-navy hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-accent-mediation-300 text-sm"
                         >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> 
                            Stampa Sezione Mediazione
                        </button>
                        <!-- Tasto Stampa Personalizzata Organismo (ANTRACHITE) -->
                         <button 
                            onclick="openMediationCustomPrintModal()" 
                            class="flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-slate-300 text-sm"
                         >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5"/><path d="M18 10a6 6 0 0 0-9.37 0"/></svg>
                            Stampa Personalizzata Organismo
                        </button>
                    </div>

                    <!-- FOOTER RIMOSSO DA QUI e spostato alla fine del #main-container -->
                </div>
            </div>
            
            <!-- PARTE DESTRA: Spese Legali - TEMA UNIFICATO BLU CHIARO -->
            <!-- MODIFICATO: border-t-8 border-accent-mediation-700 -> border-t-8 border-accent-mediation-navy -->
            <div id="forensic-app" class="app-panel border-t-8 border-accent-mediation-navy">
                <!-- Contenuto dell'app "Spese Legali Blu" -->
                
                <!-- Qui usiamo il colore NAVY originale per il testo, tramite il colore accent-mediation-navy -->
                <h2 class="text-2xl font-extrabold text-accent-mediation-navy text-center mb-6 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-accent-mediation-navy"><path d="m16 16-3-3m0 0 3-3m-3 3h3"/></svg> Calcolatore Compensi Avvocato
                </h2>
                <p class="text-sm text-gray-500 text-center -mt-2 mb-4">DM 55/2014 - Valori tabellari (Mediazione).</p>

                <!-- Gruppo Input Valore Lite (Colorato) -->
                <!-- AGGIUNTO: border-slate-400 (per coerenza con input-box-highlight) -->
                <div id="forensic-calculator" class="space-y-2 p-3 input-group-style rounded-xl shadow-inner print-hide input-box-highlight border border-slate-400">
                    <div>
                        <label for="forensic-litigation-value" class="block text-gray-700 font-bold text-base mb-1">Valore della Lite (€):</label>
                        <input
                            id="forensic-litigation-value"
                            type="text"
                            oninput="calculateForensicFees()"
                            class="w-full p-2 border border-accent-mediation-300 rounded-lg shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy transition duration-150 ease-in-out text-base font-semibold bg-white"
                            placeholder="es. 15000 o Indeterminabile"
                            value="" 
                        />
                    </div>
                </div>

                <!-- NUOVO BLOCCO VALORE INDETERMINABILE AVVOCATO (INSERITO QUI) -->
                <div id="forensic-indeterminate-box" class="mt-4 p-3 input-box-highlight rounded-xl shadow-inner print-hide border border-slate-400">
                    <fieldset>
                        <legend class="block text-base font-bold text-gray-700 mb-2">Gestione Valore Indeterminabile (Avvocato):</legend>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            
                            <!-- Uso la classe base art15-card-button per lo stile, e forensic-ind-button per la logica JS -->
                            <div id="forensic-ind-bassa-btn" 
                                 class="art15-card-button forensic-ind-button" 
                                 data-tier="bassa"
                                 onclick="selectForensicIndeterminate(this, 'bassa')">
                                Indeterminabile complessità bassa
                            </div>
                            
                            <div id="forensic-ind-media-btn" 
                                 class="art15-card-button forensic-ind-button" 
                                 data-tier="media"
                                 onclick="selectForensicIndeterminate(this, 'media')">
                                Indeterminabile complessità media
                            </div>

                            <div id="forensic-ind-alta-btn" 
                                 class="art15-card-button forensic-ind-button" 
                                 data-tier="alta"
                                 onclick="selectForensicIndeterminate(this, 'alta')">
                                Indeterminabile complessità alta
                            </div>

                            <div id="forensic-ind-importante-btn" 
                                 class="art15-card-button forensic-ind-button" 
                                 data-tier="importante"
                                 onclick="selectForensicIndeterminate(this, 'importante')">
                                Indeterminabile di particolare importanza
                            </div>
                        </div>
                    </fieldset>
                </div>
                <!-- FINE NUOVO BLOCCO -->

                <!-- Alert/Risultati Compensi Avvocato -->
                <div id="forensic-alert" class="hidden bg-red-100 p-3 rounded-lg shadow-md border-l-4 border-red-700 text-red-800 font-medium text-sm mt-4">
                    <p class="font-bold">Attenzione:</p>
                    <p id="alert-message">Valore lite non rientrante Nelle fasce calcolabili.</p>
                </div>

                <!-- VALORE LITE PER LA STAMPA (AGGIUNTO) -->
                <div class="print-only text-base mb-4" id="forensic-print-value"></div>

                <!-- Risultati per Fase (Select by clicking value) -->
                <div id="forensic-results" class="grid grid-cols-1 gap-3 mt-4">
                    
                    <h3 class="text-base font-extrabold text-accent-mediation-navy border-b border-accent-mediation-300 pb-1 mt-2">Compensi per Fase (Seleziona il Valore)</h3>

                    <!-- FASE 1: Fase di attivazione (MODIFICATA) -->
                    <!-- AGGIUNTO: classe phase-box per bordo scuro tramite CSS -->
                    <div id="phase-activation-box" class="phase-box bg-white p-3 rounded-xl shadow-md single-phase-row">
                        <h3 class="text-sm font-bold text-accent-mediation-navy">Fase di attivazione</h3>
                        <div class="phase-content-grid">
                            <div id="act-display-min" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('activation', 'min')">
                                <span class="font-medium">Minimo</span>
                                <span class="fee-value font-black" data-value-type="min">0,00 €</span>
                            </div>
                            <div id="act-display-medium" class="fee-display-item flex flex-col justify-center items-center highlighted-fee" onclick="selectForensicFee('activation', 'medium')">
                                <span class="font-medium">Medio</span>
                                <span class="fee-value font-black" data-value-type="medium">0,00 €</span>
                            </div>
                            <div id="act-display-max" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('activation', 'max')">
                                <span class="font-medium">Massimo</span>
                                <span class="fee-value font-black" data-value-type="max">0,00 €</span>
                            </div>
                            <div class="hidden phase-radio-group print-hide">
                                <input type="radio" id="act-min" name="activation-level" value="min" class="hidden" />
                                <input type="radio" id="act-med" name="activation-level" value="medium" checked class="hidden" />
                                <input type="radio" id="act-max" name="activation-level" value="max" class="hidden" />
                            </div>
                        </div>
                    </div>

                    <!-- FASE 2: Fase negoziazione (MODIFICATA) -->
                    <!-- AGGIUNTO: classe phase-box per bordo scuro tramite CSS -->
                    <div id="phase-negotiation-box" class="phase-box bg-white p-3 rounded-xl shadow-md single-phase-row">
                        <h3 class="text-sm font-bold text-accent-mediation-navy">Fase negoziazione</h3>
                        <div class="phase-content-grid">
                            <div id="neg-display-min" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('negotiation', 'min')">
                                <span class="font-medium">Minimo</span>
                                <span class="fee-value font-black" data-value-type="min">0,00 €</span>
                            </div>
                            <div id="neg-display-medium" class="fee-display-item flex flex-col justify-center items-center highlighted-fee" onclick="selectForensicFee('negotiation', 'medium')">
                                <span class="font-medium">Medio</span>
                                <span class="fee-value font-black" data-value-type="medium">0,00 €</span>
                            </div>
                            <div id="neg-display-max" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('negotiation', 'max')">
                                <span class="font-medium">Massimo</span>
                                <span class="fee-value font-black" data-value-type="max">0,00 €</span>
                            </div>
                            <div class="hidden phase-radio-group print-hide">
                                <input type="radio" id="neg-min" name="negotiation-level" value="min" class="hidden" />
                                <input type="radio" id="neg-med" name="negotiation-level" value="medium" checked class="hidden" />
                                <input type="radio" id="neg-max" name="negotiation-level" value="max" class="hidden" />
                            </div>
                        </div>
                    </div>

                    <!-- FASE 3: Conciliazione (Non modificata) -->
                    <!-- AGGIUNTO: classe phase-box per bordo scuro tramite CSS -->
                    <div id="phase-conciliation-box" class="phase-box bg-white p-3 rounded-xl shadow-md single-phase-row">
                        <h3 class="text-sm font-bold text-accent-mediation-navy">Fase Conciliazione</h3>
                        <div class="phase-content-grid">
                            <div id="con-display-min" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('conciliation', 'min')">
                                <span class="font-medium">Minimo</span>
                                <span class="fee-value font-black" data-value-type="min">0,00 €</span>
                            </div>
                            <div id="con-display-medium" class="fee-display-item flex flex-col justify-center items-center highlighted-fee" onclick="selectForensicFee('conciliation', 'medium')">
                                <span class="font-medium">Medio</span>
                                <span class="fee-value font-black" data-value-type="medium">0,00 €</span>
                            </div>
                            <div id="con-display-max" class="fee-display-item flex flex-col justify-center items-center" onclick="selectForensicFee('conciliation', 'max')">
                                <span class="font-medium">Massimo</span>
                                <span class="fee-value font-black" data-value-type="max">0,00 €</span>
                            </div>
                            <div class="hidden phase-radio-group print-hide">
                                <input type="radio" id="con-min" name="conciliation-level" value="min" class="hidden" />
                                <input type="radio" id="con-med" name="conciliation-level" value="medium" checked class="hidden" />
                                <input type="radio" id="con-max" name="conciliation-level" value="max" class="hidden" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opzioni Calcolo (Maggiorazioni/Oneri Fiscali/Previdenziali) (MODIFICATA) -->
                    <!-- RIMOSSO: border border-gray-200 (sostituito da CSS phase-box/border border-gray-400 nel div interno) -->
                    <div class="p-3 bg-white rounded-xl shadow-md mt-2 print-hide border border-slate-400">
                        <h3 class="text-sm font-bold text-accent-mediation-navy mb-3 border-b border-accent-mediation-300 pb-1 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-accent-mediation-navy"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Maggiorazioni/Oneri Fiscali/Previdenziali
                        </h3>
                        
                        <div class="flex flex-wrap justify-between items-center gap-x-3 gap-y-1 text-xs sm:text-sm">
                            
                            <!-- NUOVO MAGGIORAZIONE 30% (SPOSTATO PRIMA) -->
                            <div class="toggle-container w-full sm:w-auto justify-between sm:justify-start">
                                <span class="text-gray-800 font-bold">Aumento 30% esito positivo</span>
                                <input type="checkbox" id="cost-increase" onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-increase" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>
                            
                            <!-- Spese Forfettarie (Testo ridotto: Spese forf. 15%) -->
                            <div class="toggle-container">
                                <span class="text-gray-800 font-medium"> Spese forf. 15%</span>
                                <input type="checkbox" id="cost-forfeit" checked onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-forfeit" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>

                            <!-- Contributo Cassa (Testo ridotto: Cassa 4%) -->
                            <div class="toggle-container">
                                <span class="text-gray-800 font-medium">Cassa 4%</span>
                                <input type="checkbox" id="cost-cassa" checked onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-cassa" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>

                            <!-- IVA (Testo ridotto: IVA 22%) -->
                            <div class="toggle-container">
                                <span class="text-gray-800 font-medium">IVA 22%</span>
                                <input type="checkbox" id="cost-iva" checked onchange="calculateForensicFees()" class="hidden">
                                <label for="cost-iva" class="toggle-track toggle-switch">
                                    <div class="toggle-thumb"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Riepilogo Totale Avvocato (AZZURRO PALLIDO + BORDO NERO/NAVY) -->
                    <!-- Modificato bg-accent-mediation-700, text-white in classi custom total-summary-box e text-dark-title -->
                    <div class="total-summary-box p-4 rounded-xl shadow-xl mt-4">
                        <h3 class="text-sm font-bold text-center mb-3 text-dark-title border-b border-accent-mediation-300 pb-2">Totale Complessivo Cliente (Basato sulle tue Selezioni)</h3>
                        
                        <!-- Colore testo impostato a gray-900 -->
                        <div class="space-y-2 text-sm text-gray-900"> 
                            <!-- Compenso Base Totale -->
                            <div class="flex justify-between items-center border-b border-accent-mediation-300 pb-1">
                                <span class="font-light opacity-90">A. Comp. Base (Totale Fasi):</span>
                                <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                <span id="forensic-total-base-fee" class="font-extrabold text-final-value text-base">0,00 €</span>
                            </div>

                            <!-- Nuova riga per Maggiorazione 30% -->
                            <div id="forensic-total-increase-row" class="flex justify-between items-center text-final-value font-semibold hidden">
                                <span class="font-light opacity-90">B. Maggiorazione esito positivo (30%):</span>
                                <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                <span id="forensic-total-increase" class="font-semibold text-base">0,00 €</span>
                            </div>
                            
                            <!-- Spese Forfettarie -->
                            <div class="flex justify-between items-center">
                                <!-- Etichetta aggiornata per indicare la base di calcolo corretta: (A + B) -->
                                <span class="font-light opacity-90">C. Spese Forfettarie (15% su A+B):</span>
                                <span id="forensic-total-forfeit" class="font-semibold text-gray-900 text-base">0,00 €</span>
                            </div>
                            
                            <!-- Contributo Cassa -->
                            <div class="flex justify-between items-center">
                                <!-- Etichetta aggiornata per indicare la base di calcolo corretta: (A + B + C) -->
                                <span class="font-light opacity-90">D. Contributo Cassa (4% su A+B+C):</span>
                                <span id="forensic-total-cassa" class="font-semibold text-gray-900 text-base">0,00 €</span>
                            </div>
                            
                            <!-- Imponibile IVA -->
                            <!-- Etichetta aggiornata: da E a E per seguire A, B, C, D e D. Imponibile IVA (A + B + C + D) -->
                            <div class="flex justify-between items-center pt-2 border-t border-accent-mediation-600">
                                <span class="font-light opacity-90 text-sm" id="forensic-taxable-label">E. Imponibile IVA (A + B + C + D):</span>
                                <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                <span id="forensic-total-taxable-base" class="font-extrabold text-lg text-final-value">0,00 €</span>
                            </div>

                            <!-- IVA -->
                            <div class="flex justify-between items-center">
                                <span class="font-light opacity-90 text-sm">F. IVA (22% su E):</span>
                                <span id="forensic-total-iva" class="font-semibold text-gray-900 text-base">0,00 €</span>
                            </div>

                            <!-- TOTALE FINALE -->
                            <div class="flex justify-between items-center pt-3 border-t-2 border-accent-mediation-500">
                                <p class="text-lg font-black text-dark-title">TOTALE CLIENTE:</p>
                                <!-- Modificato colore testo a Navy per contrasto su sfondo chiaro -->
                                <p id="forensic-total-final-cost" class="text-2xl font-black text-final-value">
                                    0,00 €
                                </p>
                            </div>

                        </div>
                    </div>
                    
                    <!-- NUOVO BLOCCO: Procedimento di Mediazione Avvocato (Colorato) -->
                    <!-- AGGIUNTO: border border-slate-400 (per coerenza) -->
                    <div class="flex flex-col gap-2 p-3 rounded-lg border print-hide input-box-highlight border-slate-400">
                        <div class="flex items-center justify-center gap-2">
                            <span>Procedimento di Mediazione n.</span>
                            <input 
                                type="number" 
                                id="forensic-mediation-number-1" 
                                class="w-16 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-bold"
                                placeholder="00"
                            />
                            <span>/</span>
                            <input 
                                type="number" 
                                id="forensic-mediation-number-2" 
                                class="w-20 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-bold"
                                placeholder="2025"
                            />
                            <span class="ml-2 font-bold whitespace-nowrap">nei confronti</span>
                        </div>
                        <input
                            type="text"
                            id="forensic-mediation-counterparty"
                            class="w-full p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-medium mt-1"
                            placeholder="Nome della controparte"
                        />
                    </div>
                    <!-- FINE NUOVO BLOCCO -->
                    
                    <!-- NUOVA RIGA: Per accettazione Avvocato -->
                    <div class="p-2 pt-0 print-hide">
                        <div class="text-xs text-gray-600 italic text-justify">
                            Per accettazione 
                            <div class="w-full h-px bg-gray-400 mt-10"></div> <!-- SPAZIO AUMENTATO -->
                        </div>
                    </div>
                    <!-- FINE NUOVA RIGA -->
                    
                    <!-- NUOVA CASELLA LUOGO E DATA AVVOCATO (Destra) (Colorata) -->
                    <!-- AGGIUNTO: border border-slate-400 (per coerenza) -->
                    <div class="flex items-center justify-center gap-4 p-2 rounded-lg border print-hide input-box-highlight border-slate-400">
                        <div class="flex items-center gap-2">
                            <span>Luogo:</span>
                            <input 
                                type="text" 
                                id="forensic-location" 
                                class="w-24 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-medium"
                                placeholder="Città"
                            />
                        </div>
                        <div class="flex items-center gap-2">
                            <span>Data:</span>
                            <input 
                                type="text" 
                                id="forensic-date" 
                                class="w-24 p-1 text-center border border-accent-mediation-300 rounded-md shadow-sm focus:ring-accent-mediation-navy focus:border-accent-mediation-navy text-sm font-medium"
                                placeholder="gg/mm/aaaa"
                            />
                        </div>
                    </div>
                    <!-- FINE NUOVA CASELLA LUOGO E DATA -->
                </div>
                
                <!-- NUOVO CONTENITORE PULSANTI DI STAMPA AVVOCATO (Modificato) -->
                <div class="print-button-container flex flex-col justify-center items-center gap-3 mt-4">
                    
                    <!-- Contenitore Flex per i due pulsanti originali (affiancati su desktop) -->
                    <div class="flex flex-col sm:flex-row justify-center items-center gap-3 w-full">
                        <!-- Tasto Stampa Standard (NAVY) -->
                        <button 
                            onclick="printSection('forensic-app')" 
                            class="flex items-center justify-center w-full sm:w-1/2 bg-accent-mediation-navy hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-accent-mediation-300 text-sm"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> 
                            Stampa Sezione Avvocato
                        </button>
                        <!-- Tasto Stampa Personalizzata (ANTRACHITE) -->
                        <button 
                            onclick="openCustomPrintModal()" 
                            class="flex items-center justify-center w-full sm:w-1/2 bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-slate-300 text-sm"
                         >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5"/><path d="M18 10a6 6 0 0 0-9.37 0"/></svg>
                            Stampa Personalizzata Studio
                        </button>
                    </div>

                    <!-- NUOVO PULSANTE CALCOLATORE GRATUITO PATROCINIO (BORDEAUX SCURO - Colore Secondario) -->
                    <a 
                        href="https://pinnaspada.github.io/gratuitopatrocinio/" 
                        target="_blank"
                        class="flex items-center justify-center w-full bg-red-800 hover:bg-red-700 text-white font-extrabold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300 text-base mt-2"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14 2c3.47 2 7 5 7 10"/><path d="M12 20H4c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2h.7L12 18V2z"/><path d="M22 17c0 3-3 6-7 6"/><path d="M18 10c0-1.3-.8-2.5-2-3"/></svg>
                        CALCOLATORE COMPENSI AVVOCATO GRATUITO PATROCINIO
                    </a>
                </div>
            </div>

        </div> <!-- FINE #apps-container -->

        <!-- NUOVA POSIZIONE: Blocco Note Legali Centrato a Tutta Larghezza -->
        <div id="full-width-footer" class="mt-4">
            
            <!-- Contatore Centrato Aggiornato Qui -->
            <div class="mt-4 flex justify-center w-full"> 
                <!-- hitwebcounter Code START -->
                <a href="https://www.hitwebcounter.com/" target="_blank">
                <img src="https://hitwebcounter.com/counter/counter.php?page=21452317&style=0006&nbdigits=9&type=page&initCount=0" title="Counters" Alt="Counters" border="0" /></a>
                <!-- hitwebcounter Code END -->
            </div>
            
            <!-- Note Legali Originali -->
            <footer id="legal-notes-footer" class="mt-4 p-4 bg-gray-100 text-xs text-gray-600 text-justify rounded-xl border border-gray-300">
                <p class="mb-2 font-bold text-gray-800 text-left">Note Legali Importanti:</p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                    <li>
                        Calcolatore realizzato dall'<a href="https://www.ordineavvocati.ss.it/docs/mediazione_curriculum_responsabile24092025.pdf" target="_blank" class="font-bold text-accent-mediation-navy hover:underline">Avv. Antonio Pinna Spada</a>, Responsabile dell'
                        <!-- LINK AGGIUNTO QUI per Oristano. RIMOSSO CLASSE GRASSETTO "font-bold" -->
                        <a href="https://www.ordineavvocatioristano.it/mediazione/" target="_blank" class="text-accent-mediation-navy hover:underline">
                            Organismo di Media Conciliazione Forense dell'Ordine degli Avvocati di Oristano
                        </a> 
                        e Responsabile dell'
                        <!-- LINK AGGIUNTO QUI per Sassari. RIMOSSO CLASSE GRASSETTO "font-bold" -->
                        <a href="https://www.ordineavvocati.ss.it/pag.php?id=34" target="_blank" class="text-accent-mediation-navy hover:underline">
                            Organismo di Mediazione del Consiglio dell'Ordine degli Avvocati di Sassari
                        </a>. 
                    </li>
                    <ul class="list-disc list-inside space-y-1 ml-4 mt-1">
                        <li>
                            In caso di conciliazione in incontro successivo al primo, gli importi complessivamente dovuti a titolo di spese di mediazione, in aggiunta a quanto prevede l'art. 30 c.2 del DM 150/2023, possono essere maggiorati fino al 20%, in ragione dell'esistenza di almeno uno dei seguenti criteri (art. 31, c. 3): a) esperienza e competenza del mediatore designato su concorde indicazione delle parti; b) complessità delle questioni oggetto della procedura, quali l'impegno richiesto al mediatore, valutabile anche, ma non esclusivamente, in base al numero degli incontri svolti.
                        </li>
                    </ul>
                    <li>
                        Il calcolatore può essere utilizzato esclusivamente per esigenze non professionali e le risultanze di calcolo devono essere intese a carattere puramente indicativo e non vincolante. 
                    </li>
                    <li>
                        L'importo delle spese di mediazione del valore superiore ad € 5.000.000,01 viene calcolato ai minimi.
                    </li>
                    <li>
                        Il calcolatore è stato sviluppato sulla base dei parametri di cui al <span class="font-medium">DM 150/2023</span> (spese di mediazione) e successive integrazioni e modifiche.
                    </li>
                    <li>
                        Il funzionamento del calcolatore è stato testato in tutte le variabili ma non è possibile escludere la presenza di errori, pertanto è consigliabile <span class="font-bold text-red-700">verificare ogni volta i risultati</span> con le normative ufficiali.
                    </li>

                    </li>
                <p class="text-sm text-gray-600">
  Per maggiori informazioni, contattare l'autore al seguente indirizzo di posta elettronica:
  <a href="mailto:pinnaspada@gmail.com" class="text-indigo-600 hover:text-indigo-800 hover:underline">
    pinnaspada@gmail.com
  </a>
</p>
                </ul>
            </footer>
        </div>
        <!-- FINE NUOVA POSIZIONE -->

    </div> <!-- FINE #main-container -->
    
    <!-- Modal per la personalizzazione della stampa Avvocato (Studio Legale) -->
    <div id="custom-print-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-accent-mediation-navy mb-4 border-b pb-2">Dati Studio Legale per Stampa</h3>
            <div id="modal-form" class="space-y-3">
                <div>
                    <label for="studio-nome" class="block text-sm font-medium text-gray-700">Nome Studio/Avvocato:</label>
                    <input type="text" id="studio-nome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Es. Studio Legale Rossi">
                </div>
                <div>
                    <label for="studio-indirizzo" class="block text-sm font-medium text-gray-700">Indirizzo:</label>
                    <input type="text" id="studio-indirizzo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Via Roma, 123">
                </div>
                <div>
                    <label for="studio-contatto" class="block text-sm font-medium text-gray-700">Contatto (Tel/Email):</label>
                    <input type="text" id="studio-contatto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Tel. 06 1234567 | info@studio.it">
                </div>
                <div>
                    <label for="studio-piva" class="block text-sm font-medium text-gray-700">P.IVA/Cod.Fisc.:</label>
                    <input type="text" id="studio-piva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="P.IVA 12345678901">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeCustomPrintModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm transition">Annulla</button>
                <button onclick="saveAndPrintCustom('studio')" class="bg-accent-mediation-navy hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg text-sm transition">Salva e Stampa</button>
            </div>
        </div>
    </div>
    
    <!-- Modal per la personalizzazione della stampa Mediazione (Organismo) (NUOVO) -->
    <div id="mediation-print-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-accent-mediation-navy mb-4 border-b pb-2">Dati Organismo di Mediazione per Stampa</h3>
            <div id="mediation-modal-form" class="space-y-3">
                <div>
                    <label for="organismo-nome" class="block text-sm font-medium text-gray-700">Nome Organismo:</label>
                    <input type="text" id="organismo-nome" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Es. Organismo di Mediazione Forense">
                </div>
                <div>
                    <label for="organismo-indirizzo" class="block text-sm font-medium text-gray-700">Indirizzo Sede:</label>
                    <input type="text" id="organismo-indirizzo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Via Dante, 5">
                </div>
                <div>
                    <label for="organismo-contatto" class="block text-sm font-medium text-gray-700">Contatto (Tel/Email):</label>
                    <input type="text" id="organismo-contatto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Tel. 070 876543 | info@organismo.it">
                </div>
                <div>
                    <label for="organismo-cfin" class="block text-sm font-medium text-gray-700">Codice Fiscale / Iscrizione:</label>
                    <input type="text" id="organismo-cfin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="C.F. 12345678901 / N° Reg. 123">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeMediationCustomPrintModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm transition">Annulla</button>
                <button onclick="saveAndPrintMediationCustom('organismo')" class="bg-accent-mediation-navy hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg text-sm transition">Salva e Stampa</button>
            </div>
        </div>
    </div>


    <!-- Script per Logica Applicativa (SENZA FIREBASE) -->
    <script type="module">
        // Variabili globali per la gestione del modal e localStorage
        const STUDIO_PRINT_MODAL_ID = 'custom-print-modal';
        const MEDIATION_PRINT_MODAL_ID = 'mediation-print-modal';
        const STUDIO_STORAGE_KEY = 'studio_data';
        const ORGANISMO_STORAGE_KEY = 'organismo_data';
        
        // Costanti per la modulazione del valore indeterminato
        // NON più usati per calcolare le indennità (Caselle 2,3,4) ma solo per la Spesa di Avvio (Casella 1) e i messaggi.
        const INDETERMINATE_MULTIPLIERS = { 
            alto: 1.2, 
            medio: 1.0, 
            basso: 0.8,
        };
        
        // Variabile globale per tenere traccia del moltiplicatore Art. 15 selezionato
        let currentArt15Multiplier = 200;

        // AGGIUNTO: Variabile globale per il tier indeterminabile dell'avvocato
        let currentForensicIndeterminateTier = null;
        let currentForensicIndeterminateTierName = ""; // Per la stampa

        // AGGIUNTO: Costante con i nuovi valori dalla tabella DOCX
        const FORENSIC_INDETERMINATE_FEES = {
            'bassa': {
                activation: { min: 268, medium: 536, max: 804 },
                negotiation: { min: 536, medium: 1071, max: 1607 },
                conciliation: { min: 1044, medium: 2088, max: 3132 }
            },
            'media': {
                activation: { min: 386, medium: 772, max: 1158 },
                negotiation: { min: 772, medium: 1544, max: 2316 },
                conciliation: { min: 1505, medium: 3010, max: 4515 }
            },
            'alta': {
                activation: { min: 504, medium: 1008, max: 1512 },
                negotiation: { min: 1008, medium: 2016, max: 3024 },
                conciliation: { min: 1966, medium: 3931, max: 5897 }
            },
            'importante': {
                activation: { min: 685, medium: 1370, max: 2055 },
                negotiation: { min: 1371, medium: 2741, max: 4112 },
                conciliation: { min: 2672, medium: 5343, max: 8015 }
            }
        };


        // AGGIUNTO: Funzione per gestire la selezione dei pulsanti Indeterminato Avvocato
        window.selectForensicIndeterminate = (selectedElement, tier) => {
            const valueInput = document.getElementById('forensic-litigation-value');
            const buttons = document.querySelectorAll('.forensic-ind-button');
            
            // Controlla se il pulsante cliccato è GIÀ selezionato
            if (currentForensicIndeterminateTier === tier) {
                // DESELEZIONA
                currentForensicIndeterminateTier = null;
                currentForensicIndeterminateTierName = "";
                selectedElement.classList.remove('selected');
                
                // Riabilita l'input del valore e lo svuota
                valueInput.removeAttribute('disabled');
                valueInput.value = ''; // Svuota per permettere nuovo inserimento
                valueInput.placeholder = "es. 15000 o Indeterminabile";
                
            } else {
                // SELEZIONA
                currentForensicIndeterminateTier = tier;
                currentForensicIndeterminateTierName = selectedElement.textContent.trim();
                
                // Aggiorna la UI dei pulsanti
                buttons.forEach(btn => btn.classList.remove('selected'));
                selectedElement.classList.add('selected');
                
                // Disabilita l'input del valore e mostra il tier selezionato
                valueInput.setAttribute('disabled', 'true');
                valueInput.value = currentForensicIndeterminateTierName;
            }

            // In ogni caso, ricalcola i compensi
            calculateForensicFees();
        };


        // --- FUNZIONI DI UTILITY ---
        /**
         * Funzione helper per pulire e parsare il valore di input.
         * Gestisce "€", spazi, e usa la virgola o il punto come decimale.
         *
         * Spostata qui e dichiarata con 'const' per essere accessibile da tutti i blocchi funzione
         * all'interno del modulo, inclusa la logica del calcolatore Art. 15 c.p.c.
         */
        const parseValue = (value) => {
            if (!value) return 0;
            // Rimuove '€', spazi, e sostituisce la virgola con il punto per il parsing
            const cleanedValue = value
                .replace(/€/g, '')      // Rimuove simbolo euro
                .replace(/\./g, '')     // Rimuove punti (per migliaia es. 1.000)
                .replace(/,/g, '.')     // Converte la virgola decimale in punto
                .trim();
            
            const parsed = parseFloat(cleanedValue);
            return isNaN(parsed) ? 0 : parsed;
        };
        
        /**
         * Formatta un numero in valuta Euro.
         * @param {number} value Il valore numerico.
         * @returns {string} Il valore formattato.
         */
        const formatCurrency = (value) => {
            if (typeof value !== 'number' || isNaN(value)) {
                return '0,00 €';
            }
            return `${value.toFixed(2).replace('.', ',')} €`;
        };
        
        /**
         * Carica i dati da localStorage.
         * @param {string} key Chiave di localStorage (STUDIO_STORAGE_KEY o ORGANISMO_STORAGE_KEY).
         * @returns {object} I dati salvati o un oggetto vuoto.
         */
        const loadData = (key) => {
            try {
                const storedData = localStorage.getItem(key);
                return storedData ? JSON.parse(storedData) : {};
            } catch (e) {
                console.error(`Errore nel caricamento dei dati per la chiave ${key}:`, e);
                return {};
            }
        };

        /**
         * Salva i dati in localStorage.
         * @param {string} key Chiave di localStorage.
         * @param {object} data I dati da salvare.
         */
        const saveData = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Errore nel salvataggio dei dati per la chiave ${key}:`, e);
            }
        };
        
        /**
         * Popola i campi data con la data odierna in formato gg/mm/aaaa.
         */
        const populateDateFields = () => {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Mesi partono da 0
            const year = today.getFullYear();
            const formattedDate = `${day}/${month}/${year}`;

            const mediationDate = document.getElementById('mediation-date');
            const forensicDate = document.getElementById('forensic-date');

            if (mediationDate) {
                mediationDate.value = formattedDate;
            }
            if (forensicDate) {
                forensicDate.value = formattedDate;
            }
        };


        // --- FUNZIONE DI STAMPA STANDARD (CORREZIONE ERRORE) ---
        /**
         * Stampa la sezione specificata creando un iframe temporaneo.
         * @param {string} sectionId ID della sezione da stampare ('mediation-app' o 'forensic-app').
         */
        window.printSection = function (sectionId) {
            const section = document.getElementById(sectionId);
            const integratedHeader = document.getElementById('integrated-calculator-header');
            const legalNotes = document.getElementById('legal-notes-footer');

            if (!section || !integratedHeader || !legalNotes) {
                console.error(`Sezione per la stampa (${sectionId}) non trovata.`);
                return;
            }

            // Clona i contenuti per la manipolazione
            const contentToPrint = section.cloneNode(true);
            const integratedHeaderToPrint = integratedHeader.cloneNode(true);
            const legalNotesToPrint = legalNotes.cloneNode(true);

            // Rimuove gli elementi interattivi dalla copia destinata alla stampa
            const elementsToRemove = contentToPrint.querySelectorAll('.print-hide, .print-button-container');
            elementsToRemove.forEach(el => el.remove());
            
            // Rende visibile l'informazione sul valore lite per la stampa nel clone dell'app
            const printValueEl = contentToPrint.querySelector('.print-only');
            if (printValueEl) {
                printValueEl.classList.remove('print-only');
                printValueEl.classList.add('print-litigation-value'); 
            }
            
            // Logica per aggiungere Dettagli (Numero Procedimento, Luogo, Data, Accettazione)
            let detailsHtml = '';
            
            if (sectionId === 'mediation-app') {
                 const num1 = document.getElementById('mediation-number-1')?.value || '....';
                 const num2 = document.getElementById('mediation-number-2')?.value || '....';
                 const location = document.getElementById('mediation-location')?.value || '....';
                 const date = document.getElementById('mediation-date')?.value || '....';

                 detailsHtml = `
                    <div style="text-align: center; margin-bottom: 20px; font-size: 0.9rem; font-weight: bold; padding: 5px; border: 1px dashed #1e3a8a;">
                        Procedimento di Mediazione n. ${num1} / ${num2}
                    </div>
                    <div style="text-align: right; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #4b5563;">
                        ${location}, lì ${date}
                    </div>
                    <div class="acceptance-text">
                        Per accettazione, salvo diversa determinazione del valore da parte del Responsabile
                    </div>
                    <div class="acceptance-line" style="margin-top: 10px; margin-bottom: 20px;"></div>
                 `;

            } else if (sectionId === 'forensic-app') {
                 const num1 = document.getElementById('forensic-mediation-number-1')?.value || '....';
                 const num2 = document.getElementById('forensic-mediation-number-2')?.value || '....';
                 const counterparty = document.getElementById('forensic-mediation-counterparty')?.value || '....';
                 const location = document.getElementById('forensic-location')?.value || '....';
                 const date = document.getElementById('forensic-date')?.value || '....';

                 detailsHtml = `
                    <div style="text-align: left; margin-top: 15px; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; padding: 5px; border: 1px dashed #1e3a8a;">
                        Procedimento di Mediazione n. ${num1} / ${num2} nei confronti di ${counterparty}
                    </div>
                    <div style="text-align: right; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #4b5563;">
                        ${location}, lì ${date}
                    </div>
                    <div class="acceptance-text" style="margin-top: 25px;">
                        Per accettazione 
                    </div>
                    <div class="acceptance-line" style="margin-top: 10px; margin-bottom: 20px;"></div>
                 `;
            }

            // Costruisce il contenuto HTML completo per la stampa
            const integratedHeaderHtml = integratedHeaderToPrint.outerHTML;
            const appContentHtml = contentToPrint.outerHTML;
            const footerContentHtml = legalNotesToPrint.outerHTML;


            const printHTML = `
                ${integratedHeaderHtml}
                <div class="print-content-wrapper" style="padding-top: 1rem;">
                    ${appContentHtml}
                    ${detailsHtml}
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
                        ${footerContentHtml}
                    </div>
                </div>
            `;


            // Crea la finestra di stampa
            const style = document.querySelector('style').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            if (!printWindow) {
                console.error("Impossibile aprire la finestra di stampa. Controllare le impostazioni di blocco dei popup.");
                return;
            }

            printWindow.document.write('<html><head><title>Stampa Sezione</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write(`<style>${style}</style>`);
            
            printWindow.document.write('</head><body class="print-container">');
            printWindow.document.write(printHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close(); 
            
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        };

        // --- LOGICA MODAL DI PERSONALIZZAZIONE STUDIO (AVVOCATO) ---

        /**
         * Apre il modal di personalizzazione Studio e carica i dati salvati.
         */
        window.openCustomPrintModal = () => {
            const modal = document.getElementById(STUDIO_PRINT_MODAL_ID);
            const data = loadData(STUDIO_STORAGE_KEY);
            
            document.getElementById('studio-nome').value = data.nome || '';
            document.getElementById('studio-indirizzo').value = data.indirizzo || '';
            document.getElementById('studio-contatto').value = data.contatto || '';
            document.getElementById('studio-piva').value = data.piva || '';

            modal.classList.remove('hidden');
        };

        /**
         * Chiude il modal di personalizzazione Studio.
         */
        window.closeCustomPrintModal = () => {
            const modal = document.getElementById(STUDIO_PRINT_MODAL_ID);
            modal.classList.add('hidden');
        };

        /**
         * Salva i dati del form Studio in localStorage e avvia la stampa personalizzata Avvocato.
         */
        window.saveAndPrintCustom = () => {
            const nome = document.getElementById('studio-nome').value.trim();
            const indirizzo = document.getElementById('studio-indirizzo').value.trim();
            const contatto = document.getElementById('studio-contatto').value.trim();
            const piva = document.getElementById('studio-piva').value.trim();
            
            const data = { nome, indirizzo, contatto, piva };
            saveData(STUDIO_STORAGE_KEY, data);
            
            closeCustomPrintModal();
            printCustomForensicReport(data);
        };
        
        // --- LOGICA MODAL DI PERSONALIZZAZIONE ORGANISMO (MEDIAZIONE) (NUOVO) ---

        /**
         * Abre il modal di personalizzazione Organismo e carica i dati salvati.
         */
        window.openMediationCustomPrintModal = () => {
            const modal = document.getElementById(MEDIATION_PRINT_MODAL_ID);
            const data = loadData(ORGANISMO_STORAGE_KEY);
            
            document.getElementById('organismo-nome').value = data.nome || '';
            document.getElementById('organismo-indirizzo').value = data.indirizzo || '';
            document.getElementById('organismo-contatto').value = data.contatto || '';
            document.getElementById('organismo-cfin').value = data.cfin || '';

            modal.classList.remove('hidden');
        };

        /**
         * Chiude il modal di personalizzazione Organismo.
         */
        window.closeMediationCustomPrintModal = () => {
            const modal = document.getElementById(MEDIATION_PRINT_MODAL_ID);
            modal.classList.add('hidden');
        };
        
        /**
         * Salva i dati del form Organismo in localStorage e avvia la stampa personalizzata Organismo.
         */
        window.saveAndPrintMediationCustom = () => {
            const nome = document.getElementById('organismo-nome').value.trim();
            const indirizzo = document.getElementById('organismo-indirizzo').value.trim();
            const contatto = document.getElementById('organismo-contatto').value.trim();
            const cfin = document.getElementById('organismo-cfin').value.trim();
            
            const data = { nome, indirizzo, contatto, cfin };
            saveData(ORGANISMO_STORAGE_KEY, data);
            
            closeMediationCustomPrintModal();
            printCustomMediationReport(data);
        };
        
        // --- FUNZIONI DI STAMPA PERSONALIZZATA ---

        /**
         * Genera l'intestazione personalizzata.
         * @param {object} customData I dati da stampare (Studio o Organismo).
         * @param {string} color Il colore dominante (es. #1d4ed8 per Studio, #4f46e5 per Organismo).
         * @returns {string} L'HTML dell'intestazione.
         */
        const generateCustomHeader = (customData, color) => {
            if (!customData || !customData.nome) {
                return '';
            }
            
            // Per Organismo usiamo cfin, per Studio usiamo piva
            const identifier = customData.cfin || customData.piva || ''; 
            const contactLine = [customData.contatto, identifier].filter(Boolean).join(' | ');
            
            // Usa il colore Navy originale (#1e3a8a) per l'intestazione in stampa
            const navyColor = '#1e3a8a';

            return `
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ccc;">
                    <h1 style="font-size: 1.25rem; font-weight: bold; color: ${navyColor};">${customData.nome}</h1>
                    ${customData.indirizzo ? `<p style="font-size: 0.875rem; color: #4b5563;">${customData.indirizzo}</p>` : ''}
                    ${contactLine ? `<p style="font-size: 0.875rem; color: #4b5563;">${contactLine}</p>` : ''}
                </div>
            `;
        };

        /**
         * Cattura il contenuto del calcolatore Avvocato e avvia la stampa con intestazione personalizzata.
         * @param {object} studioData I dati dello studio da inserire nell'intestazione.
         */
        const printCustomForensicReport = (studioData) => {
            const forensicContent = document.getElementById('forensic-app');
            const integratedHeader = document.getElementById('integrated-calculator-header');
            const legalNotes = document.getElementById('legal-notes-footer');

            if (!forensicContent || !legalNotes || !integratedHeader) {
                console.error(`Contenuto necessario per la stampa Avvocato non trovato.`);
                return;
            }

            // Clona i contenuti per la manipolazione
            const contentToPrint = forensicContent.cloneNode(true);
            const integratedHeaderToPrint = integratedHeader.cloneNode(true);
            const legalNotesToPrint = legalNotes.cloneNode(true);

            // NUOVA LOGICA: Aggiunge i campi Procedimento Avvocato al contenuto stampato
            const forensicNum1 = document.getElementById('forensic-mediation-number-1')?.value || '....';
            const forensicNum2 = document.getElementById('forensic-mediation-number-2')?.value || '....';
            const forensicCounterparty = document.getElementById('forensic-mediation-counterparty')?.value || '....';
            const forensicLocation = document.getElementById('forensic-location')?.value || '....';
            const forensicDate = document.getElementById('forensic-date')?.value || '....';

            // Colore Navy per il bordo tratteggiato in stampa
            const forensicDetailsHtml = `
                <div style="text-align: left; margin-top: 15px; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; padding: 5px; border: 1px dashed #1e3a8a;">
                    Procedimento di Mediazione n. ${forensicNum1} / ${forensicNum2} nei confronti di ${forensicCounterparty}
                </div>
            `;
            
            const locationDateHtml = `
                <div style="text-align: right; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #4b5563;">
                    ${forensicLocation}, lì ${forensicDate}
                </div>
            `;

            const acceptanceLineHtml = `
                <div class="acceptance-text" style="margin-top: 25px;">
                    Per accettazione 
                </div>
                <div class="acceptance-line" style="margin-top: 10px; margin-bottom: 20px;"></div>
            `;


            // Rimuove gli elementi non necessari/interattivi dal clone dell'app forense
            const elementsToRemove = contentToPrint.querySelectorAll('.print-hide, .print-button-container');
            elementsToRemove.forEach(el => el.remove());

            // Rende visibile l'informazione sul valore lite per la stampa nel clone dell'app
            const printValueEl = contentToPrint.querySelector('.print-only');
            if (printValueEl) {
                printValueEl.classList.remove('print-only');
                printValueEl.classList.add('print-litigation-value'); 
            }

            // Genera l'intestazione personalizzata dello studio (Tema Navy)
            const customHeaderHtml = generateCustomHeader(studioData, '#1e3a8a'); /* Deep Blue */
            
            // Costruisce il contenuto HTML completo per la stampa
            const integratedHeaderHtml = integratedHeaderToPrint.outerHTML;
            const appContentHtml = contentToPrint.outerHTML;
            const footerContentHtml = legalNotesToPrint.outerHTML;

            const printHTML = `
                ${customHeaderHtml}
                ${integratedHeaderHtml}
                <div class="print-content-wrapper" style="padding-top: 1rem;">
                    ${appContentHtml}
                    ${forensicDetailsHtml}
                    ${locationDateHtml} <!-- INSERIMENTO LUOGO E DATA AVVOCATO -->
                    ${acceptanceLineHtml}
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
                        ${footerContentHtml}
                    </div>
                </div>
            `;
            
            // Crea la finestra di stampa
            const style = document.querySelector('style').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            if (!printWindow) {
                console.error("Impossibile aprire la finestra di stampa. Controllare le impostazioni di blocco dei popup.");
                return;
            }
            
            printWindow.document.write('<html><head><title>Stampa Personalizzata Compensi Avvocato</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write(`<style>${style}</style>`);
            
            printWindow.document.write('</head><body class="print-container">');
            printWindow.document.write(printHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close(); 
            
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        }

        /**
         * Cattura il contenuto del calcolatore Mediazione e avvia la stampa con intestazione personalizzata.
         * @param {object} organismoData I dati dell'Organismo da inserire nell'intestazione.
         */
        const printCustomMediationReport = (organismoData) => {
            const mediationContent = document.getElementById('mediation-app');
            const integratedHeader = document.getElementById('integrated-calculator-header');
            const legalNotes = document.getElementById('legal-notes-footer');

            if (!mediationContent || !legalNotes || !integratedHeader) {
                console.error(`Contenuto necessario per la stampa Mediazione non trovato.`);
                return;
            }

            // Clona i contenuti per la manipolazione
            const contentToPrint = mediationContent.cloneNode(true);
            const integratedHeaderToPrint = integratedHeader.cloneNode(true);
            const legalNotesToPrint = legalNotes.cloneNode(true);

            // Aggiunge la riga "Procedimento di Mediazione n. /" al contenuto stampato
            const mediationNum1 = document.getElementById('mediation-number-1')?.value || '....';
            const mediationNum2 = document.getElementById('mediation-number-2')?.value || '....';
            const mediationLocation = document.getElementById('mediation-location')?.value || '....';
            const mediationDate = document.getElementById('mediation-date')?.value || '....';


            const mediationNumberHtml = `
                <div style="text-align: center; margin-bottom: 20px; font-size: 0.9rem; font-weight: bold; padding: 5px; border: 1px dashed #1e3a8a;">
                    Procedimento di Mediazione n. ${mediationNum1} / ${mediationNum2}
                </div>
            `;
            
            const locationDateHtml = `
                <div style="text-align: right; margin-top: 15px; font-size: 0.9rem; font-weight: 500; color: #4b5563;">
                    ${mediationLocation}, lì ${mediationDate}
                </div>
            `;
            
            // Nuova riga di accettazione
            const acceptanceLineHtml = `
                <div class="acceptance-text">
                    Per accettazione, salvo diversa determinazione del valore da parte del Responsabile
                </div>
                <div class="acceptance-line" style="margin-top: 10px; margin-bottom: 20px;"></div>
            `;


            // Rimuove gli elementi non necessari/interattivi dal clone dell'app mediazione
            const elementsToRemove = contentToPrint.querySelectorAll('.print-hide, .print-button-container');
            elementsToRemove.forEach(el => el.remove());

            // Rende visibile l'informazione sul valore lite per la stampa nel clone dell'app
            const printValueEl = contentToPrint.querySelector('.print-only');
            if (printValueEl) {
                printValueEl.classList.remove('print-only');
                printValueEl.classList.add('print-litigation-value'); 
            }

            // Genera l'intestazione personalizzata dell'Organismo (Tema Grigio Scuro)
            const customHeaderHtml = generateCustomHeader(organismoData, '#1e3a8a'); /* Deep Blue */
            
            // Costruisce il contenuto HTML completo per la stampa
            const integratedHeaderHtml = integratedHeaderToPrint.outerHTML;
            const appContentHtml = contentToPrint.outerHTML;
            const footerContentHtml = legalNotesToPrint.outerHTML;

            const printHTML = `
                ${customHeaderHtml}
                ${integratedHeaderHtml}
                <div class="print-content-wrapper" style="padding-top: 1rem;">
                    ${appContentHtml}
                    ${mediationNumberHtml}
                    ${locationDateHtml} <!-- INSERIMENTO LUOGO E DATA MEDIAZIONE -->
                    ${acceptanceLineHtml}
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
                        ${footerContentHtml}
                    </div>
                </div>
            `;
            
            // Crea la finestra di stampa
            const style = document.querySelector('style').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            if (!printWindow) {
                console.error("Impossibile aprire la finestra di stampa. Controllare le impostazioni di blocco dei popup.");
                return;
            }
            
            printWindow.document.write('<html><head><title>Stampa Personalizzata Spese Mediazione</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write(`<style>${style}</style>`);
            
            printWindow.document.write('</head><body class="print-container">');
            printWindow.document.write(printHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close(); 
            
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        }

        /**
         * Aggiorna la label e il tipo di input del valore lite
         */
        window.updateValueInputType = function () { // Funzione esposta globalmente
            const valueTypeSelect = document.getElementById('litigation-value-type');
            const mediationLitigationInput = document.getElementById('mediation-litigation-value');
            const forensicLitigationInput = document.getElementById('forensic-litigation-value');
            const valueLabel = document.querySelector('label[for="mediation-litigation-value"]');
            const indeterminateBox = document.getElementById('indeterminate-value-options');
            
            const isIndeterminabile = valueTypeSelect.value === 'indeterminabile';

            if (isIndeterminabile) {
                valueLabel.textContent = 'Valore della Lite (Tipo):';
                mediationLitigationInput.value = 'Indeterminabile';
                mediationLitigationInput.setAttribute('disabled', 'true');
                mediationLitigationInput.setAttribute('placeholder', 'Indeterminabile');
                indeterminateBox.classList.remove('hidden');
                
                // Sincronizza l'input forense (che non calcola l'indeterminabile)
                if (forensicLitigationInput) {
                    forensicLitigationInput.value = 'indeterminabile';
                }
            } else {
                valueLabel.textContent = 'Valore della Lite (€):';
                // Pulisci l'input solo se prima era Indeterminabile per evitare bug
                if (mediationLitigationInput.value.toLowerCase() === 'indeterminabile' || mediationLitigationInput.hasAttribute('disabled')) {
                    mediationLitigationInput.value = '';
                }
                mediationLitigationInput.removeAttribute('disabled');
                mediationLitigationInput.setAttribute('placeholder', 'es. 15000');
                indeterminateBox.classList.add('hidden');
                
                // Pulisce l'input forense per ripristinare il valore, se necessario
                 if (forensicLitigationInput) {
                    forensicLitigationInput.value = mediationLitigationInput.value;
                }
            }
        };


        // =========================================================================
        // --- LOGICA CALCOLO MEDIAZIONE (DM 150/2023) ---
        // =========================================================================

        const MEDIATION_TARIFFS_FULL = {
            // DATI AGGIORNATI CON I VALORI INDETERMINATI FORNITI DAL DOCUMENTO
            minimi: {
                obbligatorie: [
                    { min: 0, max: 1000, speseFisse: 97.60, speseAvvio: 39.04, indennitaPrimoIncontro: 58.56, negativo: 19.52, positivo1: 21.47, positivoDopo1: 24.40 },
                    { min: 1000.01, max: 5000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 39.04, positivo1: 42.94, positivoDopo1: 48.80 },
                    { min: 5000.01, max: 10000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 165.92, positivo1: 182.51, positivoDopo1: 207.40 },
                    { min: 10000.01, max: 25000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 312.32, positivo1: 343.55, positivoDopo1: 390.40 },
                    { min: 25000.01, max: 50000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 585.60, positivo1: 644.16, positivoDopo1: 732.00 },
                    { min: 50000.01, max: 150000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 1005.28, positivo1: 1105.81, positivoDopo1: 1256.60 },
                    { min: 150000.01, max: 250000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 1298.08, positivo1: 1427.89, positivoDopo1: 1622.60 },
                    { min: 250000.01, max: 500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 2274.08, positivo1: 2501.49, positivoDopo1: 2842.60 },
                    { min: 500000.01, max: 1500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 3640.48, positivo1: 4004.53, positivoDopo1: 4550.60 },
                    { min: 1500000.01, max: 2500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 4323.68, positivo1: 4756.05, positivoDopo1: 5404.60 },
                    { min: 2500000.01, max: 5000000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 6178.08, positivo1: 6795.89, positivoDopo1: 7722.60 },
                    { 
                    min: 5000000.01, max: Infinity, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, formula: true, 
                    formulaNegativo: (v) => (((0.002 * v) - 170) * 0.8 * 1.22), 
                    formulaPositivo1: (v) => (((0.002 * v) - 170) * 0.8 * 1.1 * 1.22), 
                    formulaPositivoDopo1: (v) => (((0.002 * v) - 170) * 0.8 * 1.25 * 1.22), 
                    },
                    { 
                        min: Infinity, max: Infinity, 
                        // VALORI AGGIORNATI DA DOCX - OBBLIGATORIE MINIMI
                        speseFisseAlto: 273.28, speseAvvioAlto: 107.36, indennitaPrimoIncontroAlto: 165.92,
                        speseFisseMedio: 224.48, speseAvvioMedio: 73.20, indennitaPrimoIncontroMedio: 151.28, 
                        speseFisseBasso: 165.92, speseAvvioBasso: 73.20, indennitaPrimoIncontroBasso: 92.72, 
                        negativoAlto: 1005.28, negativoMedio: 1054.08, negativoBasso: 1112.64,
                        positivo1Alto: 1105.81, positivo1Medio: 1159.49, positivo1Basso: 1223.90,
                        positivoDopo1Alto: 1256.60, positivoDopo1Medio: 1317.60, positivoDopo1Basso: 1390.80,
                        indeterminabile: true 
                    },
                ],
                volontarie: [
                    { min: 0, max: 1000, speseFisse: 122.00, speseAvvio: 48.80, indennitaPrimoIncontro: 73.20, negativo: 24.40, positivo1: 26.84, positivoDopo1: 30.50 },
                    { min: 1000.01, max: 5000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 48.80, positivo1: 53.68, positivoDopo1: 61.00 },
                    { min: 5000.01, max: 10000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 207.40, positivo1: 228.14, positivoDopo1: 259.25 },
                    { min: 10000.01, max: 25000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 390.40, positivo1: 429.44, positivoDopo1: 488.00 },
                    { min: 25000.01, max: 50000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 732.00, positivo1: 805.20, positivoDopo1: 915.00 },
                    { min: 50000.01, max: 150000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 1256.60, positivo1: 1382.26, positivoDopo1: 1570.75 },
                    { min: 150000.01, max: 250000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 1622.60, positivo1: 1784.86, positivoDopo1: 2028.25 },
                    { min: 250000.01, max: 500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 2842.60, positivo1: 3126.86, positivoDopo1: 3553.25 },
                    { min: 500000.01, max: 1500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 4550.60, positivo1: 5005.66, positivoDopo1: 5688.25 },
                    { min: 1500000.01, max: 2500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 5404.60, positivo1: 5945.06, positivoDopo1: 6755.75 },
                    { min: 2500000.01, max: 5000000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 7722.60, positivo1: 8494.86, positivoDopo1: 9653.25 },
                    { 
                    min: 5000000.01, max: Infinity, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, formula: true, 
                    formulaNegativo: (v) => ((0.002 * v) - 170) * 1.22, 
                    formulaPositivo1: (v) => ((0.002 * v) - 170) * 1.1 * 1.22, 
                    formulaPositivoDopo1: (v) => ((0.002 * v) - 170) * 1.25 * 1.22, 
                    },
                    { 
                        min: Infinity, max: Infinity, 
                        // VALORI AGGIORNATI DA DOCX - VOLONTARIE MINIMI
                        speseFisseAlto: 341.60, speseAvvioAlto: 134.20, indennitaPrimoIncontroAlto: 207.40,
                        speseFisseMedio: 280.60, speseAvvioMedio: 91.50, indennitaPrimoIncontroMedio: 189.10, 
                        speseFisseBasso: 207.40, speseAvvioBasso: 91.50, indennitaPrimoIncontroBasso: 115.90, 
                        negativoAlto: 1439.60, negativoMedio: 1500.60, negativoBasso: 1573.80, 
                        positivo1Alto: 1583.56, positivo1Medio: 1650.66, positivo1Basso: 1731.18, 
                        positivoDopo1Alto: 1799.50, positivoDopo1Medio: 1875.75, positivoDopo1Basso: 1967.25, 
                        indeterminabile: true 
                    },
                ],
            },
            medi: {
                obbligatorie: [
                    { min: 0, max: 1000, speseFisse: 97.60, speseAvvio: 39.04, indennitaPrimoIncontro: 58.56, negativo: 58.56, positivo1: 64.42, positivoDopo1: 73.20 },
                    { min: 1000.01, max: 5000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 102.48, positivo1: 112.73, positivoDopo1: 128.10 },
                    { min: 5000.01, max: 10000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 239.12, positivo1: 263.03, positivoDopo1: 298.90 },
                    { min: 10000.01, max: 25000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 448.96, positivo1: 493.86, positivoDopo1: 561.20 },
                    { min: 25000.01, max: 50000, speseFisse: 190.32, speseAvvio: 73.20, indennitaPrimoIncontro: 117.12, negativo: 819.84, positivo1: 901.82, positivoDopo1: 1024.80 },
                    { min: 50000.01, max: 150000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 1151.68, positivo1: 1266.85, positivoDopo1: 1439.60 },
                    { min: 150000.01, max: 250000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 1786.08, positivo1: 1964.69, positivoDopo1: 2232.60 },
                    { min: 250000.01, max: 500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 2957.28, positivo1: 3253.01, positivoDopo1: 3696.60 }, 
                    { min: 500000.01, max: 1500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 3982.08, positivo1: 4380.29, positivoDopo1: 4977.60 },
                    { min: 1500000.01, max: 2500000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 5250.88, positivo1: 5775.97, positivoDopo1: 6563.60 },
                    { min: 2500000.01, max: 5000000, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, negativo: 7886.08, positivo1: 8674.69, positivoDopo1: 9857.60 },
                    { 
                    min: 5000000.01, max: Infinity, speseFisse: 273.28, speseAvvio: 107.36, indennitaPrimoIncontro: 165.92, formula: true, 
                    formulaNegativo: (v) => ((0.002 * v) - 170) * 0.8 * 1.22, 
                    formulaPositivo1: (v) => ((0.002 * v) - 170) * 0.8 * 1.1 * 1.22, 
                    formulaPositivoDopo1: (v) => ((0.002 * v) - 170) * 0.8 * 1.25 * 1.22, 
                    },
                    { 
                        min: Infinity, max: Infinity, 
                        // VALORI AGGIORNATI DA DOCX - OBBLIGATORIE MEDI
                        speseFisseAlto: 273.28, speseAvvioAlto: 107.36, indennitaPrimoIncontroAlto: 165.92,
                        speseFisseMedio: 224.48, speseAvvioMedio: 73.20, indennitaPrimoIncontroMedio: 151.28, 
                        speseFisseBasso: 165.92, speseAvvioBasso: 73.20, indennitaPrimoIncontroBasso: 92.72, 
                        negativoAlto: 1151.68, negativoMedio: 1200.48, negativoBasso: 1259.04, 
                        positivo1Alto: 1266.85, positivo1Medio: 1320.53, positivo1Basso: 1384.94, 
                        positivoDopo1Alto: 1439.60, positivoDopo1Medio: 1500.60, positivoDopo1Basso: 1573.80, 
                        indeterminabile: true 
                    },
                ],
                volontarie: [
                    { min: 0, max: 1000, speseFisse: 122.00, speseAvvio: 48.80, indennitaPrimoIncontro: 73.20, negativo: 73.20, positivo1: 80.52, positivoDopo1: 91.50 },
                    { min: 1000.01, max: 5000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 128.10, positivo1: 140.91, positivoDopo1: 160.13 },
                    { min: 5000.01, max: 10000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 298.90, positivo1: 328.79, positivoDopo1: 373.63 },
                    { min: 10000.01, max: 25000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 561.20, positivo1: 617.32, positivoDopo1: 701.50 },
                    { min: 25000.01, max: 50000, speseFisse: 237.90, speseAvvio: 91.50, indennitaPrimoIncontro: 146.40, negativo: 1024.80, positivo1: 1127.28, positivoDopo1: 1281.00 },
                    { min: 50000.01, max: 150000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 1439.60, positivo1: 1583.56, positivoDopo1: 1799.50 },
                    { min: 150000.01, max: 250000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 2232.60, positivo1: 2455.86, positivoDopo1: 2790.75 },
                    { min: 250000.01, max: 500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 3696.60, positivo1: 4066.26, positivoDopo1: 4620.75 },
                    { min: 500000.01, max: 1500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 4977.60, positivo1: 5475.36, positivoDopo1: 6222.00 },
                    { min: 1500000.01, max: 2500000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 6563.60, positivo1: 7219.96, positivoDopo1: 8204.50 },
                    { min: 2500000.01, max: 5000000, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, negativo: 9857.60, positivo1: 10843.36, positivoDopo1: 12322.00 },
                    { 
                    min: 5000000.01, max: Infinity, speseFisse: 341.60, speseAvvio: 134.20, indennitaPrimoIncontro: 207.40, formula: true, 
                    formulaNegativo: (v) => ((0.002 * v) - 170) * 1.22, 
                    formulaPositivo1: (v) => ((0.002 * v) - 170) * 1.1 * 1.22, 
                    formulaPositivoDopo1: (v) => ((0.002 * v) - 170) * 1.25 * 1.22, 
                    },
                    { 
                        min: Infinity, max: Infinity, 
                        // VALORI AGGIORNATI DA DOCX - VOLONTARIE MEDI
                        speseFisseAlto: 341.60, speseAvvioAlto: 134.20, indennitaPrimoIncontroAlto: 207.40,
                        speseFisseMedio: 280.60, speseAvvioMedio: 91.50, indennitaPrimoIncontroMedio: 189.10, 
                        speseFisseBasso: 207.40, speseAvvioBasso: 91.50, indennitaPrimoIncontroBasso: 115.90, 
                        negativoAlto: 1439.60, negativoMedio: 1500.60, negativoBasso: 1573.80, 
                        positivo1Alto: 1583.56, positivo1Medio: 1650.66, positivo1Basso: 1731.18, 
                        positivoDopo1Alto: 1799.50, positivoDopo1Medio: 1875.75, positivoDopo1Basso: 1967.25, 
                        indeterminabile: true 
                    },
                ],
            },
        };

        const IVA_RATE_FACTOR = 1.22; 

        window.calculateMediationFees = function () { // Funzione esposta globalmente
            const litigationTypeInput = document.getElementById('litigation-value-type');
            const mediationLitigationInput = document.getElementById('mediation-litigation-value');
            const forensicLitigationInput = document.getElementById('forensic-litigation-value');
            const mediationTypeInput = document.getElementById('mediation-type');
            const tariffLevelInput = document.getElementById('mediation-tariff-level');
            const tariffTitleEl = document.getElementById('tariff-title');
            
            const indeterminateLevel = document.querySelector('input[name="indeterminato-level"]:checked')?.value || 'medio';
            
            const isIndeterminabileSelection = litigationTypeInput.value === 'indeterminabile';
            // Il valore da usare per il calcolo sarà 'indeterminabile' o il valore numerico
            const valueStr = isIndeterminabileSelection ? 'indeterminabile' : mediationLitigationInput.value.toLowerCase().trim();
            // MODIFICATO: accetta la virgola come separatore decimale
            const value = isIndeterminabileSelection ? 0 : parseFloat(valueStr.replace(',', '.'));
            
            const mediationType = mediationTypeInput.value;
            const tariffLevel = tariffLevelInput.value;
            const isIndeterminabile = isIndeterminabileSelection; // Usa la selezione del tipo

            // --- LOGICA DI VISIBILITÀ MODULAZIONE INDETERMINATO ---
            const indeterminateOptionsBox = document.getElementById('indeterminate-value-options');
            if (indeterminateOptionsBox) {
                if (isIndeterminabile) {
                    indeterminateOptionsBox.classList.remove('hidden');
                } else {
                    indeterminateOptionsBox.classList.add('hidden');
                }
            }


            // --- LOGICA DI SINCRONIZZAZIONE (Avvocato) ---
            if (forensicLitigationInput) {
                if (isIndeterminabile) {
                    // L'app Avvocato non supporta il calcolo con valore indeterminabile
                    forensicLitigationInput.value = 'indeterminabile'; 
                } else if (!isNaN(value) && value >= 0) {
                    // Sincronizza il valore numerico (rimette la virgola per visualizzazione)
                    forensicLitigationInput.value = mediationLitigationInput.value; 
                } else {
                    // Campo vuoto
                    forensicLitigationInput.value = ''; 
                }
                
                if (typeof window.calculateForensicFees === 'function') {
                    window.calculateForensicFees();
                }
            }

            // --- NUOVA LOGICA: COLLEGAMENTO INDETERMINATO MEDIAZIONE -> AVVOCATO (SOLO SELEZIONE) ---
            // Collega i pulsanti Basso/Medio/Alto della Mediazione a quelli dell'Avvocato,
            // come richiesto, senza toccare le tabelle di calcolo sottostanti.
            
            if (isIndeterminabileSelection) {
                // Mediazione è INDETERMINABILE: Seleziona il pulsante Avvocato corrispondente.
                let targetButton = null;
                let targetTier = null;

                if (indeterminateLevel === 'basso') {
                    targetButton = document.getElementById('forensic-ind-bassa-btn');
                    targetTier = 'bassa';
                } else if (indeterminateLevel === 'medio') {
                    targetButton = document.getElementById('forensic-ind-media-btn');
                    targetTier = 'media';
                } else if (indeterminateLevel === 'alto') {
                    targetButton = document.getElementById('forensic-ind-alta-btn');
                    targetTier = 'alta';
                }

                // Seleziona il pulsante target (se esiste e non è già selezionato)
                // NON selezioniamo nulla se l'utente ha scelto "particolare importanza" (non deve essere sovrascritto)
                if (targetButton && currentForensicIndeterminateTier !== targetTier && currentForensicIndeterminateTier !== 'importante') {
                    // Chiamiamo la funzione che gestisce la selezione dell'avvocato.
                    // Questo aggiornerà l'UI (pulsante e input disabilitato) e 
                    // attiverà il ricalcolo dell'avvocato usando la tabella indeterminabile corretta.
                    window.selectForensicIndeterminate(targetButton, targetTier);
                }
                
            } else {
                // Mediazione è DETERMINABILE: Deseleziona il pulsante Avvocato (se non è 'importante').
                
                // Se un pulsante (basso, medio, alto) è correntemente selezionato...
                if (currentForensicIndeterminateTier === 'bassa' || currentForensicIndeterminateTier === 'medio' || currentForensicIndeterminateTier === 'alta') {
                    
                    // Troviamo il pulsante attualmente selezionato
                    const currentButton = document.querySelector(`.forensic-ind-button[data-tier="${currentForensicIndeterminateTier}"]`);
                    
                    if (currentButton) {
                        // Chiamiamo la funzione di deselezione (cliccando su se stesso)
                        // Questo riattiverà l'input del valore e ricalcolerà l'avvocato
                        // usando il valore numerico sincronizzato.
                        window.selectForensicIndeterminate(currentButton, currentForensicIndeterminateTier);
                    }
                }
                // Se è 'importante' o 'null' (già deselezionato), non facciamo nulla.
            }
            // --- FINE NUOVA LOGICA ---


            // === LOGICA BLINK (Corretta per gestire il rimpiazzo del titolo) ===
            // Usa il Navy originale per il testo del titolo
            const originalTitleHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6 text-accent-mediation-navy"><path d="M12 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h7"/><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg> Spese di Mediazione - Valori Minimi`;
            
            // TITOLO VALORI MEDI: colore coerente con il nuovo tema
            const mediumTitleColorClass = 'text-accent-mediation-navy'; // Navy

            const mediumTitleHTML = `<span class="flex items-center ${mediumTitleColorClass}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-6 w-6">
                          <path d="M12 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h7"/><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/>
                        </svg> 
                        Spese di Mediazione - Valori Medi
                      </span>`;

            if (tariffLevel === 'medi') {
                // Rimuovi l'animazione di blink per un look più formale
                tariffTitleEl.innerHTML = mediumTitleHTML; 
                // Aggiungo la classe di colore se tolgo l'animazione di blink che prima faceva il colore
                tariffTitleEl.classList.add(mediumTitleColorClass);
                
            } else {
                tariffTitleEl.innerHTML = originalTitleHTML;
                tariffTitleEl.classList.remove(mediumTitleColorClass); // Rimuove se presente
            }
            

            const selectedLevelTariffs = MEDIATION_TARIFFS_FULL[tariffLevel];
            
            // HO RIMOSSO L'ISTUZIONE console.error NON NECESSARIA QUI

            // Se la tariffa selezionata non è valida (es. valore non numerico o fuori scaglione), resettiamo i calcoli
            if (!selectedLevelTariffs) {
                 // Non fare nulla se il livello non è trovato (dovrebbe essere sempre trovato data la struttura)
                 // Se i dati dell'input sono validi ma non rientrano negli scaglioni, la logica di fallback è sotto.
                 console.error(`Tariff level ${tariffLevel} is not defined in MEDIATION_TARIFFS_FULL.`);
                 return;
            }
            

            const selectedTariffs = selectedLevelTariffs[mediationType];
            let foundTariff = null;
            
            // Determina il moltiplicatore (NON PIÙ USATO per Indennità, ma mantenuto per compatibilità)
            const multiplier = isIndeterminabile ? INDETERMINATE_MULTIPLIERS[indeterminateLevel] : 1.0;


            const alertEl = document.getElementById('mediation-alert');
            const mediationPrintValueEl = document.getElementById('mediation-print-value'); 
            
            const typeText = litigationTypeInput.options[litigationTypeInput.selectedIndex].text; // Corretto per evitare errore 
            const levelText = tariffLevelInput.options[tariffLevelInput.selectedIndex].text;
            
            let printValueText = `Valore Lite: ${isIndeterminabile ? 'Indeterminabile' : (valueStr === '' ? 'Non specificato' : formatCurrency(value))}`;
            if (isIndeterminabile) {
                printValueText = `Valore Lite: Indeterminabile (Modulazione: ${indeterminateLevel.toUpperCase()})`;
            }
            
            printValueText += ` | Tipo: ${typeText} | Livello: ${levelText}`;
            mediationPrintValueEl.innerHTML = `<p class="font-bold print-litigation-value border-b border-gray-300 pb-2">${printValueText}</p>`;
            
            
            const feesStartupEl = document.getElementById('fees-startup');
            const feesStartupImponibileEl = document.getElementById('fees-startup-imponibile');
            const feesStartupIvaEl = document.getElementById('fees-startup-iva'); 
            const feesStartupBreakdownAvvioEl = document.getElementById('fees-startup-breakdown-avvio');
            const feesStartupBreakdownIndennitaEl = document.getElementById('fees-startup-breakdown-indennita');
            const feesStartupBreakdownAvvioImponibileEl = document.getElementById('fees-startup-breakdown-avvio-imponibile');
            const feesStartupBreakdownAvvioIvaEl = document.getElementById('fees-startup-breakdown-avvio-iva');
            const feesStartupBreakdownIndennitaImponibileEl = document.getElementById('fees-startup-breakdown-indennita-imponibile');
            const feesStartupBreakdownIndennitaIvaEl = document.getElementById('fees-startup-breakdown-indennita-iva');
            const feesNegativeEl = document.getElementById('fees-negative');
            const feesNegativeImponibileEl = document.getElementById('fees-negative-imponibile');
            const feesNegativeIvaEl = document.getElementById('fees-negative-iva'); 
            const feesPositive1El = document.getElementById('fees-positive-1');
            const feesPositive1ImponibileEl = document.getElementById('fees-positive-1-imponibile');
            const feesPositive1IvaEl = document.getElementById('fees-positive-1-iva'); 
            const feesPositiveAfter1El = document.getElementById('fees-positive-after-1');
            const feesPositiveAfter1ImponibileEl = document.getElementById('fees-positive-after-1-imponibile');
            const feesPositiveAfter1IvaEl = document.getElementById('fees-positive-after-1-iva'); 
            
            const totalStartupEl = document.getElementById('total-startup');
            const totalStartupImponibileEl = document.getElementById('total-startup-imponibile');
            const totalStartupIvaEl = document.getElementById('total-startup-iva');

            const totalNegativeEl = document.getElementById('total-negative');
            const totalNegativeImponibileEl = document.getElementById('total-negative-imponibile');
            const totalNegativeIvaEl = document.getElementById('total-negative-iva');

            const totalPositive1El = document.getElementById('total-positive-1');
            const totalPositive1ImponibileEl = document.getElementById('total-positive-1-imponibile');
            const totalPositive1IvaEl = document.getElementById('total-positive-1-iva');

            const totalPositiveAfter1El = document.getElementById('total-positive-after-1');
            const totalPositiveAfter1ImponibileEl = document.getElementById('total-positive-after-1-imponibile');
            const totalPositiveAfter1IvaEl = document.getElementById('total-positive-after-1-iva');


            alertEl.classList.add('hidden');
            let startUpFees = 0;
            let breakdownAvvio = 0;
            let breakdownIndennita = 0;
            let negativeOutcomeFees = 0;
            let positive1Fees = 0;
            let positiveAfter1Fees = 0;

            if (isIndeterminabile) {
                foundTariff = selectedTariffs.find(t => t.indeterminabile);
                if (foundTariff) {
                    // Logica specifica per Indeterminabile (Valori fissi forniti dall'utente)
                    if (indeterminateLevel === 'alto') {
                        startUpFees = foundTariff.speseFisseAlto;
                        breakdownAvvio = foundTariff.speseAvvioAlto;
                        breakdownIndennita = foundTariff.indennitaPrimoIncontroAlto;
                        negativeOutcomeFees = foundTariff.negativoAlto;
                        positive1Fees = foundTariff.positivo1Alto;
                        positiveAfter1Fees = foundTariff.positivoDopo1Alto;
                    } else if (indeterminateLevel === 'medio') {
                        startUpFees = foundTariff.speseFisseMedio;
                        breakdownAvvio = foundTariff.speseAvvioMedio;
                        breakdownIndennita = foundTariff.indennitaPrimoIncontroMedio;
                        negativeOutcomeFees = foundTariff.negativoMedio;
                        positive1Fees = foundTariff.positivo1Medio;
                        positiveAfter1Fees = foundTariff.positivoDopo1Medio;
                    } else {
                         // Fallback al Basso
                         startUpFees = foundTariff.speseFisseBasso;
                         breakdownAvvio = foundTariff.speseAvvioBasso;
                         breakdownIndennita = foundTariff.indennitaPrimoIncontroBasso;
                         negativeOutcomeFees = foundTariff.negativoBasso;
                         positive1Fees = foundTariff.positivo1Basso;
                         positiveAfter1Fees = foundTariff.positivoDopo1Basso;
                    }

                    let message = `Attenzione: Valore Indeterminabile. Applicata tariffa massima del quinto scaglione (fino a 150.000 €).`;
                    if (indeterminateLevel) {
                        message += ` Modulazione: ${indeterminateLevel.toUpperCase()}.`;
                    }
                    alertEl.innerHTML = message;
                    alertEl.classList.remove('hidden');
                }
            } else if (!isNaN(value) && value >= 0) {
                for (const tariff of selectedTariffs) {
                    if (value >= tariff.min && value <= tariff.max) {
                        foundTariff = tariff;
                        break;
                    }
                }
            } else if (!isIndeterminabile && valueStr !== '') {
                 alertEl.innerHTML = `Valore della lite non valido o non rientrante negli scaglioni previsti.`;
                 alertEl.classList.remove('hidden');
                 startUpFees = negativeOutcomeFees = positive1Fees = positiveAfter1Fees = 0;
                 breakdownAvvio = 0; breakdownIndennita = 0;
            } else if (valueStr === '') {
                 startUpFees = negativeOutcomeFees = positive1Fees = positiveAfter1Fees = 0;
                 breakdownAvvio = 0; breakdownIndennita = 0;
            }

            if (foundTariff && !foundTariff.indeterminabile) { // Se è determinabile o formula
                startUpFees = foundTariff.speseFisse; 
                breakdownAvvio = foundTariff.speseAvvio;
                breakdownIndennita = foundTariff.indennitaPrimoIncontro;
                
                if (foundTariff.formula) {
                    negativeOutcomeFees = foundTariff.formulaNegativo(value);
                    positive1Fees = foundTariff.formulaPositivo1(value);
                    positiveAfter1Fees = foundTariff.formulaPositivoDopo1(value);
                    alertEl.innerHTML = `Attenzione: Valore superiore a 5.000.000,00 € - Applicata tariffa con formula.`;
                    alertEl.classList.remove('hidden');
                } else {
                    negativeOutcomeFees = foundTariff.negativo;
                    positive1Fees = foundTariff.positivo1;
                    positiveAfter1Fees = foundTariff.positivoDopo1;
                }
            }
            
            // --- CALCOLI BREAKDOWN STARTUP ---
            // N.B.: Le Spese Fisse Indeterminabili sono date dal risultato (Avvio + Indennità Primo Incontro)
            // e quindi la scomposizione DEVE usare i valori Avvio e Indennità separati.
            
            // Calcolo IVA su Spese Fisse (Avvio + Indennità)
            const startupImponibile = breakdownAvvio / IVA_RATE_FACTOR + breakdownIndennita / IVA_RATE_FACTOR;
            const startupIVA = startUpFees - startupImponibile;
            
            // Calcolo Breakdown Avvio
            const breakdownAvvioImponibile = breakdownAvvio / IVA_RATE_FACTOR;
            const breakdownAvvioIVA = breakdownAvvio - breakdownAvvioImponibile;
            
            // Calcolo Breakdown Indennità 1° Incontro
            const breakdownIndennitaImponibile = breakdownIndennita / IVA_RATE_FACTOR;
            const breakdownIndennitaIVA = breakdownIndennita - breakdownIndennitaImponibile;
            
            // --- CALCOLI INDENNITÀ (Negativo/Positivo) ---
            const negativeImponibile = negativeOutcomeFees / IVA_RATE_FACTOR;
            const negativeIVA = negativeOutcomeFees - negativeImponibile;
            
            const positive1Imponibile = positive1Fees / IVA_RATE_FACTOR;
            const positive1IVA = positive1Fees - positive1Imponibile;
            
            const positiveAfter1Imponibile = positiveAfter1Fees / IVA_RATE_FACTOR;
            const positiveAfter1IVA = positiveAfter1Fees - positiveAfter1Imponibile;


            feesStartupEl.textContent = formatCurrency(startUpFees);
            if (feesStartupBreakdownAvvioEl && feesStartupBreakdownIndennitaEl) {
                feesStartupBreakdownAvvioEl.textContent = formatCurrency(breakdownAvvio);
                feesStartupBreakdownIndennitaEl.textContent = formatCurrency(breakdownIndennita);
                if (feesStartupBreakdownAvvioImponibileEl) feesStartupBreakdownAvvioImponibileEl.textContent = formatCurrency(breakdownAvvioImponibile);
                // Corretto errore di sintassi qui
                if (feesStartupBreakdownAvvioIvaEl) feesStartupBreakdownAvvioIvaEl.textContent = formatCurrency(breakdownAvvioIVA);
                if (feesStartupBreakdownIndennitaImponibileEl) feesStartupBreakdownIndennitaImponibileEl.textContent = formatCurrency(breakdownIndennitaImponibile);
                if (feesStartupBreakdownIndennitaIvaEl) feesStartupBreakdownIndennitaIvaEl.textContent = formatCurrency(breakdownIndennitaIVA);
            }
            feesNegativeEl.textContent = formatCurrency(negativeOutcomeFees);
            feesPositive1El.textContent = formatCurrency(positive1Fees);
            feesPositiveAfter1El.textContent = formatCurrency(positiveAfter1Fees);
            
            feesStartupImponibileEl.textContent = formatCurrency(startupImponibile);
            feesStartupIvaEl.textContent = formatCurrency(startupIVA);

            feesNegativeImponibileEl.textContent = formatCurrency(negativeImponibile);
            feesNegativeIvaEl.textContent = formatCurrency(negativeIVA);

            feesPositive1ImponibileEl.textContent = formatCurrency(positive1Imponibile);
            feesPositive1IvaEl.textContent = formatCurrency(positive1IVA);

            feesPositiveAfter1ImponibileEl.textContent = formatCurrency(positiveAfter1Imponibile);
            feesPositiveAfter1IvaEl.textContent = formatCurrency(positiveAfter1IVA);


            // --- AGGIORNAMENTO RIEPILOGO TOTALE ---
            // La logica di calcolo del Totale non viene modificata
            
            const totalStartup = startUpFees; 
            const totalStartupImponibileTotal = totalStartup / IVA_RATE_FACTOR;
            const totalStartupIVATotal = totalStartup - totalStartupImponibileTotal;
            
            const totalNegative = startUpFees + negativeOutcomeFees;
            const totalNegativeImponibile = totalNegative / IVA_RATE_FACTOR;
            const totalNegativeIVA = totalNegative - totalNegativeImponibile;

            const totalPositive1 = startUpFees + positive1Fees;
            const totalPositive1Imponibile = totalPositive1 / IVA_RATE_FACTOR;
            const totalPositive1IVA = totalPositive1 - totalPositive1Imponibile;

            const totalPositiveAfter1 = startUpFees + positiveAfter1Fees;
            const totalPositiveAfter1Imponibile = totalPositiveAfter1 / IVA_RATE_FACTOR;
            const totalPositiveAfter1IVA = totalPositiveAfter1 - totalPositiveAfter1Imponibile;


            totalStartupEl.textContent = formatCurrency(totalStartup);
            totalStartupImponibileEl.textContent = formatCurrency(totalStartupImponibileTotal);
            totalStartupIvaEl.textContent = formatCurrency(totalStartupIVATotal);

            totalNegativeEl.textContent = formatCurrency(totalNegative);
            totalNegativeImponibileEl.textContent = formatCurrency(totalNegativeImponibile);
            totalNegativeIvaEl.textContent = formatCurrency(totalNegativeIVA);

            totalPositive1El.textContent = formatCurrency(totalPositive1);
            totalPositive1ImponibileEl.textContent = formatCurrency(totalPositive1Imponibile);
            totalPositive1IvaEl.textContent = formatCurrency(totalPositive1IVA);

            totalPositiveAfter1El.textContent = formatCurrency(totalPositiveAfter1);
            totalPositiveAfter1ImponibileEl.textContent = formatCurrency(totalPositiveAfter1Imponibile);
            totalPositiveAfter1IvaEl.textContent = formatCurrency(totalPositiveAfter1IVA);

        };


        // =========================================================================
        // --- LOGICA APP 2: CALCOLATORE COMPENSI AVVOCATO (DM 55/2014) ---
        // =========================================================================
        
        // TABELLA COMPENSI DETTAGLIATA PER MEDIAZIONE (DM 55/2014)
        const FORENSIC_FEE_TABLE = [
            // Fase di Mediazione (Tabelle 1, 2 e 3 del DM 55/2014)
            // Aggiornata con i valori medi da file Valore.docx e min/max calcolati (50%/150%)
            { min: 0, max: 1100,
                activation: { min: 31.50, medium: 63.00, max: 94.50 },
                negotiation: { min: 63.00, medium: 126.00, max: 189.00 },
                conciliation: { min: 123.00, medium: 246.00, max: 369.00 }
            },
            { min: 1100.01, max: 5200,
                activation: { min: 142.00, medium: 284.00, max: 426.00 },
                negotiation: { min: 283.50, medium: 567.00, max: 850.50 },
                conciliation: { min: 553.00, medium: 1106.00, max: 1659.00 }
            },
            { min: 5200.01, max: 26000,
                activation: { min: 220.50, medium: 441.00, max: 661.50 },
                negotiation: { min: 441.00, medium: 882.00, max: 1323.00 },
                conciliation: { min: 860.00, medium: 1720.00, max: 2580.00 }
            },
            { min: 26000.01, max: 52000,
                activation: { min: 268.00, medium: 536.00, max: 804.00 },
                negotiation: { min: 535.50, medium: 1071.00, max: 1606.50 },
                conciliation: { min: 1044.00, medium: 2088.00, max: 3132.00 }
            },
            { min: 52000.01, max: 260000,
                activation: { min: 504.00, medium: 1008.00, max: 1512.00 },
                negotiation: { min: 1008.00, medium: 2016.00, max: 3024.00 },
                conciliation: { min: 1965.50, medium: 3931.00, max: 5896.50 }
            },
            { min: 260000.01, max: 520000,
                activation: { min: 685.00, medium: 1370.00, max: 2055.00 },
                negotiation: { min: 1370.50, medium: 2741.00, max: 4111.50 },
                conciliation: { min: 2671.50, medium: 5343.00, max: 8014.50 }
            },
            // Nuovi scaglioni dal file (valori medi dal file, min/max calcolati)
            { min: 520000.01, max: 1000000,
                activation: { min: 890.50, medium: 1781.00, max: 2671.50 },
                negotiation: { min: 1781.65, medium: 3563.30, max: 5344.95 },
                conciliation: { min: 3472.95, medium: 6945.90, max: 10418.85 }
            },
            { min: 1000000.01, max: 2000000,
                activation: { min: 1157.65, medium: 2315.30, max: 3472.95 },
                negotiation: { min: 2316.15, medium: 4632.29, max: 6948.44 },
                conciliation: { min: 4514.84, medium: 9029.67, max: 13544.51 }
            },
            { min: 2000000.01, max: 4000000,
                activation: { min: 1504.95, medium: 3009.89, max: 4514.84 },
                negotiation: { min: 3010.99, medium: 6021.98, max: 9032.97 },
                conciliation: { min: 5869.29, medium: 11738.57, max: 17607.86 }
            },
            { min: 4000000.01, max: 8000000,
                activation: { min: 1956.43, medium: 3912.86, max: 5869.29 },
                negotiation: { min: 3914.29, medium: 7828.57, max: 11742.86 },
                conciliation: { min: 7625.07, medium: 15250.14, max: 22875.21 }
            },
            { min: 8000000.01, max: Infinity,
                activation: { min: 2543.36, medium: 5086.72, max: 7630.08 },
                negotiation: { min: 5088.57, medium: 10177.14, max: 15265.71 },
                conciliation: { min: 9912.59, medium: 19825.18, max: 29737.77 }
            }
        ];
        
        const FORENSIC_STATUTORY_COSTS = {
            forfeit: 0.15, // Spese forfettarie 15%
            cassa: 0.04,    // Contributo Cassa 4%
            iva: 0.22,      // IVA 22%
            increase: 0.30, // Maggiorazione 30% per esito positivo
        };

        /**
         * Funzione per selezionare un livello di compenso cliccando sul valore.
         */
        window.selectForensicFee = (phaseName, level) => { 
            // Aggiorna il radio button nascosto
            const radioId = `${phaseName.substring(0, 3)}-${level.substring(0, 3)}`;
            const radioElement = document.getElementById(radioId);
            
            // Assicurati che l'elemento radio esista prima di modificarlo
            if (radioElement) {
                radioElement.checked = true; 
                
                // Rimuovi l'highlight da tutti i fratelli
                const parentBox = document.getElementById(`phase-${phaseName}-box`);
                parentBox.querySelectorAll('.fee-display-item').forEach(item => {
                    item.classList.remove('highlighted-fee');
                });
                
                // Aggiungi l'highlight a quello selezionato (basandoti sul display-id)
                const selectedDisplayId = `${phaseName.substring(0, 3)}-display-${level}`;
                const selectedElement = document.getElementById(selectedDisplayId);
                if (selectedElement) {
                    selectedElement.classList.add('highlighted-fee');
                }
                
                calculateForensicFees(); // Ricalcola i totali
            }
        }

        /**
         * Trova la fascia di compenso base per il valore della lite dato.
         */
        const getForensicFeeTier = (value) => {
            return FORENSIC_FEE_TABLE.find(tier => value >= tier.min && value <= tier.max) || null;
        }

        /**
         * Aggiorna tutti e tre i valori di compenso e ne evidenzia uno.
         */
        const updatePhaseDisplay = (phaseName, phaseFees, selectedLevel) => {
            const prefix = phaseName.substring(0, 3); 
            const levels = ['min', 'medium', 'max'];

            levels.forEach(level => {
                const displayId = `${prefix}-display-${level}`;
                const displayElement = document.getElementById(displayId);
                
                if (displayElement) {
                    // Rimuovi l'highlight da tutti
                    displayElement.classList.remove('highlighted-fee');

                    // Aggiorna il valore visualizzato
                    const valueSpan = displayElement.querySelector('.fee-value');
                    if (valueSpan) {
                        const feeKey = level === 'medium' ? 'medium' : level; // Assicurati di usare 'medium' come chiave
                        valueSpan.textContent = formatCurrency(phaseFees[feeKey]);
                    }
                }
            });

            // Applica l'highlight al valore selezionato
            const selectedDisplayId = `${prefix}-display-${selectedLevel}`;
            const selectedElement = document.getElementById(selectedDisplayId);
            if (selectedElement) {
                selectedElement.classList.add('highlighted-fee');
            }
        }


        /**
         * Calcola i compensi forensi e aggiorna l'interfaccia utente.
         */
        window.calculateForensicFees = function () { // Funzione esposta globalmente
            const valueInput = document.getElementById('forensic-litigation-value');
            const alertDiv = document.getElementById('forensic-alert'); 
            const alertMsg = document.getElementById('alert-message');
            const forensicPrintValueEl = document.getElementById('forensic-print-value');
            const taxableLabelEl = document.getElementById('forensic-taxable-label');
            const increaseRowEl = document.getElementById('forensic-total-increase-row');
            const totalIncreaseEl = document.getElementById('forensic-total-increase');

            // Variabili per i risultati del calcolo, dichiarate con 'let' all'inizio
            let totalForfeit = 0;
            let totalCassa = 0;
            let totalIVA = 0;
            let totalIncrease = 0;
            let taxableBaseForTax = 0; // Base Imponibile per IVA e Cassa (Comp. Base + Forfettarie + Maggiorazione)


            // MODIFICATO: Accetta la virgola come separatore decimale
            const valueStr = valueInput.value.toLowerCase().trim();
            const rawValue = parseValue(valueStr); // Usa parseValue
            
            // Logica per determinare se il valore è indeterminabile, nullo o numerico
            // MODIFICA: 'isIndeterminabile' ora controlla ANCHE se è stato premuto un pulsante
            const isIndeterminabileButton = currentForensicIndeterminateTier !== null;
            const isIndeterminabileInput = valueStr === 'indeterminabile' && !isIndeterminabileButton;
            const litigationValue = isIndeterminabileButton || isIndeterminabileInput || isNaN(rawValue) || rawValue < 0 ? 0 : rawValue; 
            
            let feeTier = null;

            // --- NUOVA LOGICA: CONTROLLA SE È STATO PREMUTO UN PULSANTE INDETERMINABILE ---
            if (isIndeterminabileButton) {
                feeTier = FORENSIC_INDETERMINATE_FEES[currentForensicIndeterminateTier];
            } else if (!isIndeterminabileInput) {
                // Altrimenti, cerca la fascia di compenso standard in base al valore
                feeTier = getForensicFeeTier(litigationValue);
            }
            // Se isIndeterminabileInput è true, feeTier rimane null (gestito sotto)
            
            // Variabili di livello selezionato (anche se il calcolo fallisce, manteniamo l'ultima selezione)
            const activationLevel = document.querySelector('input[name="activation-level"]:checked')?.value || 'medium';
            const negotiationLevel = document.querySelector('input[name="negotiation-level"]:checked')?.value || 'medium';
            const conciliationLevel = document.querySelector('input[name="conciliation-level"]:checked')?.value || 'medium';

            // Aggiornamento Valore Lite per la Stampa (App Avvocato)
            let printValueText = `Valore Lite: ${isIndeterminabileInput ? 'Indeterminabile (Non Calcolabile)' : (valueStr === '' ? 'Non specificato' : formatCurrency(litigationValue))}`;
            
            // NUOVA CONDIZIONE PER STAMPA PULSANTE INDETERMINABILE
            if (isIndeterminabileButton) {
                printValueText = `Valore Lite: ${currentForensicIndeterminateTierName}`;
            }

            forensicPrintValueEl.innerHTML = `<p class="font-bold print-litigation-value border-b border-gray-300 pb-2">${printValueText}</p>`;
            
            
            // Gestione Fascia non Calcolabile o Valore Vuoto o Indeterminabile
            // MODIFICA: Aggiunto !isIndeterminabileButton a questa logica
            if ((isIndeterminabileInput || !feeTier || valueInput.value.trim() === '' || litigationValue === 0) && !isIndeterminabileButton) {
                
                document.getElementById('forensic-results').classList.remove('hidden');
                alertDiv.classList.add('hidden');
                const zeroFee = formatCurrency(0);

                if (isIndeterminabileInput) {
                     // Caso Indeterminabile (non calcolabile nell'app avvocato)
                     document.getElementById('forensic-results').classList.add('hidden');
                     alertDiv.classList.remove('hidden');
                     alertMsg.textContent = `Valore della lite "Indeterminabile" non calcolabile per i compensi tabellari (DM 55/2014). Selezionare una delle opzioni "Gestione Valore Indeterminabile" qui sopra.`;
                }
                else if (litigationValue === 0 && valueStr !== '') {
                     // Caso Valore 0 (non calcolabile nell'app avvocato)
                     document.getElementById('forensic-results').classList.add('hidden');
                     alertDiv.classList.remove('hidden');
                     alertMsg.textContent = `Valore della lite pari a zero non calcolabile per i compensi tabellari (DM 55/2014). Inserire un valore numerico > 0.`;
                }
                else if (!feeTier && valueInput.value.trim() !== '') {
                    // Fuori fascia, MOSTRA l'alert
                    document.getElementById('forensic-results').classList.add('hidden');
                    alertDiv.classList.remove('hidden');
                    alertMsg.textContent = `Il valore della lite inserito (${formatCurrency(litigationValue)}) supera la fascia massima di calcolo predefinita (€${FORENSIC_FEE_TABLE[FORENSIC_FEE_TABLE.length - 1].max.toLocaleString('it-IT')}).`;
                }
                else if (valueInput.value.trim() === '') {
                    // Campo vuoto, nascondi l'alert e mostra i risultati a zero
                     document.getElementById('forensic-results').classList.remove('hidden');
                     alertDiv.classList.add('hidden');
                }
                
                // Resetta Maggiorazione e Imponibile
                increaseRowEl.classList.add('hidden');
                taxableLabelEl.textContent = `E. Imponibile IVA (A + B + C + D):`; // Etichetta di reset corretta

                // Resetta il riepilogo totale a 0,00 €
                document.getElementById('forensic-total-final-cost').textContent = zeroFee;
                document.getElementById('forensic-total-base-fee').textContent = zeroFee;
                document.getElementById('forensic-total-taxable-base').textContent = zeroFee;
                document.getElementById('forensic-total-forfeit').textContent = zeroFee;
                document.getElementById('forensic-total-cassa').textContent = zeroFee;
                document.getElementById('forensic-total-iva').textContent = zeroFee;
                if (totalIncreaseEl) totalIncreaseEl.textContent = zeroFee;


                // Reset display delle fasi (necessario per campo vuoto/0 e fuori fascia)
                const phases = ['activation', 'negotiation', 'conciliation'];
                const levels = ['min', 'medium', 'max'];
                
                phases.forEach(phaseName => {
                    const prefix = phaseName.substring(0, 3);
                    levels.forEach(level => {
                        const displayElement = document.getElementById(`${prefix}-display-${level}`);
                        if (displayElement) {
                            // Mantieni l'highlight sul livello precedentemente selezionato
                            const isSelected = (phaseName === 'activation' && level === activationLevel) ||
                                               (phaseName === 'negotiation' && level === negotiationLevel) ||
                                               (phaseName === 'conciliation' && level === conciliationLevel);
                                               
                            displayElement.classList.toggle('highlighted-fee', isSelected);

                            // Imposta il valore a 0,00 €
                            const valueSpan = displayElement.querySelector('.fee-value');
                            if (valueSpan) valueSpan.textContent = zeroFee;
                        }
                    });
                });
                
                return;
            } 
            // LOGICA DI CALCOLO NORMALE
            else {
                document.getElementById('forensic-results').classList.remove('hidden');
                alertDiv.classList.add('hidden');
            }
            
            // 2. Aggiorna l'interfaccia con tutti i valori e l'highlight
            updatePhaseDisplay('activation', feeTier.activation, activationLevel);
            updatePhaseDisplay('negotiation', feeTier.negotiation, negotiationLevel);
            updatePhaseDisplay('conciliation', feeTier.conciliation, conciliationLevel);
            
            // 3. Calcola il compenso base totale (somma dei tre valori selezionati)
            const activationFee = feeTier.activation[activationLevel];
            const negotiationFee = feeTier.negotiation[negotiationLevel];
            const conciliationFee = feeTier.conciliation[conciliationLevel];

            const totalBaseFee = activationFee + negotiationFee + conciliationFee;

            // 4. Aggiorna il display del compenso base totale
            document.getElementById('forensic-total-base-fee').textContent = formatCurrency(totalBaseFee);
            
            // =======================================================
            // 5. CALCOLI AGGIORNATI SECONDO LE TUE ISTRUZIONI
            // =======================================================

            // 5.1 Maggiorazione 30% esito positivo (B) (solo su Fase attivazione + negoziazione)
            const isIncreaseChecked = document.getElementById('cost-increase').checked;
            if (isIncreaseChecked) {
                 const increaseBase = activationFee + negotiationFee;
                 totalIncrease = increaseBase * FORENSIC_STATUTORY_COSTS.increase;
                 
                 increaseRowEl.classList.remove('hidden');
                 totalIncreaseEl.textContent = formatCurrency(totalIncrease);
            } else {
                 increaseRowEl.classList.add('hidden');
                 totalIncrease = 0;
                 totalIncreaseEl.textContent = formatCurrency(0);
            }
            
            // 5.2 Spese Forfettarie (C) (15% su A + B)
            // Base: Compenso Base (A) + Maggiorazione (B)
            const baseForForfeit = totalBaseFee + totalIncrease;
            const isForfeitChecked = document.getElementById('cost-forfeit').checked;
            if (isForfeitChecked) {
                totalForfeit = baseForForfeit * FORENSIC_STATUTORY_COSTS.forfeit;
            }
            document.getElementById('forensic-total-forfeit').textContent = formatCurrency(totalForfeit);
            
            // 5.3 Contributo Cassa (D) (4% su A + B + C)
            // Base: Compenso Base (A) + Maggiorazione (B) + Spese Forfettarie (C)
            const baseForCassa = totalBaseFee + totalIncrease + totalForfeit; 
            const isCassaChecked = document.getElementById('cost-cassa').checked;
            if (isCassaChecked) {
                totalCassa = baseForCassa * FORENSIC_STATUTORY_COSTS.cassa;
            }
            document.getElementById('forensic-total-cassa').textContent = formatCurrency(totalCassa);

            // 5.4 Base Imponibile IVA (E) = A + B + C + D
            taxableBaseForTax = totalBaseFee + totalIncrease + totalForfeit + totalCassa; 
            
            // Aggiorna il display della Base Imponibile
            document.getElementById('forensic-total-taxable-base').textContent = formatCurrency(taxableBaseForTax);

            // 5.5 IVA (F) (22% sulla Base Imponibile E)
            const isIVAChecked = document.getElementById('cost-iva').checked;
            if (isIVAChecked) {
                totalIVA = taxableBaseForTax * FORENSIC_STATUTORY_COSTS.iva;
            }
            document.getElementById('forensic-total-iva').textContent = formatCurrency(totalIVA);

            // 6. TOTALE FINALE (E + F)
            const totalFinalCost = taxableBaseForTax + totalIVA;
            document.getElementById('forensic-total-final-cost').textContent = formatCurrency(totalFinalCost);
        }

        // =========================================================================
        // --- LOGICA CALCOLATORE ART 15 C.P.C. (Integrato) ---
        // =========================================================================
        
        // Seleziona gli elementi del DOM (rinominati per evitare conflitti con gli ID originali)
        const art15_propBtn = document.getElementById('art15-prop-btn');
        const art15_usufruttoBtn = document.getElementById('art15-usufrutto-btn');
        const art15_servituBtn = document.getElementById('art15-servitu-btn');
        
        const art15_inputVal1 = document.getElementById('art15-valore1');
        const art15_inputVal2 = document.getElementById('art15-valore2');
        const art15_inputVal3 = document.getElementById('art15-valore3');
        const art15_inputVal4 = document.getElementById('art15-valore4');
        const art15_risultatoMediazioneEl = document.getElementById('art15-risultatoMediazione');
        const art15_resetButton = document.getElementById('art15-resetButton');
        
        const art15_inputs = [art15_inputVal1, art15_inputVal2, art15_inputVal3, art15_inputVal4].filter(el => el != null); // Aggiunto filter(el => el != null) per sicurezza
        const art15_multiplierButtons = [art15_propBtn, art15_usufruttoBtn, art15_servituBtn].filter(el => el != null);

        /**
         * Funzione che gestisce la selezione del pulsante Art. 15 (Card Button)
         */
        window.selectArt15Multiplier = (selectedElement, multiplier) => {
            // 1. Rimuove la classe 'selected' da tutti i pulsanti moltiplicatori
            art15_multiplierButtons.forEach(btn => {
                btn.classList.remove('selected');
            });

            // 2. Aggiunge la classe 'selected' al pulsante cliccato
            selectedElement.classList.add('selected');

            // 3. Aggiorna la variabile globale e ricalcola
            currentArt15Multiplier = multiplier;
            window.calcolaArt15Mediazione();
        };


        /**
         * Funzione per calcolare e aggiornare il valore della mediazione Art. 15.
         * COPIA AUTOMATICAMENTE il risultato nell'input principale.
         */
        window.calcolaArt15Mediazione = function () { // ESPONGO LA FUNZIONE GLOBALMENTE
            try {
                const val1 = parseValue(art15_inputVal1.value);
                const val2 = parseValue(art15_inputVal2.value);
                const val3 = parseValue(art15_inputVal3.value);
                const val4 = parseValue(art15_inputVal4.value);

                const somma = val1 + val2 + val3 + val4;
                
                // Legge il moltiplicatore dalla variabile globale
                const moltiplicatore = currentArt15Multiplier;

                const risultato = somma * moltiplicatore;
                
                // 1. FORMATTAZIONE DEL RISULTATO VISIBILE
                art15_risultatoMediazioneEl.textContent = risultato.toLocaleString('it-IT', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // 2. COPIA AUTOMATICA NELL'INPUT PRINCIPALE
                const rawValue = risultato;
                const formattedValue = rawValue.toFixed(2).replace('.', ','); // Valore formattato come stringa
                
                const mediationLitigationInput = document.getElementById('mediation-litigation-value');
                if (mediationLitigationInput) {
                     // Imposta solo se non è vuoto (altrimenti Art. 15 resetta l'input principale)
                     const allInputsEmpty = art15_inputs.every(input => input.value.trim() === '');

                     if (rawValue > 0 || !allInputsEmpty) {
                         // Se c'è un risultato > 0 o se ci sono input compilati, aggiorna
                         mediationLitigationInput.value = formattedValue;
                     } else {
                         // Se tutti gli input sono vuoti e risultato è 0, svuota il campo principale
                         mediationLitigationInput.value = '';
                     }
                     
                     // Simula l'evento input per far scattare il ricalcolo delle spese di mediazione/avvocato
                     mediationLitigationInput.dispatchEvent(new Event('input'));
                }


            } catch (error) {
                console.error("Errore durante il calcolo Art. 15:", error);
                art15_risultatoMediazioneEl.textContent = "Errore";
            }
        }

        /**
         * Funzione per resettare tutti i campi Art. 15
         */
        function resetArt15Calcolatore() {
            art15_inputs.forEach(input => {
                input.value = '';
            });
            
            // Resetta la selezione al default (Proprietà x200)
            art15_multiplierButtons.forEach(btn => btn.classList.remove('selected'));
            if (art15_propBtn) {
                 art15_propBtn.classList.add('selected');
                 currentArt15Multiplier = 200;
            }

            // Ricalcola per impostare il risultato a 0,00 e pulire l'input principale
            window.calcolaArt15Mediazione();
        }
        
        // Aggiungi event listener 'input' a tutti i campi Art. 15
        art15_inputs.forEach(input => {
            input.addEventListener('input', window.calcolaArt15Mediazione);
        });

        // Aggiungi event listener al pulsante Reset Art. 15
        if (art15_resetButton) {
            art15_resetButton.addEventListener('click', resetArt15Calcolatore);
        }
        
        // =========================================================================
        // --- INIZIALIZZAZIONE ---
        // =========================================================================

        /**
         * Inizializza l'applicazione: Calcolo Iniziale.
         */
        const initApp = async () => {
             // 1. Recupera l'input principale all'inizio per evitare ReferenceError
            const mediationLitigationInput = document.getElementById('mediation-litigation-value');

            // 2. Imposta lo stato iniziale dei radio button (Medio di default per l'app forense)
            const defaultLevel = 'medium';
            ['act', 'neg', 'con'].forEach(prefix => {
                const radioId = `${prefix}-${defaultLevel.substring(0, 3)}`;
                const radioElement = document.getElementById(radioId);
                if (radioElement) {
                    radioElement.checked = true;
                }
            });

            // 3. Imposta lo stato iniziale del livello indeterminato (Medio di default)
            const indeterminateDefaultLevel = 'medio';
            const indeterminateRadio = document.getElementById(`ind-${indeterminateDefaultLevel}`);
            if (indeterminateRadio) {
                indeterminateRadio.checked = true;
            }
            
            // 4. Popola i campi data
            populateDateFields();

            // 5. Imposta il tipo di valore lite a Determinabile di default e aggiorna l'UI
            const litigationTypeSelect = document.getElementById('litigation-value-type');
            if(litigationTypeSelect) {
                litigationTypeSelect.value = 'determinabile';
                // Chiamo updateValueInputType qui per inizializzare lo stato visivo
                window.updateValueInputType(); 
            }
            
            // 6. Imposta la selezione di default per Art. 15
            if (art15_propBtn) {
                art15_propBtn.classList.add('selected');
            }
            
            // 7. Esegue il calcolo iniziale per il nuovo calcolatore Art. 15 c.p.c. 
            // Questo ora aggiorna anche i campi principali.
            window.calcolaArt15Mediazione(); 
            
            // 8. Chiamata di fallback necessaria se Art. 15 non ha inserito un valore (es. all'avvio con tutti i campi vuoti)
            if (mediationLitigationInput && mediationLitigationInput.value === '') {
                window.calculateMediationFees();
            }
        };

        // Avvia l'app al caricamento completo della finestra
        window.onload = initApp;

    </script>
</body>
</html>






